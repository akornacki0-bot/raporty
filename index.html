<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>PR RAPORTY v26 - TEST</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { font-family: sans-serif; margin: 0; padding-top: 60px; background: #f0f0f0; }
        .toolbar { position: fixed; top: 0; width: 100%; height: 50px; background: #222; display: flex; justify-content: center; gap: 10px; align-items: center; z-index: 999; }
        .btn { padding: 8px; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .page { width: 210mm; min-height: 290mm; background: #fff; margin: 10px auto; padding: 10mm; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .plan-box { width: 100%; height: 500px; background: #ddd; position: relative; border: 2px solid #999; overflow: hidden; }
        .plan-img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
        .dot { position: absolute; width: 30px; height: 30px; background: red; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; transform: translate(-50%, -50%); cursor: pointer; z-index: 100; border: 2px solid #fff; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; width: 90%; max-width: 400px; z-index: 1001; border-radius: 10px; }
        .input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div class="toolbar">
    <button class="btn" style="background:green" onclick="addFloor()">+ PIĘTRO</button>
    <button class="btn" style="background:blue" onclick="manualSave()">ZAPISZ JSON</button>
    <button class="btn" style="background:orange" onclick="document.getElementById('file-in').click()">WCZYTAJ</button>
    <button class="btn" style="background:red" onclick="window.print()">DRUKUJ PDF</button>
</div>

<input type="file" id="file-in" style="display:none" onchange="importData(event)">
<div class="overlay" id="ov" onclick="closeM()"></div>

<div class="modal" id="mod">
    <h3 id="m-title">Edycja</h3>
    <input id="m-room" class="input" placeholder="Pomieszczenie">
    <textarea id="m-desc" class="input" placeholder="Opis usterki" style="height:80px"></textarea>
    <button class="btn" style="background:green; width:100%" onclick="saveM()">ZAPISZ PUNKT</button>
    <button class="btn" style="background:red; width:100%; margin-top:5px;" onclick="delP()">USUŃ</button>
</div>

<div id="app"></div>

<script>
    let data = { meta: {}, floors: [] };
    let active = { fi: null, di: null };

    // FUNKCJA RENDERUJĄCA
    function render() {
        const root = document.getElementById('app');
        root.innerHTML = '';
        data.floors.forEach((f, fi) => {
            const page = document.createElement('div');
            page.className = 'page';
            page.innerHTML = `
                <h3>${f.name}</h3>
                <div class="plan-box" onclick="addP(event, ${fi})">
                    ${f.img ? `<img src="${f.img}" class="plan-img">` : '<h2 style="text-align:center; padding-top:200px;">KLIKNIJ BY WGRAĆ RZUT</h2>'}
                    ${f.pts.map((p, pi) => `<div class="dot" style="left:${p.x}%; top:${p.y}%;" onclick="event.stopPropagation(); openM(${fi}, ${pi})">${pi+1}</div>`).join('')}
                </div>`;
            root.appendChild(page);
        });
    }

    // DODAWANIE PIĘTRA
    function addFloor() {
        data.floors.push({ name: "Piętro " + (data.floors.length + 1), img: '', pts: [] });
        render();
    }

    // DODAWANIE KROPKI
    function addP(e, fi) {
        if (!data.floors[fi].img) {
            const inp = document.createElement('input'); inp.type = 'file';
            inp.onchange = ev => {
                const r = new FileReader();
                r.onload = e2 => { data.floors[fi].img = e2.target.result; render(); };
                r.readAsDataURL(ev.target.files[0]);
            };
            inp.click();
            return;
        }
        const r = e.currentTarget.getBoundingClientRect();
        const pi = data.floors[fi].pts.length;
        data.floors[fi].pts.push({
            x: ((e.clientX - r.left) / r.width) * 100,
            y: ((e.clientY - r.top) / r.height) * 100,
            room: '', desc: ''
        });
        render();
        openM(fi, pi);
    }

    // OTWIERANIE MODALA
    function openM(fi, pi) {
        active = { fi, di: pi };
        const p = data.floors[fi].pts[pi];
        document.getElementById('m-room').value = p.room;
        document.getElementById('m-desc').value = p.desc;
        document.getElementById('ov').style.display = 'block';
        document.getElementById('mod').style.display = 'block';
    }

    function saveM() {
        const p = data.floors[active.fi].pts[active.di];
        p.room = document.getElementById('m-room').value;
        p.desc = document.getElementById('m-desc').value;
        closeM();
        render();
    }

    function closeM() {
        document.getElementById('ov').style.display = 'none';
        document.getElementById('mod').style.display = 'none';
    }

    function delP() {
        data.floors[active.fi].pts.splice(active.di, 1);
        closeM();
        render();
    }

    function manualSave() {
        const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "raport.json"; a.click();
    }

    function importData(e) {
        const r = new FileReader();
        r.onload = ev => { data = JSON.parse(ev.target.result); render(); };
        r.readAsText(e.target.files[0]);
    }

    if (data.floors.length === 0) addFloor();
    render();
</script>
</body>
</html>