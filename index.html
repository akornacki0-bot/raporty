<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>SYSTEM RAPORTOWANIA v19.18 PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a252f">
    <link rel="manifest" href="manifest.json">
    
    <style>
        :root { --rep: #e67e22; --nrep: #2c3e50; --none: #95a5a6; --main: #1a252f; --bg: #f8f9fa; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); margin: 0; padding-top: 100px; color: #333; }
        
        .toolbar { position: fixed; top: 0; left: 0; width: 100%; height: 50px; background: var(--main); color: #fff; display: flex; align-items: center; justify-content: center; gap: 12px; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .filter-bar { position: fixed; top: 50px; left: 0; width: 100%; height: 45px; background: #ecf0f1; display: flex; align-items: center; justify-content: center; gap: 10px; z-index: 9998; border-bottom: 1px solid #dcdde1; padding: 0 10px; }
        
        .btn { padding: 8px 15px; border: none; cursor: pointer; font-weight: 600; border-radius: 5px; font-size: 11px; text-transform: uppercase; color: #fff; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        
        .page { width: 210mm; height: 296mm; background: #fff; margin: 0 auto 20px; padding: 15mm; position: relative; display: flex; flex-direction: column; page-break-after: always; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .header-info { font-size: 9px; color: #95a5a6; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; height: 12mm; }
        .mini-logo { max-height: 10mm; max-width: 40mm; object-fit: contain; }

        .footer-info { position: absolute; bottom: 8mm; left: 15mm; right: 15mm; border-top: 1px solid #eee; padding-top: 5px; }
        .footer-row { display: flex; justify-content: flex-end; font-size: 9px; color: #bdc3c7; font-weight: 700; }
        .legal-note { font-size: 7.5px; color: #bdc3c7; font-style: italic; text-align: justify; line-height: 1.2; margin-bottom: 2px; }

        .logo-box { height: 35mm; width: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer; margin-bottom: 10px; }
        .logo-box img { max-height: 100%; max-width: 100%; object-fit: contain; }

        .main-img-box { width: 100%; height: 100mm; background: #fdfdfd; border: 1px dashed #dcdde1; border-radius: 8px; display: flex; justify-content: center; align-items: center; margin-top: 15px; cursor: pointer; overflow: hidden; }
        .main-img-box img { width: 100%; height: 100%; object-fit: cover; }

        .plan-wrapper { width: 100%; height: 180mm; background: #fafafa; border: 1px solid #e1e1e1; border-radius: 8px; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: crosshair; }
        .plan-img { transition: transform 0.3s; max-width: 90%; max-height: 90%; pointer-events: none; }
        .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }

        .grid-table { width: 100%; flex-grow: 1; border-collapse: separate; border-spacing: 0 15px; table-layout: fixed; }
        .grid-table td { width: 100%; height: 120mm; border: 1px solid #edf2f7; border-radius: 8px; padding: 15px; vertical-align: top; position: relative; cursor: pointer; background: #fff; }
        
        .desc-text { font-size: 13px; font-weight: 700; line-height: 1.4; color: var(--main); margin-bottom: 8px; }
        .q-photo { width: 100%; height: 90mm; background: #f8f9fa; border-radius: 6px; display: flex; justify-content: center; align-items: center; margin-top: 10px; border: 1px solid #f1f1f1; overflow: hidden; }
        .q-photo img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .status-badge { padding: 5px 12px; border-radius: 4px; font-weight: 700; font-size: 10px; color: white; margin-bottom: 8px; display: inline-block; }
        .dot { position: absolute; width: 26px; height: 26px; border-radius: 50%; border: 2.5px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; transform: translate(-50%, -50%); font-weight: 800; font-size: 11px; z-index: 100; box-shadow: 0 3px 8px rgba(0,0,0,0.3); }

        #ov { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 37, 47, 0.85); z-index: 10000; }
        #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 25px; border-radius: 12px; z-index: 10001; width: 90%; max-width: 450px; max-height: 95vh; overflow-y: auto; }
        
        .modal-field { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; }
        .modal-photo-preview { width: 100%; height: 180px; background: #f8f9fa; border: 2px dashed #cbd5e0; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: center; align-items: center; cursor: pointer; overflow: hidden; }
        .modal-photo-preview img { width: 100%; height: 100%; object-fit: contain; }

        .check-item { display: flex; align-items: center; gap: 8px; font-size: 13px; padding: 4px 0; border-bottom: 1px solid #f1f1f1; cursor: pointer; }
        .check-item input { width: 18px; height: 18px; cursor: pointer; }

        .c-rep { background: var(--rep); color: #fff; }
        .c-nrep { background: var(--nrep); color: #fff; }
        .c-none { background: var(--none); color: #fff; }
        .info-label { font-weight: 700; color: #7f8c8d; font-size: 11px; background: #f8f9fa; padding: 6px 12px; border-radius: 4px; border: 1px solid #eee; display: block; width: 100%; margin-bottom: 8px; }

        @media print { .no-print { display: none !important; } body { padding: 0; background: #fff; } .page { margin: 0; box-shadow: none; border: none; } }
    </style>
</head>
<body>

<div class="toolbar no-print">
    <button class="btn" style="background:#27ae60" onclick="addFloor()">+ Kondygnacja</button>
    <button class="btn" style="background:#2980b9" onclick="exportData()">Zapisz projekt</button>
    <button class="btn" style="background:#e67e22" onclick="document.getElementById('import-file').click()">Wczytaj .json</button>
    <button class="btn" style="background:#e74c3c; border-radius: 20px;" onclick="window.print()">Drukuj PDF</button>
</div>

<div class="filter-bar no-print">
    <span style="font-size: 11px; font-weight: 700;">FILTRY:</span>
    <select id="f-status" onchange="render()" style="padding:4px; font-size:11px; border-radius:4px;">
        <option value="all">Wszystkie statusy</option>
        <option value="reported">Zgłoszone</option>
        <option value="not_reported">Niezgłoszone</option>
        <option value="to_discuss">Uwagi</option>
    </select>
    <input id="f-room" placeholder="Szukaj pomieszczenia..." oninput="render()" style="padding:4px; font-size:11px; border-radius:4px; border:1px solid #ccc;">
</div>

<input type="file" id="import-file" style="display:none" onchange="importData(event)">
<div id="ov" onclick="closeAllModals()"></div>

<div id="modal">
    <h3 id="m-title" style="margin:0 0 15px 0; color:var(--main); font-size: 16px;">EDYCJA PUNKTU</h3>
    <input id="m-room" class="modal-field" placeholder="Nazwa pomieszczenia (np. Kuchnia, Salon)">
    
    <div class="modal-photo-preview" onclick="uploadImg('report', active.f, active.d)" id="m-photo-box"></div>
    
    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
        <b style="display:block; margin-bottom:8px; font-size: 12px; color: var(--main);">CHECKLISTA ŚCIANY:</b>
        <label class="check-item"><input type="checkbox" id="chk-katy"> Kąty</label>
        <label class="check-item"><input type="checkbox" id="chk-plaszczyzny"> Płaszczyzny</label>
        <label class="check-item"><input type="checkbox" id="chk-stan"> Stan / Wygląd</label>
    </div>

    <textarea id="m-desc" class="modal-field" style="height:60px" placeholder="Opis dodatkowy..."></textarea>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-bottom:15px;">
        <button class="btn c-rep" onclick="setStatus('reported')">ZGŁOSZONE</button>
        <button class="btn c-nrep" onclick="setStatus('not_reported')">NIEZGŁOŚ.</button>
        <button class="btn c-none" onclick="setStatus('to_discuss')">UWAGI</button>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="btn" style="background:#ecf0f1; color:#7f8c8d; flex:1" onclick="deleteReport()">USUŃ</button>
        <button class="btn" style="background:var(--main); flex:1" onclick="closeAllModals()">ZAPISZ</button>
    </div>
</div>

<div id="app"></div>

<script>
    let state = { meta: { inv:'', adr:'', date:'', cli:'' }, logo: '', mainImg: '', floors: [] };
    let active = { f: null, d: null };
    const LEGAL_TEXT = "Dokumentacja stanu technicznego w dniu kontroli.";

    function closeAllModals() {
        if (document.getElementById('modal').style.display === 'block') {
            const d = state.floors[active.f].defects[active.d];
            if(d) {
                d.room = document.getElementById('m-room').value;
                d.desc = document.getElementById('m-desc').value;
                d.checks = {
                    katy: document.getElementById('chk-katy').checked,
                    plaszczyzny: document.getElementById('chk-plaszczyzny').checked,
                    stan: document.getElementById('chk-stan').checked
                };
            }
        }
        document.getElementById('ov').style.display = 'none';
        document.getElementById('modal').style.display = 'none';
        render();
    }

    function uploadImg(type, fi, di) {
        const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
        input.onchange = e => {
            const reader = new FileReader();
            reader.onload = ev => {
                if(type==='logo') state.logo = ev.target.result;
                else if(type==='main') state.mainImg = ev.target.result;
                else if(type==='plan') state.floors[fi].plan = ev.target.result;
                else if(type==='report') { state.floors[fi].defects[di].img = ev.target.result; render(); openModal(fi, di); }
                render();
            };
            reader.readAsDataURL(e.target.files[0]);
        };
        input.click();
    }

    function exportData() {
        const fileName = `Raport_${state.meta.inv || 'projekt'}.json`;
        const blob = new Blob([JSON.stringify(state)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = fileName;
        document.body.appendChild(a); a.click();
        setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 100);
    }

    function importData(e) {
        const r = new FileReader();
        r.onload = ev => { state = JSON.parse(r.result); render(); };
        r.readAsText(e.target.files[0]);
    }

    function rotatePlan(fi) { state.floors[fi].rotation = ((state.floors[fi].rotation || 0) + 90) % 360; render(); }
    function addFloor() { state.floors.push({ name: 'Kondygnacja ' + (state.floors.length + 1), plan: '', defects: [], rotation: 0 }); render(); }
    function deleteFloor(fi) { if(confirm("Usunąć piętro?")) { state.floors.splice(fi, 1); render(); } }

    function addDot(e, fi) {
        if (!state.floors[fi].plan) return uploadImg('plan', fi);
        const r = e.currentTarget.getBoundingClientRect();
        const di = state.floors[fi].defects.length;
        state.floors[fi].defects.push({ x: ((e.clientX - r.left)/r.width)*100, y: ((e.clientY - r.top)/r.height)*100, desc: '', room: '', status: 'to_discuss', img: '', checks:{} });
        render(); openModal(fi, di);
    }

    function openModal(fi, di) {
        active = { f: fi, d: di }; const d = state.floors[fi].defects[di];
        document.getElementById('m-title').innerText = "PUNKT NR " + (di + 1);
        document.getElementById('m-room').value = d.room || '';
        document.getElementById('m-desc').value = d.desc || ''; 
        document.getElementById('chk-katy').checked = d.checks?.katy || false;
        document.getElementById('chk-plaszczyzny').checked = d.checks?.plaszczyzny || false;
        document.getElementById('chk-stan').checked = d.checks?.stan || false;
        document.getElementById('m-photo-box').innerHTML = d.img ? `<img src="${d.img}" style="width:100%;height:100%;object-fit:contain">` : 'DODAJ ZDJĘCIE';
        document.getElementById('ov').style.display = 'block'; 
        document.getElementById('modal').style.display = 'block';
    }

    function setStatus(s) { state.floors[active.f].defects[active.d].status = s; closeAllModals(); }
    function deleteReport() { if(confirm("Usunąć?")) { state.floors[active.f].defects.splice(active.d, 1); closeAllModals(); } }

    function render() {
        const filterStatus = document.getElementById('f-status').value;
        const filterRoom = document.getElementById('f-room').value.toLowerCase();
        
        const root = document.getElementById('app'); root.innerHTML = '';
        let pTotal = 1 + state.floors.length + state.floors.reduce((a, f) => a + Math.ceil(f.defects.length / 2), 0);
        let pNum = 0;

        function getP() {
            pNum++; const p = document.createElement('div'); p.className = 'page';
            p.innerHTML = `<div class="header-info"><div>RAPORT: ${state.meta.inv || '...'}</div>${state.logo ? `<img src="${state.logo}" class="mini-logo">` : ''}</div>
                           <div class="footer-info"><div class="legal-note">${LEGAL_TEXT}</div><div class="footer-row">STRONA ${pNum} / ${pTotal}</div></div>`;
            return p;
        }

        const cover = document.createElement('div'); cover.className = 'page'; pNum++;
        cover.innerHTML = `<div class="logo-box" onclick="uploadImg('logo')">${state.logo ? `<img src="${state.logo}">` : 'DODAJ LOGO'}</div>
            <h1 style="text-align:center; margin-bottom: 30px;">PROTOKÓŁ ODBIORU</h1>
            <div style="margin: 20px 0;">
                <input class="info-label" placeholder="Nazwa Inwestycji" value="${state.meta.inv}" oninput="state.meta.inv=this.value">
                <input class="info-label" placeholder="Adres" value="${state.meta.adr}" oninput="state.meta.adr=this.value">
                <input class="info-label" type="date" value="${state.meta.date}" oninput="state.meta.date=this.value">
                <input class="info-label" placeholder="Zamawiający" value="${state.meta.cli}" oninput="state.meta.cli=this.value">
            </div>
            <div class="main-img-box" onclick="uploadImg('main')">${state.mainImg ? `<img src="${state.mainImg}">` : 'ZDJĘCIE GŁÓWNE'}</div>`;
        root.appendChild(cover);

        state.floors.forEach((f, fi) => {
            const fPage = getP();
            fPage.innerHTML += `<h3>${f.name}</h3><div class="plan-wrapper" onclick="addDot(event, ${fi})">
                ${f.plan ? `<img src="${f.plan}" class="plan-img rot-${f.rotation}">` : 'WGRAJ RZUT'}
                ${f.defects.filter(d => {
                    const matchStatus = filterStatus === 'all' || d.status === filterStatus;
                    const matchRoom = (d.room || '').toLowerCase().includes(filterRoom);
                    return matchStatus && matchRoom;
                }).map((d, di) => {
                    const realIndex = f.defects.indexOf(d);
                    return `<div class="dot ${d.status==='reported'?'c-rep':(d.status==='not_reported'?'c-nrep':'c-none')}" style="left:${d.x}%; top:${d.y}%" onclick="event.stopPropagation(); openModal(${fi},${realIndex})">${realIndex+1}</div>`;
                }).join('')}
            </div><div class="no-print" style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn" style="background:#000" onclick="rotatePlan(${fi})">OBRÓĆ</button>
                <button class="btn" style="background:#c0392b" onclick="deleteFloor(${fi})">USUŃ PIĘTRO</button>
            </div>`;
            root.appendChild(fPage);

            const filteredDefects = f.defects.filter(d => {
                const matchStatus = filterStatus === 'all' || d.status === filterStatus;
                const matchRoom = (d.room || '').toLowerCase().includes(filterRoom);
                return matchStatus && matchRoom;
            });

            for (let i = 0; i < filteredDefects.length; i += 2) {
                const dPage = getP();
                const table = document.createElement('table'); table.className = 'grid-table';
                let html = '';
                for (let j = 0; j < 2; j++) {
                    const idx = i + j;
                    if (idx < filteredDefects.length) {
                        const d = filteredDefects[idx];
                        const realIndex = f.defects.indexOf(d);
                        
                        let checklistSummary = [];
                        if(d.checks?.katy) checklistSummary.push("Kąty");
                        if(d.checks?.plaszczyzny) checklistSummary.push("Płaszczyzny");
                        if(d.checks?.stan) checklistSummary.push("Stan/Wygląd");

                        html += `<tr><td>
                                 <div class="status-badge ${d.status==='reported'?'c-rep':(d.status==='not_reported'?'c-nrep':'c-none')}">PUNKT ${realIndex+1} | ${d.room || 'Brak lokalizacji'}</div>
                                 <div class="desc-text">${d.desc || ''}</div>
                                 ${checklistSummary.length > 0 ? `<div style="font-size:10px; color:#7f8c8d; margin-bottom:5px;"><b>Sprawdzono:</b> ${checklistSummary.join(', ')}</div>` : ''}
                                 <div class="q-photo">${d.img ? `<img src="${d.img}">` : ''}</div></td></tr>`;
                    }
                }
                table.innerHTML = html; dPage.appendChild(table); root.appendChild(dPage);
            }
        });
    }

    if('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
    if(!state.floors.length) addFloor();
    render();
</script>
</body>
</html>