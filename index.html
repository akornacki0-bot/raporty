<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>PR Raporty v20.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --rep: #e67e22; --nrep: #2c3e50; --none: #7f8c8d; --main: #000000; --bg: #f4f4f4; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-top: 110px; }
        
        /* Toolbary */
        .toolbar { position: fixed; top: 0; left: 0; width: 100%; height: 55px; background: var(--main); color: #fff; display: flex; align-items: center; justify-content: center; gap: 10px; z-index: 9999; }
        .filter-bar { position: fixed; top: 55px; left: 0; width: 100%; height: 50px; background: #ddd; display: flex; align-items: center; justify-content: center; gap: 10px; z-index: 9998; border-bottom: 1px solid #bbb; }
        .btn { padding: 10px 15px; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; font-size: 11px; text-transform: uppercase; color: #fff; }
        
        /* Karty PDF */
        .page { width: 210mm; min-height: 296mm; background: #fff; margin: 0 auto 20px; padding: 15mm; position: relative; page-break-after: always; box-shadow: 0 0 10px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
        .footer { position: absolute; bottom: 10mm; left: 15mm; right: 15mm; display: flex; justify-content: space-between; font-size: 10px; border-top: 1px solid #eee; padding-top: 5px; }

        /* Rzut i Kropki */
        .plan-container { width: 100%; height: 180mm; background: #eee; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #ccc; }
        .plan-img { max-width: 100%; max-height: 100%; transition: transform 0.2s; }
        .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }
        .dot { position: absolute; width: 28px; height: 28px; border-radius: 50%; border: 2px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; transform: translate(-50%, -50%); font-weight: bold; font-size: 13px; z-index: 100; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        /* Checklista PDF */
        .room-box { border: 1px solid #333; margin-top: 10px; break-inside: avoid; }
        .room-head { background: #333; color: #fff; padding: 5px 10px; font-weight: bold; }
        .check-row { display: grid; grid-template-columns: repeat(3, 1fr); padding: 5px; font-size: 10px; }
        .check-item { display: flex; align-items: center; gap: 5px; }
        .cb { width: 12px; height: 12px; border: 1px solid #000; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* Modal */
        #ov { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; }
        #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; width: 95%; max-width: 500px; max-height: 90vh; overflow-y: auto; border-radius: 8px; z-index: 10001; }
        .input { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        
        .c-rep { background: #e67e22; } .c-nrep { background: #2c3e50; } .c-none { background: #7f8c8d; }
        @media print { .no-print { display: none !important; } .page { margin: 0; box-shadow: none; } body { padding: 0; } }
    </style>
</head>
<body>

<div class="toolbar no-print">
    <button class="btn" style="background:#27ae60" onclick="addFloor()">+ Piętro</button>
    <button class="btn" style="background:#2980b9" onclick="exportJSON()">Zapisz (.json)</button>
    <button class="btn" style="background:#8e44ad" onclick="document.getElementById('import-file').click()">Wczytaj</button>
    <button class="btn" style="background:#f39c12" onclick="openSettings()">Checklista</button>
    <button class="btn" style="background:#e74c3c" onclick="window.print()">PDF</button>
    <button class="btn" style="background:#333" onclick="clearAll()">Nowy</button>
</div>

<div class="filter-bar no-print">
    <input id="f-room" class="input" style="width:200px; margin:0;" placeholder="Szukaj pomieszczenia..." oninput="render()">
</div>

<input type="file" id="import-file" style="display:none" onchange="importJSON(event)">
<div id="ov" onclick="closeModal()"></div>

<div id="modal">
    <h3 id="m-title" style="margin-top:0">Punkt</h3>
    <label>Pomieszczenie:</label>
    <input id="m-room" class="input" list="room-list" onchange="updatePoint('room', this.value)">
    
    <label>Zdjęcie:</label>
    <div id="m-img-prev" style="width:100%; height:150px; background:#eee; display:flex; justify-content:center; align-items:center; cursor:pointer; overflow:hidden; border-radius:4px; margin-bottom:15px;" onclick="uploadImg('defect')">Dodaj zdjęcie</div>

    <label>Opis usterki:</label>
    <textarea id="m-desc" class="input" style="height:80px" oninput="updatePoint('desc', this.value)"></textarea>

    <label>Norma/Podstawa:</label>
    <input id="m-norm" class="input" oninput="updatePoint('norm', this.value)">

    <div id="m-check-area" style="margin-bottom:15px; border:1px solid #eee; padding:10px; max-height:150px; overflow-y:auto;"></div>

    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
        <button class="btn c-rep" onclick="updatePoint('status', 'reported'); closeModal()">Zgłoszona</button>
        <button class="btn c-nrep" onclick="updatePoint('status', 'not_reported'); closeModal()">Niezgłosz.</button>
        <button class="btn c-none" onclick="updatePoint('status', 'to_discuss'); closeModal()">Uwaga</button>
    </div>
    <button class="btn" style="background:#c0392b; width:100%; margin-top:10px;" onclick="deletePoint()">Usuń punkt</button>
</div>

<div id="settings-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; z-index:10002; width:90%; max-width:400px; border-radius:8px; box-shadow:0 0 20px #000;">
    <h3>Konfiguracja checklisty</h3>
    <p style="font-size:11px;">Format: <b>Kategoria: element1, element2</b></p>
    <textarea id="set-check-text" class="input" style="height:200px;"></textarea>
    <button class="btn" style="background:#27ae60; width:100%;" onclick="saveSettings()">Zapisz</button>
</div>

<div id="app"></div>
<datalist id="room-list"></datalist>

<script>
    // ZABEZPIECZENIE PRZED ODŚWIEŻENIEM
    window.onbeforeunload = () => "Czy na pewno chcesz opuścić stronę? Niezapisane dane zostaną utracone.";

    let config = JSON.parse(localStorage.getItem('pr_cfg_v20')) || {
        rooms: ['Salon', 'Sypialnia 1', 'Sypialnia 2', 'Sypialnia 3', 'Kuchnia', 'Łazienka', 'WC', 'Przedpokój', 'Garaż', 'Balkon'],
        checks: { "Ściany": ["Kąty", "Tynki", "Pion"], "Okna": ["Rysy", "Regulacja"], "Inne": ["Posadzki", "Odpływy"] },
        logo: '', lastRoom: ''
    };

    let state = JSON.parse(localStorage.getItem('pr_state_v20')) || {
        meta: { inv:'', adr:'', date:'', cli:'', mainImg:'' },
        floors: []
    };

    let active = { f: null, d: null };

    function autoSave() {
        localStorage.setItem('pr_state_v20', JSON.stringify(state));
        localStorage.setItem('pr_cfg_v20', JSON.stringify(config));
    }

    function render() {
        const root = document.getElementById('app'); root.innerHTML = '';
        const filter = document.getElementById('f-room').value.toLowerCase();
        let pageNr = 1;

        // 1. OKŁADKA
        const cover = document.createElement('div'); cover.className = 'page';
        cover.innerHTML = `
            <div class="header">
                <div style="cursor:pointer" onclick="uploadImg('logo')">
                    ${config.logo ? `<img src="${config.logo}" style="height:40px">` : 'KLIKNIJ BY DODAĆ LOGO'}
                </div>
                <div style="font-weight:bold">PROTOKÓŁ ODBIORU</div>
            </div>
            <div style="text-align:center; flex-grow:1; display:flex; flex-direction:column; justify-content:center;">
                <h1 style="font-size:32px; margin-bottom:40px;">RAPORT TECHNICZNY</h1>
                <div style="max-width:400px; margin:0 auto; text-align:left;">
                    <input class="input" placeholder="Inwestycja" value="${state.meta.inv}" oninput="state.meta.inv=this.value; autoSave()">
                    <input class="input" placeholder="Adres" value="${state.meta.adr}" oninput="state.meta.adr=this.value; autoSave()">
                    <input class="input" type="date" value="${state.meta.date}" oninput="state.meta.date=this.value; autoSave()">
                    <input class="input" placeholder="Klient" value="${state.meta.cli}" oninput="state.meta.cli=this.value; autoSave()">
                </div>
                <div style="width:100%; height:80mm; background:#eee; margin-top:30px; border:1px dashed #999; display:flex; justify-content:center; align-items:center; overflow:hidden; cursor:pointer;" onclick="uploadImg('main')">
                    ${state.meta.mainImg ? `<img src="${state.meta.mainImg}" style="width:100%; height:100%; object-fit:cover;">` : 'KLIKNIJ BY DODAĆ ZDJĘCIE INWESTYCJI'}
                </div>
            </div>
            <div class="footer"><span>PR Raporty v20</span><span>Strona ${pageNr++}</span></div>`;
        root.appendChild(cover);

        let roomChecks = {};

        // 2. PIĘTRA I USTERKI
        state.floors.forEach((f, fi) => {
            const fPage = document.createElement('div'); fPage.className = 'page';
            fPage.innerHTML = `
                <div class="header"><span>${f.name}</span><span>${state.meta.inv}</span></div>
                <div class="plan-container" onclick="addDot(event, ${fi})">
                    ${f.plan ? `<img src="${f.plan}" class="plan-img rot-${f.rotation || 0}">` : 'KLIKNIJ BY WGRAĆ RZUT'}
                    ${f.defects.map((d, di) => `
                        <div class="dot ${d.status==='reported'?'c-rep':(d.status==='not_reported'?'c-nrep':'c-none')}" 
                             style="left:${d.x}%; top:${d.y}%;" onclick="event.stopPropagation(); openModal(${fi},${di})">${di+1}</div>
                    `).join('')}
                </div>
                <div class="no-print" style="margin-top:10px; display:flex; gap:10px;">
                    <button class="btn" style="background:#333" onclick="rotate(${fi})">Obróć rzut ↻</button>
                    <button class="btn" style="background:#c0392b" onclick="deleteFloor(${fi})">Usuń piętro</button>
                    <input value="${f.name}" onchange="state.floors[${fi}].name=this.value; autoSave(); render();" style="padding:5px;">
                </div>
                <div class="footer"><span>${f.name}</span><span>Strona ${pageNr++}</span></div>`;
            root.appendChild(fPage);

            f.defects.forEach((d, di) => {
                const rName = d.room || "Inne";
                if(!roomChecks[rName]) roomChecks[rName] = {};
                if(d.checks) { for(let k in d.checks) if(d.checks[k]) roomChecks[rName][k] = true; }

                if(rName.toLowerCase().includes(filter)) {
                    const dPage = document.createElement('div'); dPage.className = 'page';
                    dPage.innerHTML = `
                        <div class="header"><span>PUNKT ${di+1}: ${rName}</span><span>${d.status}</span></div>
                        <div style="background:#f9f9f9; padding:15px; border-radius:5px; margin-bottom:20px;">
                            <div style="font-weight:bold; color:#e67e22;">OPIS USTERKI:</div>
                            <div style="font-size:16px; margin:10px 0;">${d.desc || 'Brak opisu.'}</div>
                            ${d.norm ? `<div style="font-size:11px; border-top:1px solid #ccc; padding-top:5px;"><b>Norma:</b> ${d.norm}</div>` : ''}
                        </div>
                        <div style="flex-grow:1; display:flex; justify-content:center; align-items:center; background:#fff; border:1px solid #eee;">
                            ${d.img ? `<img src="${d.img}" style="max-width:100%; max-height:150mm; object-fit:contain;">` : 'Brak zdjęcia'}
                        </div>
                        <div class="footer"><span>Punkt ${di+1}</span><span>Strona ${pageNr++}</span></div>`;
                    root.appendChild(dPage);
                }
            });
        });

        // 3. ZBIORCZA CHECKLISTA
        const sumPage = document.createElement('div'); sumPage.className = 'page';
        sumPage.innerHTML = `<h2 style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px;">PROTOKÓŁ WERYFIKACJI POMIESZCZEŃ</h2>`;
        for (const [room, checks] of Object.entries(roomChecks)) {
            let html = `<div class="room-box"><div class="room-head">${room}</div>`;
            for (const [cat, items] of Object.entries(config.checks)) {
                html += `<div style="font-size:9px; font-weight:bold; padding:2px 10px; color:#e67e22;">${cat}</div><div class="check-row">`;
                items.forEach(item => {
                    html += `<div class="check-item"><div class="cb">${checks[`${cat}:${item}`]?'✓':''}</div>${item}</div>`;
                });
                html += `</div>`;
            }
            sumPage.innerHTML += html + `</div>`;
        }
        sumPage.innerHTML += `
            <div style="margin-top:auto; display:flex; justify-content:space-between; padding-top:50px;">
                <div style="width:45%; border-top:1px solid #000; text-align:center; font-size:12px;">Podpis Inżyniera</div>
                <div style="width:45%; border-top:1px solid #000; text-align:center; font-size:12px;">Podpis Klienta</div>
            </div>`;
        root.appendChild(sumPage);
        updateDatalist();
    }

    function addDot(e, fi) {
        if (!state.floors[fi].plan) return uploadImg('plan', fi);
        const r = e.currentTarget.getBoundingClientRect();
        const di = state.floors[fi].defects.length;
        state.floors[fi].defects.push({ 
            x:((e.clientX-r.left)/r.width)*100, 
            y:((e.clientY-r.top)/r.height)*100, 
            desc:'', room: config.lastRoom || '', status:'to_discuss', img:'', norm:'', checks:{} 
        });
        autoSave(); render(); openModal(fi, di);
    }

    function openModal(fi, di) {
        active = { f: fi, d: di }; let d = state.floors[fi].defects[di];
        document.getElementById('m-title').innerText = `Punkt ${di+1}`;
        document.getElementById('m-room').value = d.room || '';
        document.getElementById('m-desc').value = d.desc || '';
        document.getElementById('m-norm').value = d.norm || '';
        document.getElementById('m-img-prev').innerHTML = d.img ? `<img src="${d.img}" style="height:100%">` : 'Dodaj zdjęcie';
        renderModalChecks(d);
        document.getElementById('ov').style.display = 'block';
        document.getElementById('modal').style.display = 'block';
        setTimeout(() => document.getElementById('m-desc').focus(), 200);
    }

    function renderModalChecks(d) {
        const area = document.getElementById('m-check-area'); area.innerHTML = '';
        for (const [cat, items] of Object.entries(config.checks)) {
            area.innerHTML += `<div style="font-weight:bold; font-size:11px; margin-top:5px; color:#e67e22;">${cat}</div>`;
            items.forEach(item => {
                const key = `${cat}:${item}`;
                area.innerHTML += `
                    <label style="display:flex; align-items:center; gap:10px; padding:5px 0; border-bottom:1px solid #eee;">
                        <input type="checkbox" ${d.checks && d.checks[key]?'checked':''} onchange="toggleCheck('${cat}', '${item}')"> ${item}
                    </label>`;
            });
        }
    }

    function toggleCheck(cat, item) {
        let d = state.floors[active.f].defects[active.d];
        if(!d.checks) d.checks = {};
        const key = `${cat}:${item}`;
        d.checks[key] = !d.checks[key];
        autoSave();
    }

    function updatePoint(f, v) {
        state.floors[active.f].defects[active.d][f] = v;
        if(f==='room') {
            config.lastRoom = v;
            if(v && !config.rooms.includes(v)) config.rooms.push(v);
        }
        autoSave();
    }

    function uploadImg(type, fi) {
        const i = document.createElement('input'); i.type='file'; i.accept='image/*';
        i.onchange = e => {
            const r = new FileReader();
            r.onload = ev => {
                if(type==='logo') config.logo = ev.target.result;
                else if(type==='main') state.meta.mainImg = ev.target.result;
                else if(type==='plan') state.floors[fi].plan = ev.target.result;
                else if(type==='defect') {
                    state.floors[active.f].defects[active.d].img = ev.target.result;
                    document.getElementById('m-img-prev').innerHTML = `<img src="${ev.target.result}" style="height:100%">`;
                }
                autoSave(); render();
            };
            r.readAsDataURL(e.target.files[0]);
        }; i.click();
    }

    function rotate(fi) { state.floors[fi].rotation = ((state.floors[fi].rotation || 0) + 90) % 360; autoSave(); render(); }
    function addFloor() { state.floors.push({ name: 'PIĘTRO '+(state.floors.length+1), plan:'', defects:[], rotation:0 }); autoSave(); render(); }
    function deleteFloor(fi) { if(confirm("Usunąć piętro?")) { state.floors.splice(fi,1); autoSave(); render(); } }
    function deletePoint() { if(confirm("Usunąć punkt?")) { state.floors[active.f].defects.splice(active.d,1); closeModal(); } }
    function closeModal() { document.getElementById('ov').style.display='none'; document.getElementById('modal').style.display='none'; render(); }
    function updateDatalist() { document.getElementById('room-list').innerHTML = config.rooms.map(r => `<option value="${r}">`).join(''); }
    function openSettings() {
        let t = ""; for(let [k,v] of Object.entries(config.checks)) t += `${k}: ${v.join(', ')}\n`;
        document.getElementById('set-check-text').value = t;
        document.getElementById('settings-modal').style.display='block';
    }
    function saveSettings() {
        const lines = document.getElementById('set-check-text').value.split('\n');
        config.checks = {};
        lines.forEach(l => {
            if(l.includes(':')) {
                const [k, v] = l.split(':');
                config.checks[k.trim()] = v.split(',').map(x => x.trim()).filter(x => x);
            }
        });
        autoSave(); document.getElementById('settings-modal').style.display='none'; render();
    }
    function exportJSON() {
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(state)], {type:'application/json'}));
        a.download = `Raport_${state.meta.inv || 'PR'}.json`; a.click();
    }
    function importJSON(e) {
        const r = new FileReader(); r.onload = ev => { state = JSON.parse(ev.target.result); autoSave(); render(); };
        r.readAsText(e.target.files[0]);
    }
    function clearAll() { if(confirm("Nowy raport? Wszystko zostanie usunięte!")) { state = { meta: { inv:'', adr:'', date:'', cli:'', mainImg:'' }, floors: [] }; addFloor(); autoSave(); render(); } }

    if(!state.floors.length) addFloor();
    render();
</script>
</body>
</html>