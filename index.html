<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>PR RAPORTY v31</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --main: #2c3e50; --acc: #f39c12; --bg: #f4f7f6; --white: #ffffff; --border: #dcdde1; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding-top: 60px; background: var(--bg); color: #2f3640; }

        /* INTERFEJS */
        .toolbar { position: fixed; top: 0; width: 100%; height: 55px; background: var(--main); color: #fff; display: flex; align-items: center; justify-content: center; gap: 10px; z-index: 1000; padding: 0 10px; }
        .btn { border: none; border-radius: 4px; padding: 10px 15px; font-weight: bold; cursor: pointer; font-size: 11px; text-transform: uppercase; color: #fff; }
        .btn-green { background: #27ae60; } .btn-blue { background: #2980b9; } .btn-orange { background: #f39c12; } .btn-red { background: #e74c3c; } .btn-dark { background: #34495e; }

        /* DOKUMENT A4 */
        .page { width: 210mm; min-height: 296mm; background: var(--white); margin: 10px auto; padding: 10mm; position: relative; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        /* RZUT */
        .plan-area { position: relative; width: 100%; flex-grow: 1; background: #fafafa; border: 1px solid var(--border); overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .plan-img { position: relative; transition: transform 0.1s; pointer-events: none; }
        .dot { position: absolute; width: 30px; height: 30px; border-radius: 50%; border: 2px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; transform: translate(-50%, -50%); z-index: 100; cursor: pointer; }
        
        /* KOLORY STATUSÓW */
        .status-zgloszone { background: #e67e22; } 
        .status-niezgloszone { background: #2c3e50; } 
        .status-uwaga { background: #7f8c8d; }

        /* RAPORT LISTA */
        .defect-row { height: 135mm; border-bottom: 1px solid #eee; padding: 15px 0; display: flex; gap: 20px; page-break-inside: avoid; }
        .defect-photo-box { width: 45%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f9f9f9; border: 1px solid #eee; }
        .defect-photo-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .defect-details { width: 55%; font-size: 14px; }

        /* MODALE */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; width: 95%; max-width: 900px; border-radius: 8px; z-index: 2001; max-height: 90vh; overflow: hidden; flex-direction: column; }
        .modal-body { overflow-y: auto; flex-grow: 1; }
        .input { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid var(--border); border-radius: 4px; }

        /* SZCZEGÓŁY TABS */
        .settings-grid { display: flex; gap: 20px; height: 450px; }
        .sidebar { width: 200px; border-right: 1px solid #eee; display: flex; flex-direction: column; gap: 5px; }
        .tab { padding: 10px; background: #f1f2f6; border: none; text-align: left; cursor: pointer; border-radius: 4px; }
        .tab.active { background: var(--acc); color: white; }

        @media print {
            .no-print { display: none !important; }
            .page { margin: 0; box-shadow: none; width: 210mm; height: 297mm; page-break-after: always; }
        }
    </style>
</head>
<body>

<div class="toolbar no-print">
    <button class="btn btn-green" onclick="dodajPietro()">+ PIĘTRO</button>
    <button class="btn btn-blue" onclick="zapiszJSON()">ZAPISZ JSON</button>
    <button class="btn btn-dark" onclick="document.getElementById('file-in').click()">WCZYTAJ</button>
    <button class="btn btn-orange" onclick="otworzUstawienia()">SZCZEGÓŁY</button>
    <button class="btn btn-red" onclick="window.print()">DRUKUJ PDF</button>
</div>

<input type="file" id="file-in" style="display:none" onchange="wczytajJSON(event)">
<div class="overlay" id="overlay" onclick="zamknijModale()"></div>

<div class="modal" id="modal-kropka" style="display:none;">
    <div class="modal-body">
        <h2 id="m-naglowek">Edycja Punktu</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <label>Pomieszczenie:</label>
                <input id="m-pom" class="input">
                <label>Status:</label>
                <select id="m-stat" class="input">
                    <option value="status-zgloszone">Zgłoszone</option>
                    <option value="status-niezgloszone">Niezgłoszone</option>
                    <option value="status-uwaga">Do omówienia</option>
                </select>
                <div id="dropdowns-zakladek"></div>
            </div>
            <div>
                <div id="m-foto-podglad" style="width:100%; height:180px; background:#eee; border:2px dashed #ccc; display:flex; align-items:center; justify-content:center; cursor:pointer;" onclick="wgrajFotoUsterki()">Dodaj zdjęcie</div>
                <label style="margin-top:10px; display:block;">Zaznaczone elementy (wybierz z list powyżej):</label>
                <div id="m-zaznaczone-lista" style="background:#f9f9f9; padding:10px; min-height:50px; border:1px solid #ddd; margin-bottom:10px;"></div>
            </div>
        </div>
        <label>Opis własny:</label>
        <textarea id="m-opis" class="input" style="height:80px"></textarea>
        <label>Norma / Podstawa:</label>
        <input id="m-norma" class="input">
        
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-green" style="flex:1" onclick="zapiszPunkt()">ZAPISZ</button>
            <button class="btn btn-red" onclick="usunPunkt()">USUŃ</button>
        </div>
    </div>
</div>

<div class="modal" id="modal-ustawienia" style="display:none;">
    <h2>Konfiguracja Szablonu</h2>
    <div class="settings-grid">
        <div class="sidebar" id="ust-zakladki"></div>
        <div class="modal-body" id="ust-kontent" style="padding:10px;"></div>
    </div>
    <div style="margin-top:15px; display:flex; gap:10px;">
        <button class="btn btn-dark" onclick="nowaZakladka()">+ DODAJ ZAKŁADKĘ</button>
        <button class="btn btn-green" style="margin-left:auto" onclick="zamknijModale()">ZAMKNIJ</button>
    </div>
</div>

<div id="app"></div>

<script>
    let d = {
        meta: { inv:'', adr:'', cli:'', date: new Date().toISOString().split('T')[0], logo:'', mainImg:'' },
        pietra: [],
        szablon: [
            { id:1, nazwa:'Normy', kat: [{ nazwa:'Ściany', poz:['Tynki odchyłki','Płaszczyzny'] }] }
        ],
        lastPom: ''
    };

    let akt = { fi: null, pi: null, img: '', tabId: 1 };

    window.onbeforeunload = () => "Czy zapisałeś zmiany?";

    function render() {
        const root = document.getElementById('app');
        root.innerHTML = '';

        // STRONA 1
        const s1 = strona();
        s1.innerHTML = `
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; text-align:center;">
                <img src="${d.meta.logo}" style="max-height:100px; cursor:pointer;" onclick="upload('logo')" alt="[ LOGO ]">
                <h1 style="border-bottom:3px solid #000; padding-bottom:10px;">PROTOKÓŁ ODBIORU</h1>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; text-align:left; margin:20px 0;">
                    <div>Inwestycja: <input class="input" value="${d.meta.inv}" onchange="d.meta.inv=this.value"></div>
                    <div>Adres: <input class="input" value="${d.meta.adr}" onchange="d.meta.adr=this.value"></div>
                    <div>Zamawiający: <input class="input" value="${d.meta.cli}" onchange="d.meta.cli=this.value"></div>
                    <div>Data: <input class="input" type="date" value="${d.meta.date}" onchange="d.meta.date=this.value"></div>
                </div>
                <div style="width:100%; height:100mm; background:#eee; cursor:pointer; overflow:hidden;" onclick="upload('main')">
                    ${d.meta.mainImg ? `<img src="${d.meta.mainImg}" style="width:100%; height:100%; object-fit:cover;">` : 'ZDJĘCIE GŁÓWNE'}
                </div>
            </div>`;
        root.appendChild(s1);

        // PIĘTRA
        d.pietra.forEach((f, fi) => {
            const sF = strona();
            sF.innerHTML = `
                <div style="display:flex; justify-content:space-between; border-bottom:2px solid #333; margin-bottom:10px;">
                    <input class="input" style="border:none; width:200px; margin:0; font-weight:bold;" value="${f.nazwa}" onchange="d.pietra[${fi}].nazwa=this.value">
                    <b>${d.meta.inv}</b>
                </div>
                <div class="plan-area" onclick="klikPlan(event, ${fi})">
                    ${f.img ? `<img src="${f.img}" class="plan-img" style="transform: rotate(${f.rot}deg) scale(${f.scale}); top:${f.offY}px; left:${f.offX}px;">` : '<h2>KLIKNIJ BY WGRAĆ RZUT</h2>'}
                    ${f.pts.map((p, pi) => `<div class="dot ${p.stat}" style="left:${p.x}%; top:${p.y}%;" onclick="event.stopPropagation(); edytujP(${fi}, ${pi})">${pi+1}</div>`).join('')}
                </div>
                <div class="no-print" style="padding:10px; background:#eee; display:flex; gap:10px; font-size:10px; flex-wrap:wrap;">
                    <button class="btn btn-dark" onclick="obroc(${fi})">OBRÓĆ</button>
                    Skala: <input type="range" min="0.5" max="3" step="0.1" value="${f.scale}" oninput="skaluj(${fi}, this.value)">
                    X: <input type="range" min="-500" max="500" value="${f.offX}" oninput="d.pietra[${fi}].offX=this.value; render()">
                    Y: <input type="range" min="-500" max="500" value="${f.offY}" oninput="d.pietra[${fi}].offY=this.value; render()">
                    <button class="btn btn-red" style="margin-left:auto" onclick="d.pietra.splice(${fi},1); render()">USUŃ</button>
                </div>`;
            root.appendChild(sF);

            // RAPORTY
            for (let i = 0; i < f.pts.length; i += 2) {
                const sL = strona();
                for (let j = i; j < i + 2 && j < f.pts.length; j++) {
                    const p = f.pts[j];
                    sL.innerHTML += `
                        <div class="defect-row">
                            <div class="defect-photo-box">${p.img ? `<img src="${p.img}">` : 'BRAK ZDJĘCIA'}</div>
                            <div class="defect-details">
                                <b style="font-size:18px; color:var(--acc);">ZGŁOSZENIE NR ${j+1}</b>
                                <div><b>STATUS:</b> ${p.stat.replace('status-','').toUpperCase()}</div>
                                <div style="margin-top:10px;"><b>POMIESZCZENIE:</b> ${p.pom}</div>
                                <div><b>ELEMENTY:</b> ${p.zaz.join(', ')}</div>
                                <div><b>OPIS:</b> ${p.opis}</div>
                                ${p.norm ? `<div style="margin-top:auto; color:red; font-weight:bold;">NORMA: ${p.norm}</div>` : ''}
                            </div>
                        </div>`;
                }
                root.appendChild(sL);
            }
        });
    }

    function strona() { const div = document.createElement('div'); div.className = 'page'; return div; }

    function dodajPietro() { d.pietra.push({ nazwa:'Poziom '+ (d.pietra.length+1), img:'', pts:[], rot:0, scale:1, offX:0, offY:0 }); render(); }

    function klikPlan(e, fi) {
        if(!d.pietra[fi].img) return upload('plan', fi);
        const r = e.currentTarget.getBoundingClientRect();
        const pi = d.pietra[fi].pts.length;
        d.pietra[fi].pts.push({ x: ((e.clientX - r.left)/r.width)*100, y: ((e.clientY - r.top)/r.height)*100, pom: d.lastPom, opis:'', norm:'', stat:'status-uwaga', img:'', zaz:[] });
        render(); edytujP(fi, pi);
    }

    function edytujP(fi, pi) {
        akt.fi = fi; akt.pi = pi;
        const p = d.pietra[fi].pts[pi];
        akt.img = p.img;
        document.getElementById('m-naglowek').innerText = `Punkt ${pi+1}`;
        document.getElementById('m-pom').value = p.pom;
        document.getElementById('m-stat').value = p.stat;
        document.getElementById('m-opis').value = p.opis;
        document.getElementById('m-norma').value = p.norm;
        document.getElementById('m-foto-podglad').innerHTML = p.img ? `<img src="${p.img}" style="height:100%">` : 'Dodaj zdjęcie';
        odswiezZaznaczone(p.zaz);
        generujDropdowny(p);

        document.getElementById('overlay').style.display = 'block';
        document.getElementById('modal-kropka').style.display = 'flex';
    }

    function generujDropdowny(p) {
        const wrap = document.getElementById('dropdowns-zakladek');
        wrap.innerHTML = '';
        d.szablon.forEach(zak => {
            const label = document.createElement('label'); label.innerText = zak.nazwa + ":";
            const sel = document.createElement('select'); sel.className = 'input';
            sel.innerHTML = `<option value="">-- wybierz --</option>` + zak.kat.map(k => 
                `<optgroup label="${k.nazwa}">${k.poz.map(poz => `<option value="${poz}">${poz}</option>`).join('')}</optgroup>`
            ).join('');
            sel.onchange = (e) => {
                if(e.target.value && !p.zaz.includes(e.target.value)) {
                    p.zaz.push(e.target.value);
                    if(zak.nazwa.toLowerCase().includes('norm')) document.getElementById('m-norma').value = e.target.value;
                    if(zak.nazwa.toLowerCase().includes('pom')) document.getElementById('m-pom').value = e.target.value;
                    odswiezZaznaczone(p.zaz);
                }
                e.target.value = "";
            };
            wrap.appendChild(label); wrap.appendChild(sel);
        });
    }

    function odswiezZaznaczone(lista) {
        const box = document.getElementById('m-zaznaczone-lista');
        box.innerHTML = lista.map((z, i) => `<span style="display:inline-block; background:#eee; padding:2px 8px; margin:2px; border-radius:10px; font-size:12px;">${z} <b style="color:red; cursor:pointer;" onclick="usunZaz(${i})">x</b></span>`).join('');
    }

    function usunZaz(idx) { d.pietra[akt.fi].pts[akt.pi].zaz.splice(idx, 1); odswiezZaznaczone(d.pietra[akt.fi].pts[akt.pi].zaz); }

    function zapiszPunkt() {
        const p = d.pietra[akt.fi].pts[akt.pi];
        p.pom = document.getElementById('m-pom').value;
        p.stat = document.getElementById('m-stat').value;
        p.opis = document.getElementById('m-opis').value;
        p.norm = document.getElementById('m-norma').value;
        p.img = akt.img;
        d.lastPom = p.pom;
        zamknijModale(); render();
    }

    // USTAWIENIA SZCZEGÓŁÓW
    function otworzUstawienia() {
        renderTabList();
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('modal-ustawienia').style.display = 'flex';
    }

    function renderTabList() {
        const nav = document.getElementById('ust-zakladki');
        nav.innerHTML = d.szablon.map(z => `<button class="tab ${akt.tabId==z.id?'active':''}" onclick="akt.tabId=${z.id}; renderTabList();">${z.nazwa}</button>`).join('');
        renderTabContent();
    }

    function renderTabContent() {
        const cont = document.getElementById('ust-kontent');
        const zak = d.szablon.find(z => z.id == akt.tabId);
        if(!zak) return cont.innerHTML = "";
        cont.innerHTML = `<h3>Zakładka: <input value="${zak.nazwa}" onchange="zmienNazweZ(${zak.id}, this.value)"> <button class="btn btn-red" onclick="usunZ(${zak.id})">USUŃ ZAKŁADKĘ</button></h3>`;
        zak.kat.forEach((k, ki) => {
            cont.innerHTML += `
                <div style="border:1px solid #ddd; padding:10px; margin-bottom:10px;">
                    Kategoria: <input value="${k.nazwa}" onchange="d.szablon.find(z=>z.id==${zak.id}).kat[${ki}].nazwa=this.value">
                    <div id="kat-${ki}-poz" style="margin-top:10px;">
                        ${k.poz.map((p, pi) => `<div style="display:flex; gap:5px; margin-bottom:2px;"><input style="flex:1" value="${p}" onchange="d.szablon.find(z=>z.id==${zak.id}).kat[${ki}].poz[${pi}]=this.value"> <button onclick="d.szablon.find(z=>z.id==${zak.id}).kat[${ki}].poz.splice(${pi},1); renderTabContent()">x</button></div>`).join('')}
                    </div>
                    <button class="btn btn-dark" style="font-size:9px" onclick="d.szablon.find(z=>z.id==${zak.id}).kat[${ki}].poz.push('Nowa pozycja'); renderTabContent()">+ POZYCJA</button>
                    <button class="btn btn-red" style="font-size:9px" onclick="d.szablon.find(z=>z.id==${zak.id}).kat[${ki}].splice(${ki},1); renderTabContent()">USUŃ KAT.</button>
                </div>`;
        });
        cont.innerHTML += `<button class="btn btn-blue" onclick="d.szablon.find(z=>z.id==${zak.id}).kat.push({nazwa:'Nowa Kat', poz:[]}); renderTabContent()">+ DODAJ KATEGORIĘ</button>`;
    }

    function nowaZakladka() { d.szablon.push({ id: Date.now(), nazwa: 'Nowa Zakładka', kat: [] }); renderTabList(); }
    function usunZ(id) { d.szablon = d.szablon.filter(z=>z.id!=id); if(d.szablon.length) akt.tabId=d.szablon[0].id; renderTabList(); }
    function zmienNazweZ(id, v) { d.szablon.find(z=>z.id==id).nazwa = v; renderTabList(); }

    // OBRAZY I ZAPIS
    function upload(typ, fi=null) {
        const i = document.createElement('input'); i.type='file'; i.accept='image/*';
        i.onchange = e => {
            const r = new FileReader();
            r.onload = ev => {
                resize(ev.target.result, 1200, (res) => {
                    if(typ=='logo') d.meta.logo=res; else if(typ=='main') d.meta.mainImg=res; else if(typ=='plan') d.pietra[fi].img=res;
                    render();
                });
            }; r.readAsDataURL(e.target.files[0]);
        }; i.click();
    }

    function wgrajFotoUsterki() {
        const i = document.createElement('input'); i.type='file'; i.accept='image/*';
        i.onchange = e => {
            const r = new FileReader();
            r.onload = ev => {
                resize(ev.target.result, 1000, (res) => {
                    akt.img = res;
                    document.getElementById('m-foto-podglad').innerHTML = `<img src="${res}" style="height:100%">`;
                });
            }; r.readAsDataURL(e.target.files[0]);
        }; i.click();
    }

    function resize(base64, max, cb) {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if(w > h) { if(w > max) { h *= max/w; w = max; } } else { if(h > max) { w *= max/h; h = max; } }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            cb(canvas.toDataURL('image/jpeg', 0.8));
        }; img.src = base64;
    }

    function obroc(fi) { d.pietra[fi].rot = (d.pietra[fi].rot + 90) % 360; render(); }
    function skaluj(fi, v) { d.pietra[fi].scale = v; render(); }
    function zamknijModale() { document.querySelectorAll('.modal, .overlay').forEach(el=>el.style.display='none'); }
    function usunPunkt() { d.pietra[akt.fi].pts.splice(akt.pi,1); zamknijModale(); render(); }
    function zapiszJSON() {
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(d)], {type:'application/json'}));
        a.download = `Raport_${d.meta.inv || 'Odbior'}.json`; a.click();
    }
    function wczytajJSON(e) {
        const r = new FileReader(); r.onload = ev => { d = JSON.parse(ev.target.result); render(); };
        r.readAsText(e.target.files[0]);
    }

    if(d.pietra.length===0) dodajPietro();
    render();
</script>
</body>
</html>