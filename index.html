<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>PR RAPORTY PRO v21</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --main: #000; --accent: #e67e22; --bg: #f0f2f5; --white: #ffffff; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); margin: 0; padding-top: 115px; }
        .toolbar { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: var(--main); color: #fff; display: flex; align-items: center; justify-content: center; gap: 8px; z-index: 1000; padding: 0 10px; }
        .filter-bar { position: fixed; top: 60px; left: 0; width: 100%; height: 55px; background: #e2e2e2; display: flex; align-items: center; justify-content: center; gap: 10px; z-index: 999; border-bottom: 2px solid #ccc; }
        .btn { padding: 10px 14px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 11px; text-transform: uppercase; color: #fff; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .page { width: 210mm; min-height: 296mm; background: var(--white); margin: 0 auto 30px; padding: 15mm; position: relative; page-break-after: always; box-shadow: 0 0 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--main); padding-bottom: 10px; margin-bottom: 20px; }
        .logo-placeholder { max-height: 50px; max-width: 150px; object-fit: contain; }
        .footer { position: absolute; bottom: 10mm; left: 15mm; right: 15mm; display: flex; justify-content: space-between; font-size: 10px; color: #777; border-top: 1px solid #eee; padding-top: 5px; }
        .plan-box { width: 100%; height: 180mm; background: #fafafa; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #ddd; border-radius: 4px; cursor: crosshair; }
        .plan-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }
        .dot { position: absolute; width: 30px; height: 30px; border-radius: 50%; border: 2px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; transform: translate(-50%, -50%); font-weight: bold; font-size: 14px; z-index: 500; cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.3); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 25px; width: 95%; max-width: 550px; max-height: 90vh; overflow-y: auto; border-radius: 12px; z-index: 2001; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-size: 11px; font-weight: bold; color: #555; margin-bottom: 5px; text-transform: uppercase; }
        .input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; }
        .c-reported { background: #e67e22; } .c-not_reported { background: #2c3e50; } .c-to_discuss { background: #95a5a6; }
        @media print { .no-print { display: none !important; } .page { margin: 0; box-shadow: none; width: 100%; } body { padding: 0; } }
    </style>
</head>
<body>

<div class="toolbar no-print">
    <button class="btn" style="background:#27ae60" onclick="addFloor()">+ PIĘTRO</button>
    <button class="btn" style="background:#2980b9" onclick="exportData()">ZAPISZ (.JSON)</button>
    <button class="btn" style="background:#8e44ad" onclick="document.getElementById('file-input').click()">WCZYTAJ</button>
    <button class="btn" style="background:#f39c12" onclick="toggleSettings(true)">CHECKLISTA</button>
    <button class="btn" style="background:#e74c3c" onclick="window.print()">GENERUJ PDF</button>
    <button class="btn" style="background:#333" onclick="resetApp()">NOWY</button>
</div>

<div class="filter-bar no-print">
    <input id="search-room" class="input" style="width:250px; margin:0;" placeholder="Filtruj pomieszczenie..." oninput="render()">
</div>

<input type="file" id="file-input" style="display:none" onchange="importData(event)">
<div class="modal-overlay" id="overlay" onclick="closeModal()"></div>

<div class="modal" id="edit-modal">
    <h3 style="margin-top:0" id="m-title">Edycja Punktu</h3>
    <div class="form-group"><label>Pomieszczenie:</label><input id="m-room" class="input" list="room-presets" onchange="updateActivePoint('room', this.value)"></div>
    <div class="form-group"><label>Zdjęcie usterki:</label><div id="m-img-box" style="width:100%; height:180px; background:#f8f8f8; border:2px dashed #ccc; display:flex; justify-content:center; align-items:center; cursor:pointer; overflow:hidden; border-radius:8px;" onclick="handleImgUpload('defect')">Kliknij, aby dodać zdjęcie</div></div>
    <div class="form-group"><label>Opis i Uwagi:</label><textarea id="m-desc" class="input" style="height:100px" oninput="updateActivePoint('desc', this.value)"></textarea></div>
    <div class="form-group"><label>Norma / Podstawa prawna:</label><input id="m-norm" class="input" placeholder="np. PN-EN, odchyłka 3mm..." oninput="updateActivePoint('norm', this.value)"></div>
    <div class="form-group"><label>Checklista:</label><div id="m-check-list" style="border:1px solid #eee; padding:10px; border-radius:6px; background:#fafafa; max-height:150px; overflow-y:auto;"></div></div>
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
        <button class="btn c-reported" onclick="updateActivePoint('status', 'reported'); closeModal()">ZGŁOSZONA</button>
        <button class="btn c-not_reported" onclick="updateActivePoint('status', 'not_reported'); closeModal()">NIEZGŁ.</button>
        <button class="btn c-to_discuss" onclick="updateActivePoint('status', 'to_discuss'); closeModal()">UWAGA</button>
    </div>
    <button class="btn" style="background:#c0392b; width:100%; margin-top:15px;" onclick="deletePoint()">USUŃ PUNKT</button>
</div>

<div class="modal" id="settings-modal">
    <h3>Ustawienia Checklisty</h3>
    <textarea id="set-check-raw" class="input" style="height:250px; font-family:monospace;"></textarea>
    <button class="btn" style="background:#27ae60; width:100%; margin-top:10px;" onclick="saveSettings()">ZAPISZ I ZAMKNIJ</button>
</div>

<div id="app-root"></div>
<datalist id="room-presets"></datalist>

<script>
    window.onbeforeunload = () => "Masz niezapisane zmiany!";
    let config = JSON.parse(localStorage.getItem('pr_pro_cfg')) || {
        rooms: ['Salon', 'Sypialnia 1', 'Sypialnia 2', 'Kuchnia', 'Łazienka', 'WC', 'Przedpokój'],
        checklist: { "Ściany/Sufity": ["Kąty", "Płaszczyzny", "Tynki"], "Okna": ["Rysy", "Regulacja"], "Instalacje": ["Prąd", "Woda"] },
        logo: '', lastRoom: ''
    };
    let state = JSON.parse(localStorage.getItem('pr_pro_state')) || {
        meta: { inv:'', adr:'', date:'', cli:'', mainImg:'' },
        floors: []
    };
    let active = { fIdx: null, dIdx: null };
    function save() {
        localStorage.setItem('pr_pro_state', JSON.stringify(state));
        localStorage.setItem('pr_pro_cfg', JSON.stringify(config));
    }
    function render() {
        const root = document.getElementById('app-root'); root.innerHTML = '';
        const filter = document.getElementById('search-room').value.toLowerCase();
        let globalPageIdx = 1;
        const createPage = (title) => {
            const p = document.createElement('div'); p.className = 'page';
            p.innerHTML = `<div class="header"><div onclick="handleImgUpload('logo')" style="cursor:pointer">${config.logo ? `<img src="${config.logo}" class="logo-placeholder">` : '[ LOGO ]'}</div><div style="text-align:right"><b>${state.meta.inv || 'RAPORT TECHNICZNY'}</b><br><small>${title}</small></div></div><div class="footer"><span>PR RAPORTY v21</span><span>STRONA ${globalPageIdx++}</span></div>`;
            return p;
        };
        const cover = createPage("DOKUMENTACJA GŁÓWNA");
        const coverBody = document.createElement('div'); coverBody.style.cssText = "flex-grow:1; display:flex; flex-direction:column; justify-content:center; text-align:center;";
        coverBody.innerHTML = `<h1 style="font-size:36px; margin-bottom:40px;">PROTOKÓŁ ODBIORU</h1><div style="max-width:450px; margin:0 auto; text-align:left;"><label style="font-size:10px; font-weight:bold;">INWESTYCJA:</label><input class="input" style="margin-bottom:15px" value="${state.meta.inv}" oninput="state.meta.inv=this.value; save()"><label style="font-size:10px; font-weight:bold;">ADRES:</label><input class="input" style="margin-bottom:15px" value="${state.meta.adr}" oninput="state.meta.adr=this.value; save()"><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><input class="input" type="date" value="${state.meta.date}" oninput="state.meta.date=this.value; save()"><input class="input" placeholder="Klient" value="${state.meta.cli}" oninput="state.meta.cli=this.value; save()"></div></div><div style="width:100%; height:85mm; background:#eee; margin-top:30px; border-radius:10px; overflow:hidden; cursor:pointer; border:1px solid #ddd;" onclick="handleImgUpload('main')">${state.meta.mainImg ? `<img src="${state.meta.mainImg}" style="width:100%; height:100%; object-fit:cover;">` : 'DODAJ ZDJĘCIE GŁÓWNE'}</div>`;
        cover.appendChild(coverBody); root.appendChild(cover);
        let summaryData = {};
        state.floors.forEach((f, fi) => {
            const fPage = createPage(f.name);
            fPage.innerHTML += `<div class="plan-box" onclick="addDot(event, ${fi})">${f.plan ? `<img src="${f.plan}" class="plan-img rot-${f.rotation || 0}">` : 'KLIKNIJ, ABY WGRAĆ RZUT PIĘTRA'}${f.defects.map((d, di) => `<div class="dot c-${d.status}" style="left:${d.x}%; top:${d.y}%;" onclick="event.stopPropagation(); openPoint(${fi}, ${di})">${di+1}</div>`).join('')}</div><div class="no-print" style="padding:10px; display:flex; gap:10px; justify-content:center;"><button class="btn" style="background:#333" onclick="rotateFloor(${fi})">OBRÓĆ ↻</button><button class="btn" style="background:#c0392b" onclick="deleteFloor(${fi})">USUŃ PIĘTRO</button><input class="input" style="width:150px; height:35px;" value="${f.name}" onchange="state.floors[${fi}].name=this.value; save(); render()"></div>`;
            root.appendChild(fPage);
            f.defects.forEach((d, di) => {
                const room = d.room || "Nieokreślone";
                if(!summaryData[room]) summaryData[room] = {};
                if(d.checks) { for(let k in d.checks) if(d.checks[k]) summaryData[room][k] = true; }
                if(room.toLowerCase().includes(filter)) {
                    const dPage = createPage(`USTERKA NR ${di+1}`);
                    dPage.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:flex-start;"><h2 style="margin:0; color:var(--accent); text-transform:uppercase">${room} - PUNKT ${di+1}</h2><span class="btn c-${d.status}">${d.status.replace('_',' ')}</span></div><div style="background:#f4f4f4; padding:20px; border-radius:8px; margin:15px 0;"><div style="font-weight:bold; margin-bottom:5px;">OPIS:</div><div style="font-size:16px;">${d.desc || 'Brak opisu.'}</div>${d.norm ? `<div style="margin-top:10px; color:red; font-size:11px; border-top:1px dashed #ccc; padding-top:5px;">NORMA: ${d.norm}</div>` : ''}</div><div style="flex-grow:1; display:flex; justify-content:center; align-items:center; border:1px solid #eee; overflow:hidden; border-radius:8px;">${d.img ? `<img src="${d.img}" style="max-width:100%; max-height:145mm; object-fit:contain;">` : 'Brak zdjęcia.'}</div>`;
                    root.appendChild(dPage);
                }
            });
        });
        const summary = createPage("PROTOKÓŁ WERYFIKACJI");
        summary.innerHTML += `<h2 style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px;">ZBIORCZA LISTA KONTROLNA</h2>`;
        for (const [room, checks] of Object.entries(summaryData)) {
            let html = `<div style="border:1px solid #333; margin-top:10px; break-inside:avoid;"><div style="background:#333; color:white; padding:5px 10px; font-weight:bold;">${room}</div>`;
            for (const [cat, items] of Object.entries(config.checklist)) {
                html += `<div style="font-size:10px; font-weight:bold; padding:5px 10px 0; color:var(--accent)">${cat}</div><div style="display:grid; grid-template-columns:1fr 1fr 1fr; padding:5px 10px 10px;">`;
                items.forEach(it => {
                    const isOk = checks[`${cat}:${it}`];
                    html += `<div style="font-size:10px; display:flex; align-items:center; gap:5px;"><div style="width:12px; height:12px; border:1px solid #000; display:flex; align-items:center; justify-content:center; font-weight:bold;">${isOk?'✓':''}</div>${it}</div>`;
                });
                html += `</div>`;
            }
            summary.innerHTML += html + `</div>`;
        }
        summary.innerHTML += `<div style="margin-top:auto; display:flex; justify-content:space-between; padding:50px 0 20px;"><div style="width:40%; border-top:1px solid #000; text-align:center; font-size:12px; padding-top:5px;">Podpis Inżyniera</div><div style="width:40%; border-top:1px solid #000; text-align:center; font-size:12px; padding-top:5px;">Podpis Klienta</div></div>`;
        root.appendChild(summary); updateDatalists();
    }
    function addDot(e, fi) {
        if(!state.floors[fi].plan) return handleImgUpload('plan', fi);
        const rect = e.currentTarget.getBoundingClientRect();
        const di = state.floors[fi].defects.length;
        state.floors[fi].defects.push({ x: ((e.clientX - rect.left) / rect.width) * 100, y: ((e.clientY - rect.top) / rect.height) * 100, room: config.lastRoom || '', desc: '', norm: '', status: 'to_discuss', img: '', checks: {} });
        save(); render(); openPoint(fi, di);
    }
    function openPoint(fi, di) {
        active = { fIdx: fi, dIdx: di }; const d = state.floors[fi].defects[di];
        document.getElementById('m-title').innerText = `Punkt ${di+1}`;
        document.getElementById('m-room').value = d.room; document.getElementById('m-desc').value = d.desc; document.getElementById('m-norm').value = d.norm;
        document.getElementById('m-img-box').innerHTML = d.img ? `<img src="${d.img}" style="height:100%">` : 'Dodaj zdjęcie';
        const list = document.getElementById('m-check-list'); list.innerHTML = '';
        for (const [cat, items] of Object.entries(config.checklist)) {
            list.innerHTML += `<div style="font-weight:bold; font-size:10px; margin-top:8px;">${cat}</div>`;
            items.forEach(it => {
                const key = `${cat}:${it}`;
                list.innerHTML += `<label style="display:block; font-size:13px; padding:4px 0;"><input type="checkbox" ${d.checks[key]?'checked':''} onchange="toggleCheck('${key}')"> ${it}</label>`;
            });
        }
        document.getElementById('overlay').style.display = 'block'; document.getElementById('edit-modal').style.display = 'block';
        setTimeout(() => document.getElementById('m-desc').focus(), 300);
    }
    function updateActivePoint(field, val) {
        state.floors[active.fIdx].defects[active.dIdx][field] = val;
        if(field === 'room') { config.lastRoom = val; if(val && !config.rooms.includes(val)) config.rooms.push(val); }
        save();
    }
    function toggleCheck(key) { state.floors[active.fIdx].defects[active.dIdx].checks[key] = !state.floors[active.fIdx].defects[active.dIdx].checks[key]; save(); }
    function handleImgUpload(type, fi) {
        const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
        input.onchange = e => {
            const reader = new FileReader(); reader.onload = ev => {
                const base64 = ev.target.result;
                if(type === 'logo') config.logo = base64;
                else if(type === 'main') state.meta.mainImg = base64;
                else if(type === 'plan') state.floors[fi].plan = base64;
                else if(type === 'defect') { state.floors[active.fIdx].defects[active.dIdx].img = base64; document.getElementById('m-img-box').innerHTML = `<img src="${base64}" style="height:100%">`; }
                save(); render();
            }; reader.readAsDataURL(e.target.files[0]);
        }; input.click();
    }
    function rotateFloor(fi) { state.floors[fi].rotation = ((state.floors[fi].rotation || 0) + 90) % 360; save(); render(); }
    function addFloor() { state.floors.push({ name: 'PIĘTRO '+(state.floors.length+1), plan: '', defects: [], rotation: 0 }); save(); render(); }
    function deleteFloor(fi) { if(confirm("Usunąć całe piętro?")) { state.floors.splice(fi,1); save(); render(); } }
    function deletePoint() { if(confirm("Usunąć ten punkt?")) { state.floors[active.fIdx].defects.splice(active.dIdx,1); closeModal(); } }
    function closeModal() { document.querySelectorAll('.modal, .modal-overlay').forEach(m => m.style.display='none'); render(); }
    function updateDatalists() { document.getElementById('room-presets').innerHTML = config.rooms.map(r => `<option value="${r}">`).join(''); }
    function toggleSettings(show) { if(show) { let txt = ""; for(let [k,v] of Object.entries(config.checklist)) txt += `${k}: ${v.join(', ')}\n`; document.getElementById('set-check-raw').value = txt; document.getElementById('overlay').style.display='block'; document.getElementById('settings-modal').style.display='block'; } }
    function saveSettings() {
        const lines = document.getElementById('set-check-raw').value.split('\n'); config.checklist = {};
        lines.forEach(l => { if(l.includes(':')) { const [k, v] = l.split(':'); config.checklist[k.trim()] = v.split(',').map(x => x.trim()).filter(x => x); } });
        save(); closeModal();
    }
    function exportData() { const blob = new Blob([JSON.stringify(state)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Raport_${state.meta.inv || 'Export'}.json`; a.click(); }
    function importData(e) { const reader = new FileReader(); reader.onload = ev => { state = JSON.parse(ev.target.result); save(); render(); }; reader.readAsText(e.target.files[0]); }
    function resetApp() { if(confirm("CZYŚCISZ WSZYSTKO?")) { state = { meta:{inv:'', adr:'', date:'', cli:'', mainImg:''}, floors:[] }; addFloor(); save(); render(); } }
    if(!state.floors.length) addFloor();
    render();
</script>
</body>
</html>