<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>SYSTEM RAPORTOWANIA v19.19 PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a252f">
    <link rel="manifest" href="manifest.json">
    
    <style>
        :root { --rep: #e67e22; --nrep: #2c3e50; --none: #95a5a6; --main: #1a252f; --bg: #f8f9fa; --highlight: #3498db; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); margin: 0; padding-top: 110px; color: #333; }
        
        /* UI Elements */
        .toolbar { position: fixed; top: 0; left: 0; width: 100%; height: 50px; background: var(--main); color: #fff; display: flex; align-items: center; justify-content: center; gap: 8px; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .filter-bar { position: fixed; top: 50px; left: 0; width: 100%; height: 55px; background: #ecf0f1; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 5px; z-index: 9998; border-bottom: 1px solid #dcdde1; padding: 5px; }
        
        .btn { padding: 8px 12px; border: none; cursor: pointer; font-weight: 600; border-radius: 5px; font-size: 11px; text-transform: uppercase; color: #fff; transition: opacity 0.2s; white-space: nowrap; }
        .btn:hover { opacity: 0.9; }
        
        .input-filter { padding: 5px; font-size: 11px; border: 1px solid #bdc3c7; border-radius: 4px; width: 30%; min-width: 100px; }
        .select-filter { padding: 5px; font-size: 11px; border: 1px solid #bdc3c7; border-radius: 4px; }

        /* Print Pages */
        .page { width: 210mm; height: 296mm; background: #fff; margin: 0 auto 20px; padding: 15mm; position: relative; display: flex; flex-direction: column; page-break-after: always; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header-info { font-size: 9px; color: #95a5a6; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; height: 12mm; }
        .mini-logo { max-height: 10mm; max-width: 40mm; object-fit: contain; }
        .footer-info { position: absolute; bottom: 8mm; left: 15mm; right: 15mm; border-top: 1px solid #eee; padding-top: 5px; }
        .footer-row { display: flex; justify-content: flex-end; font-size: 9px; color: #bdc3c7; font-weight: 700; }
        .legal-note { font-size: 7.5px; color: #bdc3c7; font-style: italic; text-align: justify; line-height: 1.2; margin-bottom: 2px; }

        /* Report Elements */
        .logo-box { height: 35mm; width: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer; margin-bottom: 10px; }
        .logo-box img { max-height: 100%; max-width: 100%; object-fit: contain; }
        .main-img-box { width: 100%; height: 100mm; background: #fdfdfd; border: 1px dashed #dcdde1; border-radius: 8px; display: flex; justify-content: center; align-items: center; margin-top: 15px; cursor: pointer; overflow: hidden; }
        .main-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .info-label { font-weight: 700; color: #7f8c8d; font-size: 11px; background: #f8f9fa; padding: 6px 12px; border-radius: 4px; border: 1px solid #eee; display: block; width: 100%; margin-bottom: 8px; font-family: inherit; }

        .plan-wrapper { width: 100%; height: 180mm; background: #fafafa; border: 1px solid #e1e1e1; border-radius: 8px; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: crosshair; }
        .plan-img { transition: transform 0.3s; max-width: 90%; max-height: 90%; pointer-events: none; }
        .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }
        .dot { position: absolute; width: 26px; height: 26px; border-radius: 50%; border: 2.5px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; transform: translate(-50%, -50%); font-weight: 800; font-size: 11px; z-index: 100; box-shadow: 0 3px 8px rgba(0,0,0,0.3); transition: transform 0.1s; }
        .dot:active { transform: translate(-50%, -50%) scale(1.2); }

        .grid-table { width: 100%; flex-grow: 1; border-collapse: separate; border-spacing: 0 15px; table-layout: fixed; }
        .grid-table td { width: 100%; height: 120mm; border: 1px solid #edf2f7; border-radius: 8px; padding: 15px; vertical-align: top; background: #fff; position: relative; transition: border-color 0.2s; }
        /* Edycja z listy - kursor */
        .grid-table td:hover { border-color: var(--highlight); cursor: pointer; } 
        
        .desc-text { font-size: 13px; font-weight: 700; line-height: 1.4; color: var(--main); margin-bottom: 8px; white-space: pre-wrap; }
        .q-photo { width: 100%; height: 85mm; background: #f8f9fa; border-radius: 6px; display: flex; justify-content: center; align-items: center; margin-top: 5px; border: 1px solid #f1f1f1; overflow: hidden; }
        .q-photo img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .status-badge { padding: 4px 10px; border-radius: 4px; font-weight: 700; font-size: 10px; color: white; margin-bottom: 5px; display: inline-block; }
        .meta-line { font-size: 10px; color: #7f8c8d; margin-bottom: 4px; display: flex; gap: 10px; }

        /* Modal */
        #ov { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 37, 47, 0.85); z-index: 10000; }
        #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; border-radius: 12px; z-index: 10001; width: 95%; max-width: 500px; max-height: 98vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .modal-label { font-size: 11px; font-weight: 700; color: #7f8c8d; margin-bottom: 4px; display: block; }
        .modal-field { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-family: inherit; font-size: 14px; }
        .modal-photo-preview { width: 100%; height: 160px; background: #f8f9fa; border: 2px dashed #cbd5e0; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: center; align-items: center; cursor: pointer; overflow: hidden; }
        .modal-photo-preview img { width: 100%; height: 100%; object-fit: contain; }

        .check-item { display: flex; align-items: center; gap: 8px; font-size: 13px; padding: 6px 0; border-bottom: 1px solid #f1f1f1; cursor: pointer; }
        .check-item input { width: 18px; height: 18px; cursor: pointer; }

        .c-rep { background: var(--rep); color: #fff; }
        .c-nrep { background: var(--nrep); color: #fff; }
        .c-none { background: var(--none); color: #fff; }

        @media print { .no-print { display: none !important; } body { padding: 0; background: #fff; } .page { margin: 0; box-shadow: none; border: none; } }
    </style>
</head>
<body>

<datalist id="room-list"></datalist>
<datalist id="cat-list"></datalist>
<datalist id="norm-list"></datalist>

<div class="toolbar no-print">
    <button class="btn" style="background:#27ae60" onclick="addFloor()">+ Piƒôtro</button>
    <button class="btn" style="background:#2980b9" onclick="exportData()">Zapisz</button>
    <button class="btn" style="background:#e67e22" onclick="document.getElementById('import-file').click()">Wczytaj</button>
    <button class="btn" style="background:#e74c3c" onclick="window.print()">PDF</button>
    <button class="btn" style="background:#34495e" onclick="resetApp()">Nowy</button>
</div>

<div class="filter-bar no-print">
    <select id="f-status" class="select-filter" onchange="render()">
        <option value="all">Status: Wszystkie</option>
        <option value="reported">Zg≈Çoszone</option>
        <option value="not_reported">Niezg≈Çoszone</option>
        <option value="to_discuss">Uwagi</option>
    </select>
    <select id="f-cat" class="select-filter" onchange="render()">
        <option value="all">Kat: Wszystkie</option>
        </select>
    <input id="f-room" class="input-filter" placeholder="Pomieszczenie..." oninput="render()">
    <input id="f-text" class="input-filter" placeholder="Szukaj w opisie..." oninput="render()">
</div>

<input type="file" id="import-file" style="display:none" onchange="importData(event)">
<div id="ov" onclick="closeAllModals()"></div>

<div id="modal">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 id="m-title" style="margin:0; color:var(--main); font-size: 16px;">EDYCJA</h3>
        <button onclick="closeAllModals()" style="background:none; border:none; font-size:20px;">‚úï</button>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div>
            <span class="modal-label">POMIESZCZENIE</span>
            <input id="m-room" class="modal-field" list="room-list" placeholder="np. Salon">
        </div>
        <div>
            <span class="modal-label">KATEGORIA</span>
            <input id="m-cat" class="modal-field" list="cat-list" placeholder="np. Tynki">
        </div>
    </div>

    <div class="modal-photo-preview" onclick="uploadImg('report', active.f, active.d)" id="m-photo-box"></div>
    
    <span class="modal-label">OPIS USTERKI / UWAGI (Autofocus)</span>
    <textarea id="m-desc" class="modal-field" style="height:70px" placeholder="Opisz problem..."></textarea>

    <span class="modal-label">NORMA / STANDARD</span>
    <input id="m-norm" class="modal-field" list="norm-list" placeholder="np. Odchy≈Çka > 3mm">

    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
        <b style="display:block; margin-bottom:5px; font-size: 11px; color: var(--main);">CHECKLISTA:</b>
        <div style="display:flex; gap:15px;">
            <label><input type="checkbox" id="chk-katy"> KƒÖty</label>
            <label><input type="checkbox" id="chk-plaszczyzny"> P≈Çaszczyzny</label>
            <label><input type="checkbox" id="chk-stan"> Stan</label>
        </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-bottom:15px;">
        <button class="btn c-rep" onclick="setStatus('reported')">ZG≈ÅOSZONE</button>
        <button class="btn c-nrep" onclick="setStatus('not_reported')">NIEZG≈ÅO≈ö.</button>
        <button class="btn c-none" onclick="setStatus('to_discuss')">UWAGI</button>
    </div>
    
    <button class="btn" style="background:#c0392b; width:100%" onclick="deleteReport()">USU≈É PUNKT</button>
</div>

<div id="app"></div>

<script>
    // --- KONFIGURACJA i PAMIƒòƒÜ (Auto-Learning) ---
    const DEFAULT_CONFIG = {
        rooms: ['Salon', 'Kuchnia', '≈Åazienka', 'Sypialnia', 'Hol', 'Balkon'],
        cats: ['Tynki', 'Wylewki', 'Okna', 'Drzwi', 'Elektryka', 'Hydraulika'],
        norms: ['Zgodne z normƒÖ', 'Odchy≈Çka > 2mm', 'Rysa widoczna z 2m', 'Brak kƒÖta 90 stopni']
    };
    
    let appConfig = JSON.parse(localStorage.getItem('appConfig')) || DEFAULT_CONFIG;
    
    function saveConfig() { localStorage.setItem('appConfig', JSON.stringify(appConfig)); updateDataLists(); }
    
    function updateDataLists() {
        // Generowanie list podpowiedzi
        const makeOptions = (arr) => arr.map(x => `<option value="${x}">`).join('');
        document.getElementById('room-list').innerHTML = makeOptions(appConfig.rooms);
        document.getElementById('cat-list').innerHTML = makeOptions(appConfig.cats);
        document.getElementById('norm-list').innerHTML = makeOptions(appConfig.norms);
        
        // Aktualizacja filtra kategorii
        const catFilter = document.getElementById('f-cat');
        catFilter.innerHTML = '<option value="all">Kat: Wszystkie</option>' + 
                              appConfig.cats.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    
    function learnNewData(room, cat, norm) {
        let changed = false;
        if(room && !appConfig.rooms.includes(room)) { appConfig.rooms.push(room); changed = true; }
        if(cat && !appConfig.cats.includes(cat)) { appConfig.cats.push(cat); changed = true; }
        if(norm && !appConfig.norms.includes(norm)) { appConfig.norms.push(norm); changed = true; }
        if(changed) saveConfig();
    }

    // --- LOGIKA G≈Å√ìWNA ---
    let state = { meta: { inv:'', adr:'', date:'', cli:'' }, logo: '', mainImg: '', floors: [] };
    let active = { f: null, d: null };
    const LEGAL_TEXT = "Dokumentacja stanu technicznego w dniu kontroli.";

    // Ochrona przed od≈õwie≈ºeniem
    window.onbeforeunload = function() { return "Dane mogƒÖ zostaƒá utracone. Czy na pewno?"; };

    function closeAllModals() {
        if (document.getElementById('modal').style.display === 'block') {
            const d = state.floors[active.f].defects[active.d];
            if(d) {
                d.room = document.getElementById('m-room').value;
                d.cat = document.getElementById('m-cat').value;
                d.desc = document.getElementById('m-desc').value;
                d.norm = document.getElementById('m-norm').value;
                d.checks = {
                    katy: document.getElementById('chk-katy').checked,
                    plaszczyzny: document.getElementById('chk-plaszczyzny').checked,
                    stan: document.getElementById('chk-stan').checked
                };
                learnNewData(d.room, d.cat, d.norm); // Uczymy siƒô nowych s≈Ç√≥w
            }
        }
        document.getElementById('ov').style.display = 'none';
        document.getElementById('modal').style.display = 'none';
        render();
    }

    function openModal(fi, di) {
        active = { f: fi, d: di }; const d = state.floors[fi].defects[di];
        document.getElementById('m-title').innerText = "EDYCJA PUNKTU " + (di + 1);
        document.getElementById('m-room').value = d.room || '';
        document.getElementById('m-cat').value = d.cat || '';
        document.getElementById('m-desc').value = d.desc || ''; 
        document.getElementById('m-norm').value = d.norm || '';
        document.getElementById('chk-katy').checked = d.checks?.katy || false;
        document.getElementById('chk-plaszczyzny').checked = d.checks?.plaszczyzny || false;
        document.getElementById('chk-stan').checked = d.checks?.stan || false;
        document.getElementById('m-photo-box').innerHTML = d.img ? `<img src="${d.img}" style="width:100%;height:100%;object-fit:contain">` : 'DODAJ ZDJƒòCIE';
        document.getElementById('ov').style.display = 'block'; 
        document.getElementById('modal').style.display = 'block';
        
        // Autofocus na opis
        setTimeout(() => document.getElementById('m-desc').focus(), 150);
    }

    function addDot(e, fi) {
        if (!state.floors[fi].plan) return uploadImg('plan', fi);
        const r = e.currentTarget.getBoundingClientRect();
        const di = state.floors[fi].defects.length;
        state.floors[fi].defects.push({ 
            x: ((e.clientX - r.left)/r.width)*100, 
            y: ((e.clientY - r.top)/r.height)*100, 
            desc: '', room: '', cat: '', norm: '', 
            status: 'to_discuss', img: '', checks:{} 
        });
        render(); openModal(fi, di);
    }

    // --- RESZTA FUNKCJI (Upload, Export, Render) ---
    function uploadImg(type, fi, di) {
        const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
        input.onchange = e => {
            const reader = new FileReader();
            reader.onload = ev => {
                if(type==='logo') state.logo = ev.target.result;
                else if(type==='main') state.mainImg = ev.target.result;
                else if(type==='plan') state.floors[fi].plan = ev.target.result;
                else if(type==='report') { state.floors[fi].defects[di].img = ev.target.result; render(); openModal(fi, di); }
                render();
            };
            reader.readAsDataURL(e.target.files[0]);
        };
        input.click();
    }

    function exportData() {
        const fileName = `Raport_${state.meta.inv || 'projekt'}.json`;
        const blob = new Blob([JSON.stringify(state)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = fileName;
        document.body.appendChild(a); a.click();
        setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 100);
    }

    function importData(e) {
        const r = new FileReader();
        r.onload = ev => { state = JSON.parse(r.result); render(); };
        r.readAsText(e.target.files[0]);
    }

    function resetApp() {
        if(confirm("Czy na pewno chcesz zaczƒÖƒá nowy raport? Obecne dane zostanƒÖ wyczyszczone.")) {
            state = { meta: { inv:'', adr:'', date:'', cli:'' }, logo: '', mainImg: '', floors: [] };
            addFloor();
            render();
        }
    }

    function rotatePlan(fi) { state.floors[fi].rotation = ((state.floors[fi].rotation || 0) + 90) % 360; render(); }
    function addFloor() { state.floors.push({ name: 'Kondygnacja ' + (state.floors.length + 1), plan: '', defects: [], rotation: 0 }); render(); }
    function deleteFloor(fi) { if(confirm("UsunƒÖƒá piƒôtro?")) { state.floors.splice(fi, 1); render(); } }
    function setStatus(s) { state.floors[active.f].defects[active.d].status = s; closeAllModals(); }
    function deleteReport() { if(confirm("UsunƒÖƒá punkt?")) { state.floors[active.f].defects.splice(active.d, 1); closeAllModals(); } }

    function render() {
        const fStatus = document.getElementById('f-status').value;
        const fCat = document.getElementById('f-cat') ? document.getElementById('f-cat').value : 'all';
        const fRoom = document.getElementById('f-room').value.toLowerCase();
        const fText = document.getElementById('f-text').value.toLowerCase();
        
        const root = document.getElementById('app'); root.innerHTML = '';
        let pTotal = 1 + state.floors.length + state.floors.reduce((a, f) => a + Math.ceil(f.defects.length / 2), 0);
        let pNum = 0;

        function getP() {
            pNum++; const p = document.createElement('div'); p.className = 'page';
            p.innerHTML = `<div class="header-info"><div>RAPORT: ${state.meta.inv || '...'}</div>${state.logo ? `<img src="${state.logo}" class="mini-logo">` : ''}</div>
                           <div class="footer-info"><div class="legal-note">${LEGAL_TEXT}</div><div class="footer-row">STRONA ${pNum} / ${pTotal}</div></div>`;
            return p;
        }

        const cover = document.createElement('div'); cover.className = 'page'; pNum++;
        cover.innerHTML = `<div class="logo-box" onclick="uploadImg('logo')">${state.logo ? `<img src="${state.logo}">` : 'DODAJ LOGO'}</div>
            <h1 style="text-align:center; margin-bottom: 30px;">PROTOK√ì≈Å ODBIORU</h1>
            <div style="margin: 20px 0;">
                <input class="info-label" placeholder="Nazwa Inwestycji" value="${state.meta.inv}" oninput="state.meta.inv=this.value">
                <input class="info-label" placeholder="Adres" value="${state.meta.adr}" oninput="state.meta.adr=this.value">
                <input class="info-label" type="date" value="${state.meta.date}" oninput="state.meta.date=this.value">
                <input class="info-label" placeholder="ZamawiajƒÖcy" value="${state.meta.cli}" oninput="state.meta.cli=this.value">
            </div>
            <div class="main-img-box" onclick="uploadImg('main')">${state.mainImg ? `<img src="${state.mainImg}">` : 'ZDJƒòCIE G≈Å√ìWNE'}</div>`;
        root.appendChild(cover);

        state.floors.forEach((f, fi) => {
            // Logika filtrowania
            const visibleDefects = f.defects.filter(d => {
                const sOk = fStatus === 'all' || d.status === fStatus;
                const cOk = fCat === 'all' || d.cat === fCat;
                const rOk = (d.room || '').toLowerCase().includes(fRoom);
                const tOk = (d.desc || '').toLowerCase().includes(fText) || (d.norm || '').toLowerCase().includes(fText);
                return sOk && cOk && rOk && tOk;
            });

            const fPage = getP();
            fPage.innerHTML += `<h3>${f.name}</h3><div class="plan-wrapper" onclick="addDot(event, ${fi})">
                ${f.plan ? `<img src="${f.plan}" class="plan-img rot-${f.rotation}">` : 'WGRAJ RZUT'}
                ${visibleDefects.map(d => {
                    const realIndex = f.defects.indexOf(d);
                    return `<div class="dot ${d.status==='reported'?'c-rep':(d.status==='not_reported'?'c-nrep':'c-none')}" style="left:${d.x}%; top:${d.y}%" onclick="event.stopPropagation(); openModal(${fi},${realIndex})">${realIndex+1}</div>`;
                }).join('')}
            </div><div class="no-print" style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn" style="background:#000" onclick="rotatePlan(${fi})">OBR√ìƒÜ</button>
                <button class="btn" style="background:#c0392b" onclick="deleteFloor(${fi})">USU≈É PIƒòTRO</button>
            </div>`;
            root.appendChild(fPage);

            // Generowanie tabel
            for (let i = 0; i < visibleDefects.length; i += 2) {
                const dPage = getP();
                const table = document.createElement('table'); table.className = 'grid-table';
                let html = '';
                for (let j = 0; j < 2; j++) {
                    const idx = i + j;
                    if (idx < visibleDefects.length) {
                        const d = visibleDefects[idx];
                        const realIndex = f.defects.indexOf(d);
                        
                        let checks = [];
                        if(d.checks?.katy) checks.push("KƒÖty");
                        if(d.checks?.plaszczyzny) checks.push("P≈Çaszczyzny");
                        if(d.checks?.stan) checks.push("Stan");

                        // TUTAJ dodajemy onclick do ca≈Çej kom√≥rki
                        html += `<tr><td onclick="openModal(${fi}, ${realIndex})">
                                 <div class="meta-line">
                                    <span class="status-badge ${d.status==='reported'?'c-rep':(d.status==='not_reported'?'c-nrep':'c-none')}">NR ${realIndex+1}</span>
                                    ${d.room ? `<span>üìç ${d.room}</span>` : ''}
                                    ${d.cat ? `<span>üîß ${d.cat}</span>` : ''}
                                 </div>
                                 <div class="desc-text">${d.desc || ''}</div>
                                 ${d.norm ? `<div style="font-size:11px; color:#c0392b; margin-top:4px;"><b>Norma:</b> ${d.norm}</div>` : ''}
                                 ${checks.length > 0 ? `<div style="font-size:10px; color:#7f8c8d; margin-top:4px;"><b>Sprawdzono:</b> ${checks.join(', ')}</div>` : ''}
                                 <div class="q-photo">${d.img ? `<img src="${d.img}">` : ''}</div></td></tr>`;
                    }
                }
                table.innerHTML = html; dPage.appendChild(table); root.appendChild(dPage);
            }
        });
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js?v=' + Date.now()).then(reg => reg.update());
        });
    }

    updateDataLists(); // Inicjalizacja list
    if(!state.floors.length) addFloor();
    render();
</script>
</body>
</html>