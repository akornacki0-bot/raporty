<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>SYSTEM RAPORTOWANIA v19.22 ROOM-PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    
    <style>
        :root { --rep: #e67e22; --nrep: #2c3e50; --none: #95a5a6; --main: #1a252f; --bg: #f8f9fa; --highlight: #3498db; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); margin: 0; padding-top: 110px; color: #333; }
        
        /* Toolbar & Filters */
        .toolbar { position: fixed; top: 0; left: 0; width: 100%; height: 50px; background: var(--main); color: #fff; display: flex; align-items: center; justify-content: center; gap: 8px; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .filter-bar { position: fixed; top: 50px; left: 0; width: 100%; height: 55px; background: #ecf0f1; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 5px; z-index: 9998; border-bottom: 1px solid #dcdde1; padding: 5px; }
        .btn { padding: 8px 12px; border: none; cursor: pointer; font-weight: 600; border-radius: 5px; font-size: 11px; text-transform: uppercase; color: #fff; }
        .input-filter { padding: 5px; font-size: 11px; border: 1px solid #bdc3c7; border-radius: 4px; width: 20%; }

        /* PDF Pages */
        .page { width: 210mm; min-height: 296mm; background: #fff; margin: 0 auto 20px; padding: 15mm; position: relative; display: flex; flex-direction: column; page-break-after: always; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header-info { font-size: 9px; color: #95a5a6; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .mini-logo { max-height: 10mm; max-width: 40mm; object-fit: contain; }
        .footer-info { position: absolute; bottom: 8mm; left: 15mm; right: 15mm; border-top: 1px solid #eee; padding-top: 5px; font-size: 9px; text-align: right; color: #bdc3c7; }

        /* Checklist PDF Styling */
        .room-section { margin-top: 15px; border: 1px solid #eee; padding: 10px; border-radius: 5px; break-inside: avoid; }
        .room-title { background: #2c3e50; color: white; padding: 5px 10px; font-size: 14px; font-weight: bold; margin: -10px -10px 10px -10px; border-radius: 4px 4px 0 0; }
        .check-cat-pdf { font-size: 11px; font-weight: bold; margin: 8px 0 3px 0; color: #e67e22; text-transform: uppercase; border-bottom: 1px solid #f1f1f1; }
        .check-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 15px; }
        .check-item-pdf { font-size: 10px; display: flex; align-items: center; gap: 5px; padding: 1px 0; }
        .box { width: 11px; height: 11px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; flex-shrink: 0; }

        /* Map & Dots */
        .plan-wrapper { width: 100%; height: 180mm; background: #fafafa; border: 1px solid #e1e1e1; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .dot { position: absolute; width: 24px; height: 24px; border-radius: 50%; border: 2px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; transform: translate(-50%, -50%); font-weight: bold; font-size: 10px; z-index: 100; cursor: pointer; }
        
        /* Modal & UI */
        #ov { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; }
        #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; border-radius: 12px; z-index: 10001; width: 95%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-field { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .checklist-editor { background: #f9f9f9; padding: 10px; border-radius: 5px; border: 1px solid #ddd; }
        .check-row { display: flex; align-items: center; gap: 10px; padding: 5px 0; border-bottom: 1px solid #eee; cursor: pointer; }

        .c-rep { background: var(--rep); } .c-nrep { background: var(--nrep); } .c-none { background: var(--none); }
        @media print { .no-print { display: none !important; } .page { margin: 0; box-shadow: none; } body { padding: 0; } }
    </style>
</head>
<body>

<div class="toolbar no-print">
    <button class="btn" style="background:#27ae60" onclick="addFloor()">+ Piętro</button>
    <button class="btn" style="background:#2980b9" onclick="exportData()">Zapisz Plik</button>
    <button class="btn" style="background:#e67e22" onclick="document.getElementById('import-file').click()">Wczytaj</button>
    <button class="btn" style="background:#8e44ad" onclick="openSettings()">Ustawienia Listy</button>
    <button class="btn" style="background:#e74c3c" onclick="window.print()">Generuj PDF</button>
    <button class="btn" style="background:#34495e" onclick="resetApp()">Nowy Projekt</button>
</div>

<div class="filter-bar no-print">
    <input id="f-room" class="input-filter" placeholder="Pokój..." oninput="render()">
    <input id="f-text" class="input-filter" placeholder="Szukaj usterki..." oninput="render()">
</div>

<input type="file" id="import-file" style="display:none" onchange="importData(event)">
<div id="ov" onclick="closeAllModals()"></div>

<div id="modal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 id="m-title">PUNKT</h3>
        <button onclick="closeAllModals()" style="border:none; background:none; font-size:24px;">×</button>
    </div>
    
    <label style="font-size:10px; font-weight:bold;">POMIESZCZENIE</label>
    <input id="m-room" class="modal-field" list="room-list" onchange="updateActiveData('room', this.value)">
    
    <label style="font-size:10px; font-weight:bold;">KATEGORIA</label>
    <input id="m-cat" class="modal-field" list="cat-list" onchange="updateActiveData('cat', this.value)">

    <div id="m-photo-box" style="width:100%; height:150px; background:#eee; display:flex; justify-content:center; align-items:center; cursor:pointer; margin-bottom:10px; overflow:hidden;" onclick="uploadImg('report', active.f, active.d)">
        Kliknij by dodać zdjęcie
    </div>

    <label style="font-size:10px; font-weight:bold;">OPIS USTERKI</label>
    <textarea id="m-desc" class="modal-field" style="height:60px;" oninput="updateActiveData('desc', this.value)"></textarea>

    <label style="font-size:10px; font-weight:bold;">NORMA</label>
    <input id="m-norm" class="modal-field" list="norm-list" onchange="updateActiveData('norm', this.value)">

    <label style="font-size:10px; font-weight:bold;">CHECKLISTA DLA TEGO POMIESZCZENIA:</label>
    <div id="m-checklist-area" class="checklist-editor"></div>

    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-top:15px;">
        <button class="btn c-rep" onclick="updateActiveData('status', 'reported'); closeAllModals()">ZGŁOSZ.</button>
        <button class="btn c-nrep" onclick="updateActiveData('status', 'not_reported'); closeAllModals()">NIEZGŁ.</button>
        <button class="btn c-none" onclick="updateActiveData('status', 'to_discuss'); closeAllModals()">UWAGI</button>
    </div>
</div>

<div id="settings-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; z-index:10002; width:90%; max-width:450px; border-radius:8px; box-shadow:0 0 20px rgba(0,0,0,0.5);">
    <h3>Konfiguracja Checklisty</h3>
    <textarea id="set-checklist-json" class="modal-field" style="height:300px; font-family:monospace; font-size:11px;"></textarea>
    <button class="btn" style="background:#27ae60; width:100%;" onclick="saveSettings()">ZAPISZ</button>
    <button class="btn" style="background:#95a5a6; width:100%; margin-top:5px;" onclick="document.getElementById('settings-modal').style.display='none'">ANULUJ</button>
</div>

<div id="app"></div>

<datalist id="room-list"></datalist>
<datalist id="cat-list"></datalist>
<datalist id="norm-list"></datalist>

<script>
    const INITIAL_CHECKLIST = {
        "Ściany i tynki": ["Kąty 90°", "Płaszczyzny", "Pionowość", "Brak rys", "Wilgotność"],
        "Posadzki": ["Poziom", "Dylatacje", "Brak spękań", "Glazura/Panele"],
        "Stolarka": ["Rysy na szybach", "Regulacja okien", "Uszczelki", "Parapety"],
        "Instalacje": ["Gniazdka", "Wentylacja", "Grzejniki", "Woda/Kanalizacja"]
    };

    let config = JSON.parse(localStorage.getItem('inspect_cfg_v22')) || {
        rooms: ['Salon', 'Kuchnia', 'Łazienka', 'Przedpokój'],
        cats: ['Tynki', 'Wylewki', 'Okna', 'Elektryka'],
        norms: ['Zgodne z normą', 'Odchyłka > 3mm', 'PN-EN 13914'],
        checklist: INITIAL_CHECKLIST,
        logo: ''
    };

    let state = { meta: { inv:'', adr:'', date:'', cli:'' }, floors: [] };
    let active = { f: null, d: null };

    function saveConfig() { localStorage.setItem('inspect_cfg_v22', JSON.stringify(config)); updateUILists(); }
    function updateUILists() {
        const h = (arr) => arr.map(x => `<option value="${x}">`).join('');
        document.getElementById('room-list').innerHTML = h(config.rooms);
        document.getElementById('cat-list').innerHTML = h(config.cats);
        document.getElementById('norm-list').innerHTML = h(config.norms);
    }
    function updateActiveData(field, val) {
        if(active.f === null) return;
        state.floors[active.f].defects[active.d][field] = val;
        if(field==='room' && !config.rooms.includes(val) && val) { config.rooms.push(val); saveConfig(); }
        if(field==='cat' && !config.cats.includes(val) && val) { config.cats.push(val); saveConfig(); }
    }
    function toggleCheck(cat, item) {
        if(active.f === null) return;
        const d = state.floors[active.f].defects[active.d];
        if(!d.checks) d.checks = {};
        const key = `${cat}:${item}`;
        d.checks[key] = !d.checks[key];
        renderChecklistInModal(d);
    }
    function openModal(fi, di) {
        active = { f: fi, d: di }; const d = state.floors[fi].defects[di];
        document.getElementById('m-title').innerText = `PUNKT ${di+1}`;
        document.getElementById('m-room').value = d.room || '';
        document.getElementById('m-cat').value = d.cat || '';
        document.getElementById('m-desc').value = d.desc || '';
        document.getElementById('m-norm').value = d.norm || '';
        document.getElementById('m-photo-box').innerHTML = d.img ? `<img src="${d.img}" style="height:100%">` : 'Dodaj zdjęcie';
        renderChecklistInModal(d);
        document.getElementById('ov').style.display = 'block';
        document.getElementById('modal').style.display = 'block';
    }
    function renderChecklistInModal(d) {
        const area = document.getElementById('m-checklist-area'); area.innerHTML = '';
        for (const [cat, items] of Object.entries(config.checklist)) {
            area.innerHTML += `<div style="font-weight:bold; font-size:11px; margin-top:8px; color:#2c3e50;">${cat}</div>`;
            items.forEach(item => {
                const isChecked = d.checks && d.checks[`${cat}:${item}`];
                area.innerHTML += `<div class="check-row" onclick="toggleCheck('${cat}', '${item}')">
                    <input type="checkbox" ${isChecked?'checked':''} onclick="event.stopPropagation(); toggleCheck('${cat}', '${item}')">
                    <span style="font-size:12px;">${item}</span></div>`;
            });
        }
    }
    function closeAllModals() { document.getElementById('ov').style.display='none'; document.getElementById('modal').style.display='none'; render(); }

    function render() {
        const root = document.getElementById('app'); root.innerHTML = '';
        let pageIdx = 1;
        const createPage = () => {
            const p = document.createElement('div'); p.className = 'page';
            p.innerHTML = `<div class="header-info"><span>${state.meta.inv || 'PROJEKT'}</span>${config.logo?`<img src="${config.logo}" class="mini-logo">`:''}</div>
                           <div class="footer-info">STRONA ${pageIdx++}</div>`;
            return p;
        };

        const cover = createPage();
        cover.innerHTML += `<div style="text-align:center; margin-top:30px;">
                ${config.logo?`<img src="${config.logo}" style="max-height:40mm;">`:`<div style="height:40mm; border:1px dashed #ccc; display:flex; align-items:center; justify-content:center;" onclick="uploadImg('logo')">WGRAJ LOGO</div>`}
                <h1 style="font-size:32px; margin:40px 0;">PROTOKÓŁ ODBIORU</h1>
            </div>
            <div>
                <input class="info-label" placeholder="Inwestycja..." value="${state.meta.inv}" oninput="state.meta.inv=this.value" style="width:100%; border:none; border-bottom:1px solid #eee; padding:10px; font-size:18px; font-weight:bold; text-align:center;">
                <table style="width:100%; margin-top:20px;">
                    <tr><td style="padding:10px; border-bottom:1px solid #eee;">ADRES:</td><td><input value="${state.meta.adr}" oninput="state.meta.adr=this.value" style="width:100%; border:none;"></td></tr>
                    <tr><td style="padding:10px; border-bottom:1px solid #eee;">DATA:</td><td><input type="date" value="${state.meta.date}" oninput="state.meta.date=this.value" style="width:100%; border:none;"></td></tr>
                    <tr><td style="padding:10px; border-bottom:1px solid #eee;">KLIENT:</td><td><input value="${state.meta.cli}" oninput="state.meta.cli=this.value" style="width:100%; border:none;"></td></tr>
                </table>
            </div>`;
        root.appendChild(cover);

        let roomChecks = {};
        state.floors.forEach((f, fi) => {
            const fPage = createPage();
            fPage.innerHTML += `<h2>${f.name}</h2>
                <div class="plan-wrapper" onclick="addDot(event, ${fi})">
                    ${f.plan ? `<img src="${f.plan}" style="max-width:90%; max-height:90%;">` : 'WGRAJ RZUT'}
                    ${f.defects.map((d, di) => `<div class="dot ${d.status==='reported'?'c-rep':(d.status==='not_reported'?'c-nrep':'c-none')}" 
                    style="left:${d.x}%; top:${d.y}%;" onclick="event.stopPropagation(); openModal(${fi},${di})">${di+1}</div>`).join('')}
                </div>`;
            root.appendChild(fPage);

            f.defects.forEach((d, di) => {
                const rName = d.room || "Inne";
                if(!roomChecks[rName]) roomChecks[rName] = {};
                if(d.checks) { for(let k in d.checks) if(d.checks[k]) roomChecks[rName][k] = true; }
                const dPage = createPage();
                dPage.innerHTML += `<div style="border:2px solid #eee; padding:20px; border-radius:10px;">
                    <div><span class="status-badge ${d.status==='reported'?'c-rep':(d.status==='not_reported'?'c-nrep':'c-none')}">PUNKT ${di+1}</span>
                    <span style="font-weight:bold; font-size:16px; margin-left:10px;">${d.room || ''} - ${d.cat || ''}</span></div>
                    <div style="margin:15px 0;">${d.desc || ''}</div>
                    ${d.norm ? `<div style="color:red; font-size:11px;">NORMA: ${d.norm}</div>` : ''}
                    <div style="height:100mm; background:#f9f9f9; display:flex; justify-content:center; align-items:center;">
                    ${d.img ? `<img src="${d.img}" style="max-width:100%; max-height:100%;">` : 'Brak zdjęcia'}</div></div>`;
                root.appendChild(dPage);
            });
        });

        const checkPage = createPage();
        checkPage.innerHTML += `<h2>PROTOKÓŁ WERYFIKACJI</h2>`;
        for (const [room, checks] of Object.entries(roomChecks)) {
            let html = `<div class="room-section"><div class="room-title">${room}</div>`;
            for (const [cat, items] of Object.entries(config.checklist)) {
                html += `<div class="check-cat-pdf">${cat}</div><div class="check-grid">`;
                items.forEach(item => { html += `<div class="check-item-pdf"><div class="box">${checks[`${cat}:${item}`] ? '✓' : ''}</div><span>${item}</span></div>`; });
                html += `</div>`;
            }
            checkPage.innerHTML += html + `</div>`;
        }
        root.appendChild(checkPage);
    }

    function addDot(e, fi) {
        if (!state.floors[fi].plan) return uploadImg('plan', fi);
        const r = e.currentTarget.getBoundingClientRect();
        state.floors[fi].defects.push({ x:((e.clientX-r.left)/r.width)*100, y:((e.clientY-r.top)/r.height)*100, desc:'', room:'', cat:'', status:'to_discuss', img:'', checks:{} });
        render(); openModal(fi, state.floors[fi].defects.length-1);
    }
    function uploadImg(type, fi, di) {
        const i = document.createElement('input'); i.type='file'; i.accept='image/*';
        i.onchange = e => {
            const f = e.target.files[0]; const reader = new FileReader();
            reader.onload = ev => {
                if(type==='logo') { config.logo=ev.target.result; saveConfig(); }
                else if(type==='plan') state.floors[fi].plan=ev.target.result;
                else if(type==='report') state.floors[fi].defects[di].img=ev.target.result;
                render();
            }; reader.readAsDataURL(f);
        }; i.click();
    }
    function addFloor() { state.floors.push({ name:'PIĘTRO '+(state.floors.length+1), plan:'', defects:[] }); render(); }
    function openSettings() { document.getElementById('set-checklist-json').value = JSON.stringify(config.checklist, null, 2); document.getElementById('settings-modal').style.display='block'; }
    function saveSettings() { try { config.checklist = JSON.parse(document.getElementById('set-checklist-json').value); saveConfig(); document.getElementById('settings-modal').style.display='none'; render(); } catch(e) { alert("Błąd JSON"); } }
    function exportData() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(state)], {type:'application/json'})); a.download = `Raport.json`; a.click(); }
    function importData(e) { const r = new FileReader(); r.onload = ev => { state = JSON.parse(ev.target.result); render(); }; r.readAsText(e.target.files[0]); }
    function resetApp() { if(confirm("Wyczyścić?")) { state={ meta:{inv:'',adr:'',date:'',cli:''}, floors:[] }; addFloor(); render(); } }

    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
    updateUILists(); if(!state.floors.length) addFloor(); render();
</script>
</body>
</html>