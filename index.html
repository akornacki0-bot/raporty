<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SYSTEM RAPORTOWANIA PRO</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000">

<style>
:root{
--orange:#e67e22;
--black:#111;
--gray:#999;
}

body{margin:0;font-family:system-ui;background:#f4f5f7}
header{background:#000;color:#fff;padding:10px;text-align:center;font-weight:700}
.toolbar{display:flex;gap:8px;padding:8px;background:#111}
.toolbar button{flex:1;padding:10px;border:0;border-radius:6px;background:var(--orange);color:#fff;font-weight:700}
.page{background:#fff;margin:10px;padding:10px;border-radius:12px}

.planBox{
position:relative;
height:75vh;
background:#eee;
border-radius:12px;
overflow:hidden;
cursor:crosshair;
}

.planBox img{
width:100%;
height:100%;
object-fit:contain;
pointer-events:none;
}

.dot{
position:absolute;
width:26px;
height:26px;
border-radius:50%;
color:#fff;
display:flex;
align-items:center;
justify-content:center;
transform:translate(-50%,-50%);
font-weight:800;
font-size:11px;
border:2px solid #fff;
}

.rep{background:var(--orange)}
.nrep{background:#000}
.none{background:#888}

.counter{
display:flex;
justify-content:space-around;
padding:8px;
font-size:12px;
font-weight:700;
}

.modal-bg{
position:fixed;
inset:0;
background:rgba(0,0,0,.75);
display:none;
z-index:9999;
}

.modal{
position:fixed;
top:50%;
left:50%;
transform:translate(-50%,-50%);
background:#fff;
border-radius:12px;
padding:15px;
width:420px;
max-width:95vw;
display:none;
z-index:10000;
}

.modal input,.modal textarea,select{
width:100%;
padding:8px;
border-radius:6px;
border:1px solid #ccc;
margin-bottom:8px;
}

.modal-buttons{
display:grid;
grid-template-columns:1fr 1fr 1fr;
gap:8px;
}

.modal-buttons button{
padding:8px;
border:0;
border-radius:6px;
color:#fff;
font-weight:700;
}

.photoBox{
width:100%;
height:160px;
background:#f1f1f1;
border:2px dashed #ccc;
border-radius:8px;
display:flex;
align-items:center;
justify-content:center;
cursor:pointer;
margin-bottom:8px;
overflow:hidden;
}

.photoBox img{width:100%;height:100%;object-fit:contain}

@media print{
.toolbar,.modal,.modal-bg{display:none!important}
body{background:#fff}
.page{margin:0;border-radius:0}
}
</style>
</head>

<body>

<header>SYSTEM RAPORTOWANIA PRO</header>

<div class="toolbar no-print">
<button onclick="newProject()">NOWY</button>
<button onclick="addFloor()">+ PIĘTRO</button>
<button onclick="saveJSON()">ZAPISZ</button>
<button onclick="loadJSON()">WCZYTAJ</button>
<button onclick="window.print()">PDF</button>
</div>

<div id="app"></div>

<input type="file" id="loader" hidden>

<div class="modal-bg" onclick="closeModal()"></div>

<div class="modal" id="modal">
<h3 id="m-title">EDYCJA USTERKI</h3>

<div class="photoBox" onclick="uploadImg()">
<span>DODAJ ZDJĘCIE</span>
</div>

<input id="m-room" placeholder="Pomieszczenie">
<textarea id="m-desc" placeholder="Opis usterki"></textarea>
<input id="m-norm" placeholder="Norma / uwagi">

<div class="modal-buttons">
<button style="background:var(--orange)" onclick="setStatus('rep')">ZGŁOSZONA</button>
<button style="background:#000" onclick="setStatus('nrep')">NIEZGŁOSZONA</button>
<button style="background:#777" onclick="setStatus('none')">DO OMÓWIENIA</button>
</div>

<button style="width:100%;margin-top:8px;background:#c0392b;color:#fff;border:0;padding:8px;border-radius:6px;font-weight:700"
onclick="deleteDot()">USUŃ</button>

</div>

<script>
let state={
meta:{inv:'',adr:'',cli:'',date:''},
floors:[]
}

let activeFloor=0
let activeDot=null

window.onbeforeunload=e=>{
e.preventDefault()
e.returnValue=''
}

function newProject(){
if(confirm("Utworzyć nowy projekt?")){
state={meta:{inv:'',adr:'',cli:'',date:''},floors:[]}
addFloor()
render()
}
}

function addFloor(){
state.floors.push({name:"Kondygnacja "+(state.floors.length+1),plan:'',defects:[]})
activeFloor=state.floors.length-1
}

function uploadPlan(){
let i=document.createElement('input')
i.type='file'
i.accept='image/*'
i.onchange=e=>{
let r=new FileReader()
r.onload=ev=>{
state.floors[activeFloor].plan=ev.target.result
render()
}
r.readAsDataURL(e.target.files[0])
}
i.click()
}

function addDot(e){
let f=state.floors[activeFloor]
if(!f.plan){uploadPlan();return}
let r=e.currentTarget.getBoundingClientRect()

f.defects.push({
x:(e.clientX-r.left)/r.width*100,
y:(e.clientY-r.top)/r.height*100,
room:'',
desc:'',
norm:'',
status:'none',
img:''
})

render()
openModal(f.defects.length-1)
}

function openModal(i){
activeDot=i
let d=state.floors[activeFloor].defects[i]
document.getElementById('m-room').value=d.room
document.getElementById('m-desc').value=d.desc
document.getElementById('m-norm').value=d.norm
document.querySelector('.photoBox').innerHTML=d.img?'<img src="'+d.img+'">':'DODAJ ZDJĘCIE'
document.querySelector('.modal-bg').style.display='block'
document.querySelector('.modal').style.display='block'
}

function closeModal(){
if(activeDot!==null){
let d=state.floors[activeFloor].defects[activeDot]
d.room=document.getElementById('m-room').value
d.desc=document.getElementById('m-desc').value
d.norm=document.getElementById('m-norm').value
}
activeDot=null
document.querySelector('.modal-bg').style.display='none'
document.querySelector('.modal').style.display='none'
render()
}

function setStatus(s){
state.floors[activeFloor].defects[activeDot].status=s
closeModal()
}

function deleteDot(){
if(confirm("Usunąć usterkę?")){
state.floors[activeFloor].defects.splice(activeDot,1)
closeModal()
}
}

function uploadImg(){
let i=document.createElement('input')
i.type='file'
i.accept='image/*'
i.onchange=e=>{
let r=new FileReader()
r.onload=ev=>{
state.floors[activeFloor].defects[activeDot].img=ev.target.result
openModal(activeDot)
}
r.readAsDataURL(e.target.files[0])
}
i.click()
}

function render(){
let app=document.getElementById('app')
app.innerHTML=`

<div class="page">
<input placeholder="Nazwa inwestycji" value="${state.meta.inv}" oninput="state.meta.inv=this.value">
<input placeholder="Adres" value="${state.meta.adr}" oninput="state.meta.adr=this.value">
<input placeholder="Zamawiający" value="${state.meta.cli}" oninput="state.meta.cli=this.value">
<input type="date" value="${state.meta.date}" oninput="state.meta.date=this.value">
</div>

<div class="page">
<select onchange="activeFloor=this.value;render()">
${state.floors.map((f,i)=>`<option value="${i}" ${i==activeFloor?'selected':''}>${f.name}</option>`).join('')}
</select>

<div class="planBox" onclick="addDot(event)">
${state.floors[activeFloor].plan?`<img src="${state.floors[activeFloor].plan}">`:'DODAJ RZUT'}
${state.floors[activeFloor].defects.map((d,i)=>`
<div class="dot ${d.status}" style="left:${d.x}%;top:${d.y}%"
onclick="event.stopPropagation();openModal(${i})">${i+1}</div>
`).join('')}
</div>

<div class="counter">
<span>Łącznie: ${state.floors[activeFloor].defects.length}</span>
<span>Zgłoszone: ${state.floors[activeFloor].defects.filter(x=>x.status=='rep').length}</span>
<span>Niezgłoszone: ${state.floors[activeFloor].defects.filter(x=>x.status=='nrep').length}</span>
<span>Do omówienia: ${state.floors[activeFloor].defects.filter(x=>x.status=='none').length}</span>
</div>
</div>
`
}

function saveJSON(){
let a=document.createElement('a')
a.href=URL.createObjectURL(new Blob([JSON.stringify(state)],{type:'application/json'}))
a.download=(state.meta.inv||'raport')+'.json'
a.click()
}

function loadJSON(){
let l=document.getElementById('loader')
l.onchange=e=>{
let r=new FileReader()
r.onload=ev=>{
state=JSON.parse(ev.target.result)
render()
}
r.readAsText(e.target.files[0])
}
l.click()
}

addFloor()
render()

if('serviceWorker' in navigator){
navigator.serviceWorker.register('sw.js')
}
</script>

</body>
</html>