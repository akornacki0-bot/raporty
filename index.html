<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Raport Odbioru PRO</title>

<link rel="manifest" href="manifest.json">

<meta name="theme-color" content="#111">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body{margin:0;font-family:system-ui;background:#f5f6f7}
header{background:#1f2937;color:#fff;padding:10px;text-align:center;font-weight:700}
.toolbar{display:flex;gap:8px;padding:8px;background:#111;color:#fff}
.toolbar button{flex:1;padding:10px;border:0;border-radius:6px;background:#2563eb;color:#fff;font-weight:700}
.page{background:#fff;margin:8px;padding:10px;border-radius:10px}
input,textarea,select{width:100%;padding:8px;margin:5px 0;border-radius:6px;border:1px solid #ccc}
.planBox{position:relative;background:#eee;height:60vh;border-radius:10px;overflow:hidden}
.planBox img{width:100%;height:100%;object-fit:contain}
.dot{position:absolute;width:28px;height:28px;border-radius:50%;color:#fff;font-weight:700;display:flex;align-items:center;justify-content:center;transform:translate(-50%,-50%)}
.rep{background:#f59e0b}
.nrep{background:#000}
.none{background:#9ca3af}
.counter{display:flex;gap:10px;justify-content:space-around;padding:8px;font-size:13px}
</style>
</head>

<body>

<header>ODBIÓR TECHNICZNY</header>

<div class="toolbar">
<button onclick="newProject()">NOWY</button>
<button onclick="saveJSON()">ZAPISZ</button>
<button onclick="loadJSON()">WCZYTAJ</button>
<button onclick="window.print()">PDF</button>
</div>

<div id="app"></div>

<input type="file" id="loader" hidden>

<script>
let data={meta:{inv:'',adr:'',cli:'',date:''},floors:[]}
let activeFloor=0

function newProject(){
 if(confirm("Utworzyć nowy projekt?")){
  data={meta:{inv:'',adr:'',cli:'',date:''},floors:[]}
  addFloor(); render()
 }
}

function addFloor(){
 data.floors.push({name:"Kondygnacja "+(data.floors.length+1),plan:'',def:[]})
 activeFloor=data.floors.length-1
}

function addDot(e){
 let f=data.floors[activeFloor]
 if(!f.plan){uploadPlan();return}
 let r=e.currentTarget.getBoundingClientRect()
 f.def.push({
  x:(e.clientX-r.left)/r.width*100,
  y:(e.clientY-r.top)/r.height*100,
  desc:'',
  norm:'',
  status:'none'
 })
 render()
}

function uploadPlan(){
 let i=document.createElement('input')
 i.type='file'; i.accept='image/*'
 i.onchange=e=>{
  let r=new FileReader()
  r.onload=ev=>{data.floors[activeFloor].plan=ev.target.result;render()}
  r.readAsDataURL(e.target.files[0])
 }
 i.click()
}

function editDot(fi,di){
 let d=data.floors[fi].def[di]
 let desc=prompt("Opis:",d.desc)
 if(desc!==null)d.desc=desc
 let norm=prompt("Uwagi / Norma:",d.norm)
 if(norm!==null)d.norm=norm
 let st=prompt("Status: zgłoszona / niezgłoszona / omówienie","zgłoszona")
 d.status=st=="niezgłoszona"?"nrep":st=="zgłoszona"?"rep":"none"
 render()
}

function render(){
 let app=document.getElementById('app')
 app.innerHTML=`
<div class="page">
<input placeholder="Nazwa inwestycji" value="${data.meta.inv}" oninput="data.meta.inv=this.value">
<input placeholder="Adres" value="${data.meta.adr}" oninput="data.meta.adr=this.value">
<input placeholder="Zamawiający" value="${data.meta.cli}" oninput="data.meta.cli=this.value">
<input type="date" value="${data.meta.date}" oninput="data.meta.date=this.value">
</div>

<div class="page">
<div class="toolbar"><button onclick="addFloor()">+ PIĘTRO</button></div>

<select onchange="activeFloor=this.value;render()">
${data.floors.map((f,i)=>`<option value="${i}" ${i==activeFloor?'selected':''}>${f.name}</option>`).join('')}
</select>

<div class="planBox" onclick="addDot(event)">
${data.floors[activeFloor]?.plan?`<img src="${data.floors[activeFloor].plan}">`:"DODAJ RZUT"}
${data.floors[activeFloor]?.def.map((d,i)=>`
<div class="dot ${d.status}" style="left:${d.x}%;top:${d.y}%"
 onclick="event.stopPropagation();editDot(${activeFloor},${i})">${i+1}</div>`).join('')}
</div>

<div class="counter">
<span>Łącznie: ${data.floors[activeFloor]?.def.length||0}</span>
<span>Zgłoszone: ${data.floors[activeFloor]?.def.filter(x=>x.status=='rep').length||0}</span>
<span>Niezgłoszone: ${data.floors[activeFloor]?.def.filter(x=>x.status=='nrep').length||0}</span>
<span>Do omówienia: ${data.floors[activeFloor]?.def.filter(x=>x.status=='none').length||0}</span>
</div>
</div>
`
}

function saveJSON(){
 let a=document.createElement('a')
 a.href=URL.createObjectURL(new Blob([JSON.stringify(data)],{type:'application/json'}))
 a.download=(data.meta.inv||'raport')+'.json'
 a.click()
}

function loadJSON(){
 let l=document.getElementById('loader')
 l.onchange=e=>{
  let r=new FileReader()
  r.onload=ev=>{data=JSON.parse(ev.target.result);render()}
  r.readAsText(e.target.files[0])
 }
 l.click()
}

addFloor()
render()

if('serviceWorker' in navigator){
 navigator.serviceWorker.register('sw.js')
}
</script>

</body>
</html>