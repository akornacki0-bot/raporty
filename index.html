<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>PR RAPORTY v32</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --main: #2c3e50; --acc: #f39c12; --bg: #f4f7f6; --white: #ffffff; --border: #dcdde1; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding-top: 60px; background: var(--bg); color: #2f3640; }

        /* INTERFEJS */
        .toolbar { position: fixed; top: 0; width: 100%; height: 55px; background: var(--main); color: #fff; display: flex; align-items: center; justify-content: center; gap: 10px; z-index: 1000; padding: 0 10px; }
        .btn { border: none; border-radius: 4px; padding: 10px 15px; font-weight: bold; cursor: pointer; font-size: 11px; text-transform: uppercase; color: #fff; }
        .btn-green { background: #27ae60; } .btn-blue { background: #2980b9; } .btn-orange { background: #f39c12; } .btn-red { background: #e74c3c; } .btn-dark { background: #34495e; }

        /* DOKUMENT A4 */
        .page { width: 210mm; min-height: 296mm; background: var(--white); margin: 10px auto; padding: 12mm; position: relative; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.1); page-break-after: always; }
        .page-cover { justify-content: center; text-align: center; }

        /* FILTRY */
        .filter-bar { background: #fff; padding: 10px; margin: 10px auto; width: 210mm; display: flex; gap: 15px; border-radius: 5px; border: 1px solid var(--border); }

        /* RZUT */
        .plan-area { position: relative; width: 100%; flex-grow: 1; background: #fafafa; border: 1px solid var(--border); overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .plan-img { position: relative; pointer-events: none; transform-origin: center; }
        .dot { position: absolute; width: 32px; height: 32px; border-radius: 50%; border: 2px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; transform: translate(-50%, -50%); z-index: 100; cursor: pointer; }
        
        .status-zgloszone { background: #e67e22; } 
        .status-niezgloszone { background: #2c3e50; } 
        .status-uwaga { background: #7f8c8d; }

        /* RAPORT LISTA */
        .defect-row { height: 135mm; border-bottom: 2px solid #eee; padding: 15px 0; display: flex; gap: 20px; page-break-inside: avoid; position: relative; }
        .edit-list-btn { position: absolute; right: 0; top: 10px; background: #34495e; color: #fff; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        .defect-photo-box { width: 45%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f9f9f9; border: 1px solid #eee; overflow: hidden; }
        .defect-photo-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .defect-details { width: 55%; font-size: 14px; display: flex; flex-direction: column; gap: 5px; }

        /* MODALE */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; width: 95%; max-width: 950px; border-radius: 8px; z-index: 2001; max-height: 90vh; overflow: hidden; flex-direction: column; }
        .modal-body { overflow-y: auto; flex-grow: 1; }
        .input { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid var(--border); border-radius: 4px; }

        .settings-grid { display: flex; gap: 20px; height: 500px; }
        .sidebar { width: 220px; border-right: 1px solid #eee; display: flex; flex-direction: column; gap: 5px; overflow-y: auto; }
        .tab { padding: 12px; background: #f1f2f6; border: none; text-align: left; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .tab.active { background: var(--acc); color: white; }
        .tab.locked::after { content: ' üîí'; font-size: 10px; }

        @media print {
            .no-print { display: none !important; }
            .page { margin: 0; box-shadow: none; width: 210mm; height: 297mm; }
            body { padding: 0; background: #fff; }
        }
    </style>
</head>
<body>

<div class="toolbar no-print">
    <button class="btn btn-green" onclick="dodajPietro()">+ PIƒòTRO</button>
    <button class="btn btn-blue" onclick="zapiszJSON()">ZAPISZ JSON</button>
    <button class="btn btn-dark" onclick="document.getElementById('file-in').click()">WCZYTAJ</button>
    <button class="btn btn-orange" onclick="otworzUstawienia()">SZCZEG√ì≈ÅY</button>
    <button class="btn btn-red" onclick="window.print()">DRUKUJ PDF</button>
</div>

<input type="file" id="file-in" style="display:none" onchange="wczytajJSON(event)">
<div class="overlay" id="overlay" onclick="zamknijModale()"></div>

<div class="modal" id="modal-kropka">
    <div class="modal-body">
        <h2 id="m-naglowek">Edycja Punktu</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <label>Pomieszczenie:</label>
                <input id="m-pom" class="input">
                <label>Status:</label>
                <select id="m-stat" class="input">
                    <option value="status-zgloszone">Zg≈Çoszone</option>
                    <option value="status-niezgloszone">Niezg≈Çoszone</option>
                    <option value="status-uwaga">Do om√≥wienia</option>
                </select>
                <div id="dropdowns-zakladek"></div>
            </div>
            <div>
                <div id="m-foto-podglad" style="width:100%; height:200px; background:#eee; border:2px dashed #ccc; display:flex; align-items:center; justify-content:center; cursor:pointer;" onclick="wgrajFotoUsterki()">Kliknij by dodaƒá zdjƒôcie</div>
                <label style="margin-top:10px; display:block;">Elementy zaznaczone:</label>
                <div id="m-zaznaczone-lista" style="background:#f9f9f9; padding:10px; min-height:60px; border:1px solid #ddd; margin-bottom:10px;"></div>
            </div>
        </div>
        <label>Opis w≈Çasny:</label>
        <textarea id="m-opis" class="input" style="height:80px"></textarea>
        <label>Norma / Podstawa prawna:</label>
        <input id="m-norma" class="input">
        
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-green" style="flex:1; padding:15px;" onclick="zapiszPunkt()">ZAPISZ ZMIANY</button>
            <button class="btn btn-red" onclick="usunPunkt()">USU≈É PUNKT</button>
        </div>
    </div>
</div>

<div class="modal" id="modal-ustawienia">
    <h2>Konfiguracja Szablonu</h2>
    <div class="settings-grid">
        <div class="sidebar" id="ust-zakladki"></div>
        <div class="modal-body" id="ust-kontent" style="padding:10px; border:1px solid #eee;"></div>
    </div>
    <div style="margin-top:15px; display:flex; gap:10px;">
        <button class="btn btn-dark" onclick="nowaZakladka()">+ NOWA ZAK≈ÅADKA</button>
        <button class="btn btn-green" style="margin-left:auto" onclick="zamknijModale()">ZACHOWAJ I ZAMKNIJ</button>
    </div>
</div>

<div id="app"></div>

<script>
    let d = {
        meta: { inv:'', adr:'', cli:'', date: new Date().toISOString().split('T')[0], logo:'', mainImg:'' },
        pietra: [],
        szablon: [
            { id: 'pom_fixed', nazwa:'Pomieszczenia', locked: true, kat: [{ nazwa:'Parter', poz:['Salon','Kuchnia','≈Åazienka'] }] },
            { id: 2, nazwa:'Normy', kat: [{ nazwa:'Tynki', poz:['Norma odchy≈Çki 3mm','Brak kƒÖt√≥w'] }] }
        ],
        lastPom: ''
    };

    let f_pom = 'wszystkie';
    let f_stat = 'wszystkie';
    let akt = { fi: null, pi: null, img: '', tabId: 'pom_fixed' };

    window.onbeforeunload = (e) => { e.preventDefault(); return "Niezapisane zmiany zostanƒÖ utracone!"; };

    function render() {
        const root = document.getElementById('app');
        root.innerHTML = '';

        // STRONA 1: OK≈ÅADKA
        const s1 = strona();
        s1.classList.add('page-cover');
        s1.innerHTML = `
            <div style="width:100%;">
                <img src="${d.meta.logo}" style="max-height:120px; cursor:pointer; margin-bottom:20px;" onclick="upload('logo')">
                <h1 style="font-size:32pt; border-top:4px solid #000; border-bottom:4px solid #000; padding:20px 0; margin:40px 0;">PROTOK√ì≈Å ODBIORU TECHNICZNEGO</h1>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:30px; text-align:left; margin:40px 0; font-size:14pt;">
                    <div><b>Inwestycja:</b> <input class="input" value="${d.meta.inv}" onchange="d.meta.inv=this.value"></div>
                    <div><b>Adres:</b> <input class="input" value="${d.meta.adr}" onchange="d.meta.adr=this.value"></div>
                    <div><b>ZamawiajƒÖcy:</b> <input class="input" value="${d.meta.cli}" onchange="d.meta.cli=this.value"></div>
                    <div><b>Data odbioru:</b> <input class="input" type="date" value="${d.meta.date}" onchange="d.meta.date=this.value"></div>
                </div>
                <div style="width:100%; height:90mm; background:#f0f0f0; border:1px solid #ccc; cursor:pointer; display:flex; align-items:center; justify-content:center; overflow:hidden;" onclick="upload('main')">
                    ${d.meta.mainImg ? `<img src="${d.meta.mainImg}" style="width:100%; height:100%; object-fit:cover;">` : 'KLIKNIJ, ABY DODAƒÜ ZDJƒòCIE INWESTYCJI'}
                </div>
            </div>`;
        root.appendChild(s1);

        // FILTRY (tylko ekran)
        const filters = document.createElement('div');
        filters.className = 'filter-bar no-print';
        filters.innerHTML = `
            <b>Filtruj widok:</b>
            <select onchange="f_pom=this.value; render()"><option value="wszystkie">Wszystkie Pomieszczenia</option>${getUnikalnePom().map(p=>`<option value="${p}" ${f_pom==p?'selected':''}>${p}</option>`).join('')}</select>
            <select onchange="f_stat=this.value; render()"><option value="wszystkie">Wszystkie Statusy</option><option value="status-zgloszone" ${f_stat=='status-zgloszone'?'selected':''}>Zg≈Çoszone</option><option value="status-niezgloszone" ${f_stat=='status-niezgloszone'?'selected':''}>Niezg≈Çoszone</option><option value="status-uwaga" ${f_stat=='status-uwaga'?'selected':''}>Do om√≥wienia</option></select>
        `;
        root.appendChild(filters);

        // PIƒòTRA
        d.pietra.forEach((f, fi) => {
            const sF = strona();
            const widoczneKropki = f.pts.filter(p => (f_pom=='wszystkie' || p.pom==f_pom) && (f_stat=='wszystkie' || p.stat==f_stat));

            sF.innerHTML = `
                <div style="display:flex; justify-content:space-between; border-bottom:2px solid #333; margin-bottom:10px;">
                    <input class="input" style="border:none; width:250px; margin:0; font-weight:bold; font-size:16pt;" value="${f.nazwa}" onchange="d.pietra[${fi}].nazwa=this.value">
                    <b style="align-self:center;">${d.meta.inv}</b>
                </div>
                <div class="plan-area" onclick="klikPlan(event, ${fi})">
                    ${f.img ? `<img src="${f.img}" class="plan-img" style="transform: rotate(${f.rot}deg) scale(${f.scale}); top:${f.offY}px; left:${f.offX}px;">` : '<h2>WCZYTAJ RZUT PIƒòTRA</h2>'}
                    ${widoczneKropki.map((p) => {
                        const oryginalnyIndex = f.pts.indexOf(p);
                        return `<div class="dot ${p.stat}" style="left:${p.x}%; top:${p.y}%;" onclick="event.stopPropagation(); edytujP(${fi}, ${oryginalnyIndex})">${oryginalnyIndex+1}</div>`;
                    }).join('')}
                </div>
                <div class="no-print" style="padding:15px; background:#eee; display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:10px; border-top:1px solid #ccc;">
                    <div>Obr√≥t: <button class="btn btn-dark" onclick="obroc(${fi})">Obr√≥ƒá 90¬∞</button></div>
                    <div>Skala: <input type="range" style="width:100%" min="0.2" max="4" step="0.05" value="${f.scale}" oninput="skaluj(${fi}, this.value)"></div>
                    <div>Pozycja X: <input type="range" style="width:100%" min="-1000" max="1000" value="${f.offX}" oninput="d.pietra[${fi}].offX=this.value; renderSync(${fi})"></div>
                    <div>Pozycja Y: <input type="range" style="width:100%" min="-1000" max="1000" value="${f.offY}" oninput="d.pietra[${fi}].offY=this.value; renderSync(${fi})"></div>
                    <button class="btn btn-red" onclick="if(confirm('UsunƒÖƒá piƒôtro?')){d.pietra.splice(${fi},1); render()}">USU≈É PIƒòTRO</button>
                </div>`;
            root.appendChild(sF);

            // RAPORTY SZCZEG√ì≈ÅOWE (tylko te, kt√≥re pasujƒÖ do filtra)
            for (let i = 0; i < widoczneKropki.length; i += 2) {
                const sL = strona();
                for (let j = i; j < i + 2 && j < widoczneKropki.length; j++) {
                    const p = widoczneKropki[j];
                    const idx = f.pts.indexOf(p);
                    sL.innerHTML += `
                        <div class="defect-row">
                            <button class="btn btn-dark edit-list-btn no-print" onclick="edytujP(${fi}, ${idx})">EDYTUJ</button>
                            <div class="defect-photo-box">${p.img ? `<img src="${p.img}">` : 'BRAK ZDJƒòCIA'}</div>
                            <div class="defect-details">
                                <b style="font-size:18pt; color:var(--acc); margin-bottom:5px;">ZG≈ÅOSZENIE NR ${idx+1}</b>
                                <div style="display:inline-block; padding:4px 8px; border-radius:4px; font-weight:bold; font-size:10pt;" class="${p.stat}">${p.stat.replace('status-','').toUpperCase()}</div>
                                <div style="margin-top:15px;"><b>Pomieszczenie:</b> ${p.pom}</div>
                                <div><b>Elementy:</b> ${p.zaz.join(', ')}</div>
                                <div><b>Opis:</b> ${p.opis}</div>
                                ${p.norm ? `<div style="margin-top:auto; color:#c0392b; font-weight:bold; border:1px solid #c0392b; padding:5px; border-radius:4px;">NORMA: ${p.norm}</div>` : ''}
                            </div>
                        </div>`;
                }
                root.appendChild(sL);
            }
        });
    }

    function strona() { const div = document.createElement('div'); div.className = 'page'; return div; }

    // Funkcja do p≈Çynnego renderowania bez prze≈Çadowania ca≈Ço≈õci
    function renderSync(fi) {
        const img = document.querySelectorAll('.plan-img')[fi];
        const f = d.pietra[fi];
        img.style.transform = `rotate(${f.rot}deg) scale(${f.scale})`;
        img.style.top = f.offY + 'px';
        img.style.left = f.offX + 'px';
    }

    function getUnikalnePom() {
        let poms = new Set();
        d.pietra.forEach(f => f.pts.forEach(p => poms.add(p.pom)));
        return Array.from(poms);
    }

    function klikPlan(e, fi) {
        if(!d.pietra[fi].img) return upload('plan', fi);
        const r = e.currentTarget.getBoundingClientRect();
        const pi = d.pietra[fi].pts.length;
        d.pietra[fi].pts.push({ x: ((e.clientX - r.left)/r.width)*100, y: ((e.clientY - r.top)/r.height)*100, pom: d.lastPom, opis:'', norm:'', stat:'status-uwaga', img:'', zaz:[] });
        render(); edytujP(fi, pi);
    }

    function edytujP(fi, pi) {
        akt.fi = fi; akt.pi = pi;
        const p = d.pietra[fi].pts[pi];
        akt.img = p.img;
        document.getElementById('m-naglowek').innerText = `Usterka nr ${pi+1}`;
        document.getElementById('m-pom').value = p.pom;
        document.getElementById('m-stat').value = p.stat;
        document.getElementById('m-opis').value = p.opis;
        document.getElementById('m-norma').value = p.norm;
        document.getElementById('m-foto-podglad').innerHTML = p.img ? `<img src="${p.img}" style="height:100%">` : 'Dodaj zdjƒôcie';
        odswiezZaz(p.zaz);
        generujListy(p);
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('modal-kropka').style.display = 'flex';
    }

    function generujListy(p) {
        const wrap = document.getElementById('dropdowns-zakladek');
        wrap.innerHTML = '';
        d.szablon.forEach(zak => {
            const label = document.createElement('label'); label.innerText = zak.nazwa + ":";
            const sel = document.createElement('select'); sel.className = 'input';
            sel.innerHTML = `<option value="">-- wybierz --</option>` + zak.kat.map(k => 
                `<optgroup label="${k.nazwa}">${k.poz.map(poz => `<option value="${poz}">${poz}</option>`).join('')}</optgroup>`
            ).join('');
            sel.onchange = (e) => {
                if(e.target.value && !p.zaz.includes(e.target.value)) {
                    p.zaz.push(e.target.value);
                    if(zak.nazwa.toLowerCase().includes('norm')) document.getElementById('m-norma').value = e.target.value;
                    if(zak.id === 'pom_fixed') document.getElementById('m-pom').value = e.target.value;
                    odswiezZaz(p.zaz);
                }
                e.target.value = "";
            };
            wrap.appendChild(label); wrap.appendChild(sel);
        });
    }

    function odswiezZaz(lista) {
        document.getElementById('m-zaznaczone-lista').innerHTML = lista.map((z, i) => `<span style="display:inline-block; background:#2c3e50; color:#fff; padding:3px 10px; margin:3px; border-radius:15px; font-size:11px;">${z} <b style="color:red; cursor:pointer; margin-left:5px" onclick="d.pietra[akt.fi].pts[akt.pi].zaz.splice(${i},1); odswiezZaz(d.pietra[akt.fi].pts[akt.pi].zaz)">‚úï</b></span>`).join('');
    }

    function zapiszPunkt() {
        const p = d.pietra[akt.fi].pts[akt.pi];
        p.pom = document.getElementById('m-pom').value;
        p.stat = document.getElementById('m-stat').value;
        p.opis = document.getElementById('m-opis').value;
        p.norm = document.getElementById('m-norma').value;
        p.img = akt.img;
        d.lastPom = p.pom;
        zamknijModale(); render();
    }

    // USTAWIENIA SZCZEG√ì≈Å√ìW
    function otworzUstawienia() {
        renderT();
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('modal-ustawienia').style.display = 'flex';
    }

    function renderT() {
        document.getElementById('ust-zakladki').innerHTML = d.szablon.map(z => `<button class="tab ${z.locked?'locked':''} ${akt.tabId==z.id?'active':''}" onclick="akt.tabId='${z.id}'; renderT();">${z.nazwa}</button>`).join('');
        const zak = d.szablon.find(z => z.id == akt.tabId);
        const cont = document.getElementById('ust-kontent');
        cont.innerHTML = `<h3>Zak≈Çadka: <input value="${zak.nazwa}" ${zak.locked?'disabled':''} onchange="zak.nazwa=this.value; renderT()"> ${zak.locked?'':'<button class="btn btn-red" onclick="usunZak('+zak.id+')">usu≈Ñ</button>'}</h3>`;
        zak.kat.forEach((k, ki) => {
            cont.innerHTML += `
                <div style="border:1px solid #ddd; padding:15px; margin-bottom:15px; background:#fdfdfd;">
                    <b>Kategoria:</b> <input class="input" style="width:70%" value="${k.nazwa}" onchange="zak.kat[${ki}].nazwa=this.value"> <button class="btn btn-red" onclick="zak.kat.splice(${ki},1); renderT()">‚úï</button>
                    <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:5px;">
                        ${k.poz.map((p, pi) => `<div style="display:flex; align-items:center; background:#eee; padding:5px; border-radius:3px;"><input style="border:none; background:transparent" value="${p}" onchange="zak.kat[${ki}].poz[${pi}]=this.value"> <button style="border:none; color:red; cursor:pointer" onclick="zak.kat[${ki}].poz.splice(${pi},1); renderT()">‚úï</button></div>`).join('')}
                        <button class="btn btn-dark" onclick="zak.kat[${ki}].poz.push('Nowy'); renderT()">+ NOWA POZYCJA</button>
                    </div>
                </div>`;
        });
        cont.innerHTML += `<button class="btn btn-blue" onclick="zak.kat.push({nazwa:'Nowa Kat', poz:[]}); renderT()">+ DODAJ KATEGORIƒò</button>`;
    }

    function nowaZakladka() { d.szablon.push({ id: Date.now(), nazwa: 'Nowa', kat: [] }); renderT(); }
    function usunZak(id) { d.szablon = d.szablon.filter(z=>z.id!=id); akt.tabId='pom_fixed'; renderT(); }

    // OBRAZY
    function upload(typ, fi=null) {
        const i = document.createElement('input'); i.type='file'; i.accept='image/*';
        i.onchange = e => {
            const r = new FileReader();
            r.onload = ev => {
                resize(ev.target.result, 1200, (res) => {
                    if(typ=='logo') d.meta.logo=res; else if(typ=='main') d.meta.mainImg=res; else if(typ=='plan') d.pietra[fi].img=res;
                    render();
                });
            }; r.readAsDataURL(e.target.files[0]);
        }; i.click();
    }

    function wgrajFotoUsterki() {
        const i = document.createElement('input'); i.type='file'; i.accept='image/*';
        i.onchange = e => {
            const r = new FileReader();
            r.onload = ev => {
                resize(ev.target.result, 1000, (res) => {
                    akt.img = res;
                    document.getElementById('m-foto-podglad').innerHTML = `<img src="${res}" style="height:100%">`;
                });
            }; r.readAsDataURL(e.target.files[0]);
        }; i.click();
    }

    function resize(base64, max, cb) {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if(w > h) { if(w > max) { h *= max/w; w = max; } } else { if(h > max) { w *= max/h; h = max; } }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            cb(canvas.toDataURL('image/jpeg', 0.8));
        }; img.src = base64;
    }

    function obroc(fi) { d.pietra[fi].rot = (d.pietra[fi].rot + 90) % 360; render(); }
    function skaluj(fi, v) { d.pietra[fi].scale = v; renderSync(fi); }
    function zamknijModale() { document.querySelectorAll('.modal, .overlay').forEach(el=>el.style.display='none'); }
    function usunPunkt() { d.pietra[akt.fi].pts.splice(akt.pi,1); zamknijModale(); render(); }
    function zapiszJSON() {
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(d)], {type:'application/json'}));
        a.download = `Raport_${d.meta.inv || 'Projekt'}.json`; a.click();
    }
    function wczytajJSON(e) {
        const r = new FileReader(); r.onload = ev => { d = JSON.parse(ev.target.result); render(); };
        r.readAsText(e.target.files[0]);
    }

    if(d.pietra.length===0) dodajPietro();
    render();
</script>
</body>
</html>