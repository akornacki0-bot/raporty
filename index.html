<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>SYSTEM RAPORTOWANIA v19.17</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a252f">
    <link rel="manifest" href="manifest.json">
    
    <style>
        :root { --rep: #e67e22; --nrep: #2c3e50; --none: #95a5a6; --main: #1a252f; --bg: #f8f9fa; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-top: 60px; }
        
        .toolbar { position: fixed; top: 0; left: 0; width: 100%; height: 50px; background: var(--main); color: #fff; display: flex; align-items: center; justify-content: center; gap: 10px; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .btn { padding: 8px 12px; border: none; cursor: pointer; font-weight: 600; border-radius: 5px; font-size: 11px; text-transform: uppercase; color: #fff; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        
        .page { width: 210mm; min-height: 296mm; background: #fff; margin: 0 auto 20px; padding: 15mm; position: relative; display: flex; flex-direction: column; page-break-after: always; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header-info { font-size: 9px; color: #95a5a6; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; height: 12mm; }
        .mini-logo { max-height: 10mm; max-width: 40mm; object-fit: contain; }
        .footer-info { position: absolute; bottom: 8mm; left: 15mm; right: 15mm; border-top: 1px solid #eee; padding-top: 5px; font-size: 9px; color: #bdc3c7; display: flex; justify-content: space-between; }

        .logo-box { height: 35mm; width: 100%; display: flex; justify-content: center; align-items: center; border: 1px dashed #ccc; margin-bottom: 10px; cursor: pointer; }
        .logo-box img { max-height: 100%; max-width: 100%; }
        .main-img-box { width: 100%; height: 100mm; background: #eee; display: flex; justify-content: center; align-items: center; margin-top: 15px; cursor: pointer; overflow: hidden; border-radius: 8px; }
        .main-img-box img { width: 100%; height: 100%; object-fit: cover; }

        .plan-wrapper { width: 100%; height: 180mm; background: #f0f0f0; border: 1px solid #ccc; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: crosshair; border-radius: 8px; }
        .plan-img { max-width: 100%; max-height: 100%; transition: transform 0.3s; pointer-events: none; }
        .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }

        .grid-table { width: 100%; border-collapse: separate; border-spacing: 0 15px; }
        .grid-table td { width: 100%; height: 120mm; border: 1px solid #eee; border-radius: 8px; padding: 15px; vertical-align: top; position: relative; background: #fff; }
        .q-photo { width: 100%; height: 90mm; background: #fafafa; border-radius: 6px; display: flex; justify-content: center; align-items: center; margin-top: 10px; border: 1px solid #eee; overflow: hidden; }
        .q-photo img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .dot { position: absolute; width: 24px; height: 24px; border-radius: 50%; border: 2px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; transform: translate(-50%, -50%); font-weight: 800; font-size: 10px; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.4); }
        .status-badge { padding: 4px 10px; border-radius: 4px; font-weight: 700; font-size: 10px; color: white; margin-bottom: 5px; display: inline-block; }

        #ov { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; }
        #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; border-radius: 10px; z-index: 10001; width: 90%; max-width: 400px; }
        .modal-field { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; }
        
        .c-rep { background: var(--rep); } .c-nrep { background: var(--nrep); } .c-none { background: var(--none); }

        @media print { .no-print { display: none !important; } body { padding: 0; background: #fff; } .page { margin: 0; box-shadow: none; } }
    </style>
</head>
<body>

<div class="toolbar no-print">
    <button class="btn" style="background:#27ae60" onclick="addFloor()">+ Piętro</button>
    <button class="btn" style="background:#2980b9" onclick="exportJSON()">ZAPISZ PROJEKT</button>
    <button class="btn" style="background:#e67e22" onclick="document.getElementById('import-file').click()">WCZYTAJ .JSON</button>
    <button class="btn" style="background:#e74c3c" onclick="window.print()">DRUKUJ PDF</button>
</div>

<input type="file" id="import-file" style="display:none" onchange="importJSON(event)">
<div id="ov" onclick="closeModal()"></div>

<div id="modal">
    <h3 id="m-title" style="margin-top:0">Punkt</h3>
    <div id="m-photo-box" style="width:100%; height:150px; background:#eee; margin-bottom:10px; cursor:pointer; display:flex; justify-content:center; align-items:center; overflow:hidden" onclick="uploadImg('report', active.f, active.d)">Kliknij aby dodać zdjęcie</div>
    <textarea id="m-desc" class="modal-field" placeholder="Opis usterki..."></textarea>
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
        <button class="btn c-rep" onclick="setStatus('reported')">Zgłosz.</button>
        <button class="btn c-nrep" onclick="setStatus('not_reported')">Niezgł.</button>
        <button class="btn c-none" onclick="setStatus('to_discuss')">Uwagi</button>
    </div>
    <button class="btn" style="background:#333; width:100%; margin-top:10px" onclick="closeModal()">ZAMKNIJ I ZAPISZ</button>
    <button class="btn" style="background:red; width:100%; margin-top:5px; font-size:9px" onclick="deletePoint()">USUŃ PUNKT</button>
</div>

<div id="app"></div>

<script>
    let state = { meta: { inv:'', cli:'' }, logo: '', mainImg: '', floors: [] };
    let active = { f: null, d: null };

    function uploadImg(type, fi, di) {
        const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
        input.onchange = e => {
            const reader = new FileReader();
            reader.onload = ev => {
                if(type==='logo') state.logo = ev.target.result;
                else if(type==='main') state.mainImg = ev.target.result;
                else if(type==='plan') state.floors[fi].plan = ev.target.result;
                else if(type==='report') { state.floors[fi].defects[di].img = ev.target.result; openModal(fi, di); }
                render();
            };
            reader.readAsDataURL(e.target.files[0]);
        };
        input.click();
    }

    function exportJSON() {
        const blob = new Blob([JSON.stringify(state)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Raport_${state.meta.inv || 'projekt'}.json`;
        a.click();
    }

    function importJSON(e) {
        const r = new FileReader();
        r.onload = ev => { state = JSON.parse(r.result); render(); };
        r.readAsText(e.target.files[0]);
    }

    function addFloor() { state.floors.push({ name: 'Kondygnacja ' + (state.floors.length + 1), plan: '', defects: [], rotation: 0 }); render(); }
    function rotatePlan(fi) { state.floors[fi].rotation = (state.floors[fi].rotation + 90) % 360; render(); }

    function addDot(e, fi) {
        if (!state.floors[fi].plan) return uploadImg('plan', fi);
        const r = e.currentTarget.getBoundingClientRect();
        const di = state.floors[fi].defects.length;
        state.floors[fi].defects.push({ x: ((e.clientX - r.left)/r.width)*100, y: ((e.clientY - r.top)/r.height)*100, desc: '', status: 'to_discuss', img: '' });
        render(); openModal(fi, di);
    }

    function openModal(fi, di) {
        active = { f: fi, d: di }; const d = state.floors[fi].defects[di];
        document.getElementById('m-title').innerText = "Punkt nr " + (di + 1);
        document.getElementById('m-desc').value = d.desc;
        document.getElementById('m-photo-box').innerHTML = d.img ? `<img src="${d.img}" style="width:100%;height:100%;object-fit:contain">` : 'Dodaj zdjęcie';
        document.getElementById('ov').style.display = 'block'; document.getElementById('modal').style.display = 'block';
    }

    function closeModal() {
        if(active.f !== null) state.floors[active.f].defects[active.d].desc = document.getElementById('m-desc').value;
        document.getElementById('ov').style.display = 'none'; document.getElementById('modal').style.display = 'none';
        render();
    }

    function setStatus(s) { state.floors[active.f].defects[active.d].status = s; closeModal(); }
    function deletePoint() { if(confirm("Usunąć?")) { state.floors[active.f].defects.splice(active.d, 1); closeModal(); } }

    function render() {
        const root = document.getElementById('app'); root.innerHTML = '';
        let pTotal = 1 + state.floors.length + state.floors.reduce((a, f) => a + Math.ceil(f.defects.length / 2), 0);
        let pNum = 0;

        function getP() {
            pNum++; const p = document.createElement('div'); p.className = 'page';
            p.innerHTML = `<div class="header-info"><div>RAPORT: ${state.meta.inv}</div>${state.logo ? `<img src="${state.logo}" class="mini-logo">` : ''}</div>
                           <div class="footer-info"><div>Dokument wygenerowany systemowo</div><div>STRONA ${pNum} / ${pTotal}</div></div>`;
            return p;
        }

        const cover = document.createElement('div'); cover.className = 'page'; pNum++;
        cover.innerHTML = `<div class="logo-box" onclick="uploadImg('logo')">${state.logo ? `<img src="${state.logo}">` : 'DODAJ LOGO'}</div>
            <h1 style="text-align:center; margin: 40px 0;">PROTOKÓŁ ODBIORU</h1>
            <input class="modal-field" placeholder="Nazwa Inwestycji" value="${state.meta.inv}" oninput="state.meta.inv=this.value">
            <input class="modal-field" placeholder="Klient / Zamawiający" value="${state.meta.cli}" oninput="state.meta.cli=this.value">
            <div class="main-img-box" onclick="uploadImg('main')">${state.mainImg ? `<img src="${state.mainImg}">` : 'ZDJĘCIE GŁÓWNE OBIEKTU'}</div>`;
        root.appendChild(cover);

        state.floors.forEach((f, fi) => {
            const fPage = getP();
            fPage.innerHTML += `<h3>${f.name}</h3><div class="plan-wrapper" onclick="addDot(event, ${fi})">
                ${f.plan ? `<img src="${f.plan}" class="plan-img rot-${f.rotation}">` : 'KLIKNIJ ABY WGRAĆ RZUT'}
                ${f.defects.map((d, di) => `<div class="dot ${d.status==='reported'?'c-rep':(d.status==='not_reported'?'c-nrep':'c-none')}" style="left:${d.x}%; top:${d.y}%" onclick="event.stopPropagation(); openModal(${fi},${di})">${di+1}</div>`).join('')}
            </div><button class="btn no-print" style="background:#000; margin-top:10px" onclick="rotatePlan(${fi})">OBRÓĆ RZUT</button>`;
            root.appendChild(fPage);

            for (let i = 0; i < f.defects.length; i += 2) {
                const dPage = getP();
                const table = document.createElement('table'); table.className = 'grid-table';
                let html = '';
                for (let j = 0; j < 2; j++) {
                    const idx = i + j;
                    if (idx < f.defects.length) {
                        const d = f.defects[idx];
                        html += `<tr><td><div class="status-badge ${d.status==='reported'?'c-rep':(d.status==='not_reported'?'c-nrep':'c-none')}">PUNKT ${idx+1}</div>
                                 <div style="font-weight:bold; margin-bottom:10px;">${d.desc || 'Brak opisu'}</div>
                                 <div class="q-photo">${d.img ? `<img src="${d.img}">` : ''}</div></td></tr>`;
                    }
                }
                table.innerHTML = html; dPage.appendChild(table); root.appendChild(dPage);
            }
        });
    }
    if(state.floors.length === 0) addFloor();
    render();
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }
</script>
</body>
</html>