<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>SYSTEM ODBIOR√ìW PRO v40</title>
    <style>
        :root { --p: #ff8c00; --d: #1a1a1a; --border: #000; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #444; padding-top: 60px; }

        /* Toolbar */
        .toolbar { position: fixed; top: 0; width: 100%; height: 60px; background: var(--d); color: white; display: flex; align-items: center; padding: 0 20px; z-index: 999; gap: 15px; border-bottom: 3px solid var(--p); }
        .btn { padding: 10px 16px; border: none; border-radius: 4px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 11px; color: white; }
        .btn-p { background: var(--p); }
        .btn-s { background: #333; border: 1px solid #555; }

        /* Strony A4 */
        .page { width: 210mm; min-height: 296mm; background: white; margin: 20px auto; padding: 15mm; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); page-break-after: always; display: flex; flex-direction: column; }
        
        /* Dane Inwestycji */
        .meta-box { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #f5f5f5; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .f-group label { display: block; font-size: 10px; font-weight: 900; color: #555; margin-bottom: 5px; text-transform: uppercase; }
        .f-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 15px; }

        /* Rzut i Punkty */
        .plan-header { border-bottom: 3px solid var(--border); margin-bottom: 10px; font-weight: 900; font-size: 18px; padding-bottom: 5px; }
        .plan-wrap { width: 100%; border: 2px solid var(--border); position: relative; background: #eee; cursor: crosshair; line-height: 0; }
        .plan-img { width: 100%; height: auto; }
        .dot { position: absolute; width: 28px; height: 28px; background: var(--p); color: white; border: 2px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; transform: translate(-50%, -50%); z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        /* Modal - TWOJA TABELA */
        #ov { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; }
        #modal { display: none; position: fixed; top: 5%; left: 50%; transform: translateX(-50%); background: white; width: 95%; max-width: 700px; padding: 25px; border-radius: 12px; z-index: 1001; max-height: 90vh; overflow-y: auto; }
        
        .m-section { margin-bottom: 20px; }
        .m-section label { display: block; font-weight: 900; font-size: 12px; color: #444; margin-bottom: 8px; text-transform: uppercase; }
        .m-section input, .m-section textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; font-family: inherit; }
        
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .chip { padding: 8px 12px; background: white; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; font-weight: 700; cursor: pointer; }
        .chip:hover { border-color: var(--p); color: var(--p); }

        /* Raport PDF (2 na stronƒô) */
        .report-item { border: 1px solid #eee; padding: 15px; height: 120mm; display: flex; gap: 20px; margin-bottom: 15px; page-break-inside: avoid; }
        .info-col { flex: 1; }
        .img-col { width: 90mm; border: 1px solid #eee; display: flex; align-items: center; justify-content: center; background: #fafafa; }
        .img-col img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .point-tag { background: var(--p); color: white; padding: 4px 10px; font-weight: 900; font-size: 12px; display: inline-block; margin-bottom: 10px; }

        @media print { .no-print { display: none !important; } .page { margin: 0; box-shadow: none; } body { background: white; padding: 0; } }
    </style>
</head>
<body>

<div class="toolbar no-print">
    <button class="btn btn-p" onclick="addFloor()">+ KONDYGNACJA</button>
    <button class="btn btn-s" onclick="openTemplate()">KONFIGURUJ SZABLON</button>
    <div style="flex-grow:1"></div>
    <button class="btn btn-s" onclick="document.getElementById('json-in').click()">IMPORT JSON</button>
    <button class="btn btn-p" onclick="saveJSON()">ZAPISZ JSON</button>
    <button class="btn btn-p" style="background:#e67e22" onclick="window.print()">GENERUJ PDF</button>
</div>
<input type="file" id="json-in" style="display:none" onchange="loadJSON(event)">

<div id="ov" onclick="closeModal()"></div>
<div id="modal"></div>
<div id="app"></div>

<script>
    // Rejestracja SW dla pracy offline
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    let state = {
        meta: { inv: '', adr: '', cli: '', date: '', logo: '', main: '' },
        floors: [],
        config: { rooms: [], categories: [] }
    };

    let active = { fi: null, di: null, lastRoom: '' };
    let gCount = 1;

    // ≈Åadowanie domy≈õlnego szablonu z pliku JSON
    fetch('config.json')
        .then(r => r.json())
        .then(data => { state.config = data; render(); });

    async function toB64(file) {
        return new Promise(res => {
            const r = new FileReader();
            r.onload = e => res(e.target.result);
            r.readAsDataURL(file);
        });
    }

    function addFloor() {
        const i = document.createElement('input'); i.type = 'file';
        i.onchange = async e => {
            const b = await toB64(e.target.files[0]);
            state.floors.push({ name: 'Rzut '+(state.floors.length+1), img: b, defects: [], locked: false });
            render();
        };
        i.click();
    }

    function handleMapClick(e, fi) {
        if(!state.floors[fi].locked) return;
        const r = e.currentTarget.getBoundingClientRect();
        const x = ((e.clientX - r.left) / r.width) * 100;
        const y = ((e.clientY - r.top) / r.height) * 100;
        
        state.floors[fi].defects.push({
            id: gCount++, x, y, room: active.lastRoom, desc: '', img: '', norm: ''
        });
        render();
        openEdit(fi, state.floors[fi].defects.length - 1);
    }

    function openEdit(fi, di) {
        active.fi = fi; active.di = di;
        const d = state.floors[fi].defects[di];
        const m = document.getElementById('modal');
        m.innerHTML = `
            <h2 style="margin:0 0 20px 0; color:var(--p)">USTERKA NR ${d.id}</h2>
            <div class="m-section">
                <label>Pomieszczenie:</label>
                <input id="m-room" list="room-list" value="${d.room}" onchange="active.lastRoom=this.value">
                <datalist id="room-list">${state.config.rooms.map(r=>`<option value="${r}">`).join('')}</datalist>
            </div>
            <div class="m-section">
                <label>Opis usterki:</label>
                <textarea id="m-desc" rows="4">${d.desc}</textarea>
            </div>
            <div class="m-section">
                <label>Zdjƒôcie:</label>
                <input type="file" accept="image/*" capture="environment" onchange="setDefImg(event)">
                <div id="m-prev" style="margin-top:10px">${d.img?`<img src="${d.img}" width="150">`:''}</div>
            </div>
            <div class="m-section">
                <label>Wybierz z szablonu:</label>
                <div class="chip-container">
                    ${state.config.categories.map(c => `
                        <div style="width:100%; font-size:11px; font-weight:900; margin-top:10px">${c.name}</div>
                        ${c.items.map(i => `<div class="chip" onclick="addTxt('${i}')">${i}</div>`).join('')}
                    `).join('')}
                </div>
            </div>
            <div class="m-section">
                <label>Norma / Uwagi:</label>
                <input id="m-norm" value="${d.norm}">
            </div>
            <div style="display:flex; gap:10px; margin-top:30px">
                <button class="btn btn-s" style="background:red" onclick="delDef()">USU≈É</button>
                <button class="btn btn-p" style="flex:1" onclick="closeModal()">ZAPISZ I ZAMKNIJ</button>
            </div>
        `;
        document.getElementById('ov').style.display = 'block';
        m.style.display = 'block';
        document.getElementById('m-desc').focus();
    }

    function addTxt(t) { const o = document.getElementById('m-desc'); o.value += (o.value?', ':'')+t; }
    async function setDefImg(e) { 
        state.floors[active.fi].defects[active.di].img = await toB64(e.target.files[0]);
        document.getElementById('m-prev').innerHTML = `<img src="${state.floors[active.fi].defects[active.di].img}" width="150">`;
    }
    function delDef() { if(confirm("UsunƒÖƒá punkt?")) { state.floors[active.fi].defects.splice(active.di,1); closeModal(); } }

    function closeModal() {
        const d = state.floors[active.fi].defects[active.di];
        if(d) {
            d.room = document.getElementById('m-room').value;
            d.desc = document.getElementById('m-desc').value;
            d.norm = document.getElementById('m-norm').value;
        }
        document.getElementById('ov').style.display='none';
        document.getElementById('modal').style.display='none';
        render();
    }

    function render() {
        const root = document.getElementById('app'); root.innerHTML = '';
        
        // Strona Tytu≈Çowa
        const s1 = document.createElement('div'); s1.className = 'page';
        s1.innerHTML = `
            <div style="height:45mm; text-align:center" onclick="upMeta('logo')">
                ${state.meta.logo ? `<img src="${state.meta.logo}" style="max-height:100%">` : 'DODAJ LOGO'}
            </div>
            <h1 style="text-align:center; font-size:35px; margin:40px 0; border-bottom:6px solid var(--p)">PROTOK√ì≈Å ODBIORU</h1>
            <div class="meta-box">
                <div class="f-group"><label>Inwestycja:</label><input value="${state.meta.inv}" oninput="state.meta.inv=this.value"></div>
                <div class="f-group"><label>Adres:</label><input value="${state.meta.adr}" oninput="state.meta.adr=this.value"></div>
                <div class="f-group"><label>Klient:</label><input value="${state.meta.cli}" oninput="state.meta.cli=this.value"></div>
                <div class="f-group"><label>Data:</label><input type="date" value="${state.meta.date}" oninput="state.meta.date=this.value"></div>
            </div>
            <div style="flex:1; margin-top:20px; border:1px solid #ddd; display:flex; align-items:center; justify-content:center" onclick="upMeta('main')">
                ${state.meta.main ? `<img src="${state.meta.main}" style="width:100%; height:100%; object-fit:cover">` : 'FOTO G≈Å√ìWNE'}
            </div>
        `;
        root.appendChild(s1);

        // Rzuty i Karty
        state.floors.forEach((f, fi) => {
            const pf = document.createElement('div'); pf.className = 'page';
            pf.innerHTML = `
                <div class="plan-header">RZUT: ${f.name}</div>
                <div class="no-print" style="margin-bottom:10px">
                    <button class="btn ${f.locked?'btn-p':'btn-s'}" onclick="state.floors[${fi}].locked=!state.floors[${fi}].locked; render()">${f.locked?'üîí ZABLOKOWANY':'üîì ODBLOKUJ'}</button>
                </div>
                <div class="plan-wrap" onclick="handleMapClick(event, ${fi})">
                    <img src="${f.img}" class="plan-img">
                    ${f.defects.map((d, di) => `<div class="dot" style="left:${d.x}%; top:${d.y}%" onclick="event.stopPropagation(); openEdit(${fi},${di})">${d.id}</div>`).join('')}
                </div>
            `;
            root.appendChild(pf);

            for(let i=0; i<f.defects.length; i+=2) {
                const pr = document.createElement('div'); pr.className = 'page';
                let h = `<div class="plan-header">WYKAZ USTEREK - ${f.name}</div>`;
                for(let j=0; j<2; j++) {
                    const d = f.defects[i+j]; if(!d) break;
                    h += `<div class="report-item">
                        <div class="info-col">
                            <div class="point-tag">PUNKT ${d.id}</div>
                            <h2 style="margin:5px 0">${d.room.toUpperCase()}</h2>
                            <p><b>OPIS:</b> ${d.desc}</p>
                            <p style="margin-top:20px; font-size:12px"><b>NORMA:</b> ${d.norm}</p>
                        </div>
                        <div class="img-col">${d.img?`<img src="${d.img}">`:'BRAK FOTO'}</div>
                    </div>`;
                }
                pr.innerHTML = h; root.appendChild(pr);
            }
        });
    }

    async function upMeta(k) {
        const i = document.createElement('input'); i.type='file';
        i.onchange=async e=>{ state.meta[k]=await toB64(e.target.files[0]); render(); };
        i.click();
    }

    function saveJSON() {
        const a = document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(state)],{type:'application/json'}));
        a.download=`${state.meta.inv || 'raport'}.json`; a.click();
    }

    function loadJSON(e) {
        const r = new FileReader();
        r.onload = ev => { state = JSON.parse(ev.target.result); render(); };
        r.readAsText(e.target.files[0]);
    }

    function openTemplate() {
        const m = document.getElementById('modal');
        m.innerHTML = `
            <h3>EDYCJA SZABLONU</h3>
            <textarea id="t-area" style="width:100%; height:300px">${JSON.stringify(state.config, null, 2)}</textarea>
            <button class="btn btn-p" onclick="saveTemplate()" style="width:100%; margin-top:20px">ZAPISZ SZABLON</button>
        `;
        document.getElementById('ov').style.display='block'; m.style.display='block';
    }
    function saveTemplate() {
        state.config = JSON.parse(document.getElementById('t-area').value);
        closeModal();
    }
</script>
</body>
</html>