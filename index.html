<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>PR RAPORTY v32</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --main: #2c3e50; --acc: #f39c12; --bg: #f4f7f6; --white: #ffffff; --border: #dcdde1; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding-top: 60px; background: var(--bg); }

        .toolbar { position: fixed; top: 0; width: 100%; height: 55px; background: var(--main); color: #fff; display: flex; align-items: center; justify-content: center; gap: 8px; z-index: 1000; padding: 0 10px; }
        .btn { border: none; border-radius: 4px; padding: 8px 12px; font-weight: bold; cursor: pointer; font-size: 10px; text-transform: uppercase; color: #fff; }
        .btn-green { background: #27ae60; } .btn-blue { background: #2980b9; } .btn-orange { background: #f39c12; } .btn-red { background: #e74c3c; } .btn-dark { background: #34495e; }

        /* A4 - Strona 1 zawsze jako całość */
        .page { width: 210mm; min-height: 296mm; background: var(--white); margin: 10px auto; padding: 15mm; position: relative; display: flex; flex-direction: column; box-shadow: 0 0 10px rgba(0,0,0,0.1); page-break-after: always; }
        .page-cover { justify-content: center; text-align: center; height: 297mm; }

        .filter-bar { background: #fff; padding: 10px; margin: 10px auto; width: 210mm; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid var(--acc); }

        .plan-area { position: relative; width: 100%; flex-grow: 1; background: #eee; border: 1px solid #ccc; overflow: hidden; display: flex; align-items: center; justify-content: center; touch-action: none; }
        .plan-img { position: relative; pointer-events: none; transform-origin: center; }
        .dot { position: absolute; width: 34px; height: 34px; border-radius: 50%; border: 2px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; transform: translate(-50%, -50%); z-index: 100; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        .status-zgloszone { background: #e67e22 !important; } 
        .status-niezgloszone { background: #2c3e50 !important; } 
        .status-uwaga { background: #7f8c8d !important; }

        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; width: 96%; max-width: 1000px; border-radius: 12px; z-index: 2001; max-height: 95vh; overflow: hidden; flex-direction: column; }
        .modal-body { overflow-y: auto; flex-grow: 1; padding: 10px; }
        .input { width: 100%; padding: 12px; margin: 5px 0 15px; border: 1px solid var(--border); border-radius: 6px; font-size: 16px; }

        .settings-grid { display: flex; gap: 20px; height: 500px; }
        .sidebar { width: 220px; border-right: 2px solid #eee; display: flex; flex-direction: column; gap: 6px; overflow-y: auto; }
        .tab { padding: 12px; background: #f1f2f6; border: none; text-align: left; cursor: pointer; border-radius: 6px; font-weight: bold; }
        .tab.active { background: var(--acc); color: white; }

        @media print {
            .no-print { display: none !important; }
            .page { margin: 0; border: none; width: 210mm; height: 297mm; }
        }
    </style>
</head>
<body>

<div class="toolbar no-print">
    <button class="btn btn-green" onclick="dodajPietro()">+ PIĘTRO</button>
    <button class="btn btn-blue" onclick="zapiszJSON()">ZAPISZ</button>
    <button class="btn btn-dark" onclick="document.getElementById('file-in').click()">WCZYTAJ</button>
    <button class="btn btn-orange" onclick="otworzUstawienia()">SZCZEGÓŁY</button>
    <button class="btn btn-red" onclick="window.print()">DRUKUJ PDF</button>
</div>

<input type="file" id="file-in" style="display:none" onchange="wczytajJSON(event)">
<div class="overlay" id="overlay" onclick="zamknijModale()"></div>

<div class="modal" id="modal-kropka">
    <div class="modal-body">
        <h2 id="m-naglowek">Edycja Zgłoszenia</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <label>Pomieszczenie:</label>
                <input id="m-pom" class="input">
                <label>Status:</label>
                <select id="m-stat" class="input">
                    <option value="status-zgloszone">Zgłoszone</option>
                    <option value="status-niezgloszone">Niezgłoszone</option>
                    <option value="status-uwaga">Do omówienia</option>
                </select>
                <div id="dropdowns-zakladek"></div>
            </div>
            <div>
                <div id="m-foto-podglad" style="width:100%; height:200px; background:#f8f9fa; border:2px dashed #ccc; display:flex; align-items:center; justify-content:center; cursor:pointer;" onclick="wgrajFotoUsterki()">Dodaj zdjęcie</div>
                <div id="m-zaznaczone-lista" style="background:#f9f9f9; padding:10px; min-height:80px; border:1px solid #ddd; margin-top:10px;"></div>
            </div>
        </div>
        <label>Opis własny:</label>
        <textarea id="m-opis" class="input" style="height:80px"></textarea>
        <label>Norma:</label>
        <input id="m-norma" class="input">
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-green" style="flex:1" onclick="zapiszPunkt()">ZAPISZ</button>
            <button class="btn btn-red" onclick="usunPunkt()">USUŃ</button>
        </div>
    </div>
</div>

<div class="modal" id="modal-ustawienia">
    <h2>Konfiguracja</h2>
    <div class="settings-grid">
        <div class="sidebar" id="ust-zakladki"></div>
        <div class="modal-body" id="ust-kontent"></div>
    </div>
    <div style="margin-top:10px; display:flex; gap:10px;">
        <button class="btn btn-dark" onclick="nowaZakladka()">+ ZAKŁADKA</button>
        <button class="btn btn-green" style="margin-left:auto" onclick="zamknijModale()">ZAMKNIJ</button>
    </div>
</div>

<div id="app"></div>

<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js?v=32');
    }

    let d = {
        meta: { inv:'', adr:'', cli:'', date: new Date().toISOString().split('T')[0], logo:'', mainImg:'' },
        pietra: [],
        szablon: [
            { id: 'pom_fixed', nazwa:'Pomieszczenia', locked: true, kat: [{ nazwa:'Parter', poz:['Salon','Kuchnia'] }] },
            { id: 2, nazwa:'Normy', kat: [{ nazwa:'Tynki', poz:['Odchyłka'] }] }
        ],
        lastPom: ''
    };

    let f_pom = 'wszystkie';
    let f_stat = 'wszystkie';
    let akt = { fi: null, pi: null, img: '', tabId: 'pom_fixed' };

    function render() {
        const root = document.getElementById('app');
        root.innerHTML = '';

        // STRONA 1
        const s1 = document.createElement('div');
        s1.className = 'page page-cover';
        s1.innerHTML = `
            <img src="${d.meta.logo}" style="max-height:100px; cursor:pointer;" onclick="upload('logo')" alt="[LOGO]">
            <h1 style="border-top:4px solid #000; border-bottom:4px solid #000; padding:20px 0; margin:40px 0;">PROTOKÓŁ ODBIORU</h1>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; text-align:left; margin-bottom:40px;">
                <div>Inwestycja: <input class="input" value="${d.meta.inv}" onchange="d.meta.inv=this.value"></div>
                <div>Adres: <input class="input" value="${d.meta.adr}" onchange="d.meta.adr=this.value"></div>
                <div>Zleceniodawca: <input class="input" value="${d.meta.cli}" onchange="d.meta.cli=this.value"></div>
                <div>Data: <input class="input" type="date" value="${d.meta.date}" onchange="d.meta.date=this.value"></div>
            </div>
            <div style="width:100%; height:80mm; background:#eee; cursor:pointer; display:flex; align-items:center; justify-content:center; overflow:hidden;" onclick="upload('main')">
                ${d.meta.mainImg ? `<img src="${d.meta.mainImg}" style="width:100%; height:100%; object-fit:cover;">` : 'KLIKNIJ BY DODAĆ ZDJĘCIE'}
            </div>`;
        root.appendChild(s1);

        // FILTRY
        const filters = document.createElement('div');
        filters.className = 'filter-bar no-print';
        filters.innerHTML = `
            <b>Filtr:</b>
            <select onchange="f_pom=this.value; render()"><option value="wszystkie">Pokoje: Wszystkie</option>${getUnikalnePom().map(p=>`<option value="${p}" ${f_pom==p?'selected':''}>${p}</option>`).join('')}</select>
            <select onchange="f_stat=this.value; render()"><option value="wszystkie">Status: Wszystkie</option><option value="status-zgloszone" ${f_stat=='status-zgloszone'?'selected':''}>Zgłoszone</option></select>
        `;
        root.appendChild(filters);

        // PIĘTRA
        d.pietra.forEach((f, fi) => {
            const sF = document.createElement('div');
            sF.className = 'page';
            const widoczneKropki = f.pts.filter(p => (f_pom=='wszystkie' || p.pom==f_pom) && (f_stat=='wszystkie' || p.stat==f_stat));

            sF.innerHTML = `
                <div style="display:flex; justify-content:space-between; border-bottom:2px solid #333; margin-bottom:10px;">
                    <input class="input" style="border:none; width:200px; margin:0; font-weight:bold;" value="${f.nazwa}" onchange="d.pietra[${fi}].nazwa=this.value">
                    <b>${d.meta.inv}</b>
                </div>
                <div class="plan-area" onclick="klikPlan(event, ${fi})">
                    ${f.img ? `<img src="${f.img}" class="plan-img" style="transform: rotate(${f.rot}deg) scale(${f.scale}); top:${f.offY}px; left:${f.offX}px;">` : '<h2>KLIKNIJ BY WGRAĆ RZUT</h2>'}
                    ${widoczneKropki.map((p) => {
                        const idx = f.pts.indexOf(p);
                        return `<div class="dot ${p.stat}" style="left:${p.x}%; top:${p.y}%;" onclick="event.stopPropagation(); edytujP(${fi}, ${idx})">${idx+1}</div>`;
                    }).join('')}
                </div>
                <div class="no-print" style="padding:10px; background:#eee; display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn btn-dark" onclick="obroc(${fi})">OBRÓĆ</button>
                    Skala: <input type="range" min="0.1" max="4" step="0.01" value="${f.scale}" oninput="skaluj(${fi}, this.value)">
                    X: <input type="range" min="-1000" max="1000" value="${f.offX}" oninput="d.pietra[${fi}].offX=this.value; sync(${fi})">
                    Y: <input type="range" min="-1000" max="1000" value="${f.offY}" oninput="d.pietra[${fi}].offY=this.value; sync(${fi})">
                </div>`;
            root.appendChild(sF);

            // RAPORTY
            for (let i = 0; i < widoczneKropki.length; i += 2) {
                const sL = document.createElement('div');
                sL.className = 'page';
                for (let j = i; j < i + 2 && j < widoczneKropki.length; j++) {
                    const p = widoczneKropki[j];
                    const idx = f.pts.indexOf(p);
                    sL.innerHTML += `
                        <div style="height:135mm; border-bottom:1px solid #eee; padding:20px 0; display:flex; gap:20px; position:relative;">
                            <button class="btn btn-dark no-print" style="position:absolute; right:0;" onclick="edytujP(${fi}, ${idx})">EDYTUJ</button>
                            <div style="width:45%; height:100%; background:#f9f9f9; display:flex; align-items:center; justify-content:center;">
                                ${p.img ? `<img src="${p.img}" style="max-width:100%; max-height:100%;">` : 'BRAK ZDJĘCIA'}
                            </div>
                            <div style="width:55%;">
                                <b style="font-size:18pt; color:var(--acc);">NR ${idx+1}</b>
                                <div style="margin-top:10px;"><b>Lokalizacja:</b> ${p.pom}</div>
                                <div><b>Elementy:</b> ${p.zaz.join(', ')}</div>
                                <div><b>Opis:</b> ${p.opis}</div>
                                ${p.norm ? `<div style="margin-top:20px; color:red;"><b>NORMA:</b> ${p.norm}</div>` : ''}
                            </div>
                        </div>`;
                }
                root.appendChild(sL);
            }
        });
    }

    function sync(fi) {
        const img = document.querySelectorAll('.plan-img')[fi];
        const f = d.pietra[fi];
        img.style.transform = `rotate(${f.rot}deg) scale(${f.scale})`;
        img.style.top = f.offY + 'px';
        img.style.left = f.offX + 'px';
    }

    function getUnikalnePom() {
        let s = new Set();
        d.pietra.forEach(f => f.pts.forEach(p => s.add(p.pom)));
        return Array.from(s);
    }

    function klikPlan(e, fi) {
        if(!d.pietra[fi].img) return upload('plan', fi);
        const r = e.currentTarget.getBoundingClientRect();
        const pi = d.pietra[fi].pts.length;
        d.pietra[fi].pts.push({ x: ((e.clientX - r.left)/r.width)*100, y: ((e.clientY - r.top)/r.height)*100, pom: d.lastPom, opis:'', norm:'', stat:'status-uwaga', img:'', zaz:[] });
        render(); edytujP(fi, pi);
    }

    function edytujP(fi, pi) {
        akt.fi = fi; akt.pi = pi;
        const p = d.pietra[fi].pts[pi];
        akt.img = p.img;
        document.getElementById('m-pom').value = p.pom;
        document.getElementById('m-stat').value = p.stat;
        document.getElementById('m-opis').value = p.opis;
        document.getElementById('m-norma').value = p.norm;
        document.getElementById('m-foto-podglad').innerHTML = p.img ? `<img src="${p.img}" style="height:100%">` : 'Dodaj zdjęcie';
        odswiezZaz(p.zaz);
        generujSel(p);
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('modal-kropka').style.display = 'flex';
    }

    function generujSel(p) {
        const w = document.getElementById('dropdowns-zakladek');
        w.innerHTML = '';
        d.szablon.forEach(z => {
            const s = document.createElement('select'); s.className = 'input';
            s.innerHTML = `<option value="">-- wybierz ${z.nazwa} --</option>` + z.kat.map(k => `<optgroup label="${k.nazwa}">${k.poz.map(poz => `<option value="${poz}">${poz}</option>`).join('')}</optgroup>`).join('');
            s.onchange = (e) => {
                if(e.target.value && !p.zaz.includes(e.target.value)) {
                    p.zaz.push(e.target.value);
                    if(z.id==='pom_fixed') document.getElementById('m-pom').value = e.target.value;
                    odswiezZaz(p.zaz);
                }
            };
            w.appendChild(s);
        });
    }

    function odswiezZaz(lista) {
        document.getElementById('m-zaznaczone-lista').innerHTML = lista.map((z, i) => `<span style="background:#2c3e50; color:#fff; padding:4px 8px; margin:2px; border-radius:10px; display:inline-block; font-size:11px;">${z} <b onclick="d.pietra[akt.fi].pts[akt.pi].zaz.splice(${i},1); odswiezZaz(d.pietra[akt.fi].pts[akt.pi].zaz)">x</b></span>`).join('');
    }

    function zapiszPunkt() {
        const p = d.pietra[akt.fi].pts[akt.pi];
        p.pom = document.getElementById('m-pom').value;
        p.stat = document.getElementById('m-stat').value;
        p.opis = document.getElementById('m-opis').value;
        p.norm = document.getElementById('m-norma').value;
        p.img = akt.img;
        d.lastPom = p.pom;
        zamknijModale(); render();
    }

    function otworzUstawienia() {
        renderT();
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('modal-ustawienia').style.display = 'flex';
    }

    function renderT() {
        document.getElementById('ust-zakladki').innerHTML = d.szablon.map(z => `<button class="tab ${akt.tabId==z.id?'active':''}" onclick="akt.tabId='${z.id}'; renderT()">${z.nazwa}</button>`).join('');
        const z = d.szablon.find(zak => zak.id == akt.tabId);
        const c = document.getElementById('ust-kontent');
        c.innerHTML = `<h3>Zakładka: <input value="${z.nazwa}" onchange="z.nazwa=this.value; renderT()"></h3>`;
        z.kat.forEach((k, ki) => {
            c.innerHTML += `<div style="border:1px solid #ddd; padding:10px; margin-bottom:10px;">
                <b>Kat:</b> <input value="${k.nazwa}" onchange="z.kat[${ki}].nazwa=this.value"> <button onclick="z.kat.splice(${ki},1); renderT()">x</button>
                <div style="margin-top:10px">${k.poz.map((p, pi) => `<input value="${p}" onchange="z.kat[${ki}].poz[${pi}]=this.value"> <button onclick="z.kat[${ki}].poz.splice(${pi},1); renderT()">x</button>`).join('')}</div>
                <button onclick="z.kat[${ki}].poz.push('Nowy'); renderT()">+ POZYCJA</button>
            </div>`;
        });
        c.innerHTML += `<button onclick="z.kat.push({nazwa:'Nowa', poz:[]}); renderT()">+ KATEGORIA</button>`;
    }

    function nowaZakladka() { d.szablon.push({ id: Date.now(), nazwa: 'Nowa', kat: [] }); renderT(); }

    function upload(typ, fi=null) {
        const i = document.createElement('input'); i.type='file';
        i.onchange = e => {
            const r = new FileReader();
            r.onload = ev => {
                if(typ=='logo') d.meta.logo=ev.target.result; else if(typ=='main') d.meta.mainImg=ev.target.result; else if(typ=='plan') d.pietra[fi].img=ev.target.result;
                render();
            }; r.readAsDataURL(e.target.files[0]);
        }; i.click();
    }

    function wgrajFotoUsterki() {
        const i = document.createElement('input'); i.type='file';
        i.onchange = e => {
            const r = new FileReader();
            r.onload = ev => { akt.img = ev.target.result; document.getElementById('m-foto-podglad').innerHTML = `<img src="${ev.target.result}" style="height:100%">`; };
            r.readAsDataURL(e.target.files[0]);
        }; i.click();
    }

    function obroc(fi) { d.pietra[fi].rot = (d.pietra[fi].rot + 90) % 360; render(); }
    function skaluj(fi, v) { d.pietra[fi].scale = v; sync(fi); }
    function zamknijModale() { document.querySelectorAll('.modal, .overlay').forEach(el=>el.style.display='none'); }
    function usunPunkt() { d.pietra[akt.fi].pts.splice(akt.pi,1); zamknijModale(); render(); }
    function dodajPietro() { d.pietra.push({ nazwa:'Poziom '+ (d.pietra.length+1), img:'', pts:[], rot:0, scale:1, offX:0, offY:0 }); render(); }
    function zapiszJSON() {
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(d)], {type:'application/json'}));
        a.download = `Raport.json`; a.click();
    }
    function wczytajJSON(e) {
        const r = new FileReader(); r.onload = ev => { d = JSON.parse(ev.target.result); render(); };
        r.readAsText(e.target.files[0]);
    }

    if(d.pietra.length === 0) dodajPietro();
    render();
</script>
</body>
</html>