<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>PR RAPORTY v22</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --main: #000; --accent: #e67e22; --bg: #f0f2f5; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); margin: 0; padding-top: 70px; }
        
        /* UI */
        .toolbar { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: var(--main); color: #fff; display: flex; align-items: center; justify-content: center; gap: 10px; z-index: 1000; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 11px; color: #fff; text-transform: uppercase; }
        
        /* PDF Layout */
        .page { width: 210mm; min-height: 295mm; background: #fff; margin: 0 auto 20px; padding: 10mm; position: relative; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 10px; height: 60px; }
        .logo-main { max-height: 120px; max-width: 300px; object-fit: contain; } /* Większe logo na okładkę */
        .logo-header { max-height: 45px; max-width: 150px; object-fit: contain; }
        
        /* System 2 usterki na stronę */
        .defect-row { height: 130mm; border: 1px solid #eee; margin-bottom: 10mm; padding: 10px; display: flex; flex-direction: column; break-inside: avoid; }
        .defect-img-box { flex-grow: 1; height: 80mm; display: flex; justify-content: center; align-items: center; background: #f9f9f9; overflow: hidden; border-radius: 5px; }
        .defect-img-box img { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* Rzuty */
        .plan-box { width: 100%; height: 180mm; background: #fafafa; position: relative; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; }
        .plan-img { max-width: 100%; max-height: 100%; }
        .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }
        .dot { position: absolute; width: 28px; height: 28px; border-radius: 50%; border: 2px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; transform: translate(-50%, -50%); font-weight: bold; font-size: 13px; z-index: 500; }
        
        /* Formularze */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; width: 90%; max-width: 500px; border-radius: 8px; z-index: 2001; }
        .input { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        
        .c-reported { background: #e67e22; } .c-not_reported { background: #2c3e50; } .c-to_discuss { background: #7f8c8d; }
        
        @media print { 
            body { padding: 0; background: #fff; } 
            .no-print { display: none !important; } 
            .page { margin: 0; box-shadow: none; width: 210mm; height: 296mm; page-break-after: always; overflow: hidden; }
            .defect-row:nth-of-type(2n) { page-break-after: always; }
        }
    </style>
</head>
<body>

<div class="toolbar no-print">
    <button class="btn" style="background:#27ae60" onclick="addFloor()">+ Piętro</button>
    <button class="btn" style="background:#2980b9" onclick="exportData()">Zapisz JSON</button>
    <button class="btn" style="background:#8e44ad" onclick="document.getElementById('file-in').click()">Wczytaj</button>
    <button class="btn" style="background:#e74c3c" onclick="window.print()">Drukuj PDF</button>
    <button class="btn" style="background:#333" onclick="resetApp()">Nowy</button>
</div>

<input type="file" id="file-in" style="display:none" onchange="importData(event)">
<div class="modal-overlay" id="ov" onclick="closeModal()"></div>

<div class="modal" id="edit-modal">
    <h3 id="m-title" style="margin:0 0 15px">Punkt</h3>
    <label>Pomieszczenie:</label>
    <input id="m-room" class="input" list="room-list">
    <div id="m-img-btn" style="padding:15px; background:#f0f0f0; border:1px dashed #999; text-align:center; cursor:pointer; margin-bottom:10px;" onclick="uploadImg('defect')">DODAJ / ZMIEŃ ZDJĘCIE</div>
    <textarea id="m-desc" class="input" style="height:80px" placeholder="Opis usterki..."></textarea>
    <input id="m-norm" class="input" placeholder="Norma / Podstawa">
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
        <button class="btn c-reported" onclick="savePoint('reported')">Zgłoszona</button>
        <button class="btn c-not_reported" onclick="savePoint('not_reported')">Niezgłosz.</button>
        <button class="btn c-to_discuss" onclick="savePoint('to_discuss')">Uwaga</button>
    </div>
    <button class="btn" style="background:#c0392b; width:100%; margin-top:10px;" onclick="deletePoint()">Usuń punkt</button>
</div>

<div id="app"></div>
<datalist id="room-list"></datalist>

<script>
    let state = JSON.parse(localStorage.getItem('pr_v22_state')) || {
        meta: { inv:'', adr:'', date:'', cli:'', logo:'', mainImg:'' },
        floors: []
    };
    let config = { rooms: ['Salon', 'Kuchnia', 'Łazienka', 'Sypialnia 1', 'Sypialnia 2', 'Przedpokój', 'Balkon'] };
    let active = { f: null, d: null, tempImg: null };

    // Optymalizacja szybkości - zapis tylko przy akcji
    function fastSave() { localStorage.setItem('pr_v22_state', JSON.stringify(state)); }

    function render() {
        const root = document.getElementById('app'); root.innerHTML = '';
        
        // 1. OKŁADKA
        const cover = document.createElement('div'); cover.className = 'page';
        cover.innerHTML = `
            <div style="text-align:center; height:100%; display:flex; flex-direction:column; justify-content:center; padding:20mm;">
                <div onclick="uploadImg('logo')" style="cursor:pointer; margin-bottom:40px;">
                    ${state.meta.logo ? `<img src="${state.meta.logo}" class="logo-main">` : '<h1>[ KLIKNIJ BY DODAĆ LOGO ]</h1>'}
                </div>
                <h1 style="font-size:35px; border-bottom:4px solid #000; padding-bottom:10px;">RAPORT TECHNICZNY</h1>
                <div style="text-align:left; margin-top:30px;">
                    <input class="input" placeholder="Inwestycja" value="${state.meta.inv}" oninput="state.meta.inv=this.value; fastSave()">
                    <input class="input" placeholder="Adres" value="${state.meta.adr}" oninput="state.meta.adr=this.value; fastSave()">
                    <input class="input" type="date" value="${state.meta.date}" oninput="state.meta.date=this.value; fastSave()">
                    <input class="input" placeholder="Klient" value="${state.meta.cli}" oninput="state.meta.cli=this.value; fastSave()">
                </div>
                <div style="width:100%; height:80mm; background:#eee; margin-top:20px; display:flex; justify-content:center; align-items:center; overflow:hidden; border:1px solid #ddd; cursor:pointer;" onclick="uploadImg('main')">
                    ${state.meta.mainImg ? `<img src="${state.meta.mainImg}" style="width:100%; height:100%; object-fit:cover;">` : 'KLIKNIJ BY DODAĆ ZDJĘCIE GŁÓWNE'}
                </div>
            </div>`;
        root.appendChild(cover);

        // 2. PIĘTRA I USTERKI
        state.floors.forEach((f, fi) => {
            const fPage = document.createElement('div'); fPage.className = 'page';
            fPage.innerHTML = `
                <div class="header">
                    <img src="${state.meta.logo}" class="logo-header">
                    <div style="text-align:right"><b>${f.name}</b><br>${state.meta.inv}</div>
                </div>
                <div class="plan-box" onclick="addDot(event, ${fi})">
                    ${f.plan ? `<img src="${f.plan}" class="plan-img rot-${f.rotation || 0}">` : 'KLIKNIJ BY WGRAĆ RZUT'}
                    ${f.defects.map((d, di) => `
                        <div class="dot c-${d.status}" style="left:${d.x}%; top:${d.y}%;" onclick="event.stopPropagation(); openModal(${fi}, ${di})">${di+1}</div>
                    `).join('')}
                </div>
                <div class="no-print" style="margin-top:10px; display:flex; gap:10px;">
                    <button class="btn" style="background:#333" onclick="rotate(${fi})">Obróć ↻</button>
                    <button class="btn" style="background:#c0392b" onclick="deleteFloor(${fi})">Usuń piętro</button>
                    <input value="${f.name}" oninput="state.floors[${fi}].name=this.value; fastSave()" style="padding:5px;">
                </div>`;
            root.appendChild(fPage);

            // GESTOR USTEREK (2 na stronę)
            for(let i=0; i < f.defects.length; i+=2) {
                const dPage = document.createElement('div'); dPage.className = 'page';
                dPage.innerHTML = `<div class="header"><img src="${state.meta.logo}" class="logo-header"><div>${state.meta.inv}</div></div>`;
                
                for(let j=i; j<i+2 && j<f.defects.length; j++) {
                    const d = f.defects[j];
                    dPage.innerHTML += `
                        <div class="defect-row">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <b style="color:var(--accent); text-transform:uppercase;">${j+1}. ${d.room || 'Inne'}</b>
                                <small>${d.status}</small>
                            </div>
                            <div style="font-size:14px; margin-bottom:5px;">${d.desc || 'Brak opisu.'}</div>
                            <div class="defect-img-box">${d.img ? `<img src="${d.img}">` : 'BRAK ZDJĘCIA'}</div>
                            ${d.norm ? `<div style="font-size:11px; margin-top:5px; color:red;">NORMA: ${d.norm}</div>` : ''}
                        </div>`;
                }
                root.appendChild(dPage);
            }
        });
        updateDatalist();
    }

    function addDot(e, fi) {
        if(!state.floors[fi].plan) return uploadImg('plan', fi);
        const r = e.currentTarget.getBoundingClientRect();
        const di = state.floors[fi].defects.length;
        state.floors[fi].defects.push({ x:((e.clientX-r.left)/r.width)*100, y:((e.clientY-r.top)/r.height)*100, room:'', desc:'', status:'to_discuss', img:'', norm:'' });
        fastSave(); render(); openModal(fi, di);
    }

    function openModal(fi, di) {
        active = { f: fi, d: di, tempImg: state.floors[fi].defects[di].img };
        const d = state.floors[fi].defects[di];
        document.getElementById('m-title').innerText = `Punkt ${di+1}`;
        document.getElementById('m-room').value = d.room;
        document.getElementById('m-desc').value = d.desc;
        document.getElementById('m-norm').value = d.norm;
        document.getElementById('m-img-btn').innerText = d.img ? "ZDJĘCIE DODANE - KLIKNIJ BY ZMIENIĆ" : "DODAJ ZDJĘCIE";
        document.getElementById('ov').style.display = 'block';
        document.getElementById('edit-modal').style.display = 'block';
        document.getElementById('m-desc').focus();
    }

    function savePoint(status) {
        const d = state.floors[active.f].defects[active.d];
        d.room = document.getElementById('m-room').value;
        d.desc = document.getElementById('m-desc').value;
        d.norm = document.getElementById('m-norm').value;
        d.status = status;
        d.img = active.tempImg;
        if(d.room && !config.rooms.includes(d.room)) config.rooms.push(d.room);
        closeModal(); fastSave(); render();
    }

    function uploadImg(type, fi) {
        const i = document.createElement('input'); i.type='file'; i.accept='image/*';
        i.onchange = e => {
            const r = new FileReader(); r.onload = ev => {
                const res = ev.target.result;
                if(type==='logo') state.meta.logo = res;
                else if(type==='main') state.meta.mainImg = res;
                else if(type==='plan') state.floors[fi].plan = res;
                else if(type==='defect') {
                    active.tempImg = res;
                    document.getElementById('m-img-btn').innerText = "ZDJĘCIE DODANE!";
                }
                fastSave(); render();
            }; r.readAsDataURL(e.target.files[0]);
        }; i.click();
    }

    function rotate(fi) { state.floors[fi].rotation = ((state.floors[fi].rotation || 0)+90)%360; fastSave(); render(); }
    function addFloor() { state.floors.push({ name:'PIĘTRO '+(state.floors.length+1), plan:'', defects:[], rotation:0 }); fastSave(); render(); }
    function deleteFloor(fi) { if(confirm("Usunąć piętro?")) { state.floors.splice(fi,1); fastSave(); render(); } }
    function deletePoint() { state.floors[active.f].defects.splice(active.d,1); closeModal(); fastSave(); render(); }
    function closeModal() { document.getElementById('ov').style.display='none'; document.getElementById('edit-modal').style.display='none'; }
    function updateDatalist() { document.getElementById('room-list').innerHTML = config.rooms.map(r=>`<option value="${r}">`).join(''); }
    
    function exportData() {
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(state)], {type:'application/json'}));
        a.download = `Raport_${state.meta.inv || 'PR'}.json`; a.click();
    }

    function importData(e) {
        const r = new FileReader(); r.onload = ev => {
            try {
                const data = JSON.parse(ev.target.result);
                // Kompatybilność ze starymi wersjami
                state = { 
                    meta: data.meta || { inv:'', adr:'', date:'', cli:'', logo:'', mainImg:'' },
                    floors: data.floors || []
                };
                fastSave(); render();
            } catch(err) { alert("Błąd wczytywania pliku!"); }
        }; r.readAsText(e.target.files[0]);
    }

    function resetApp() { if(confirm("Wyczyścić wszystko?")) { state = { meta:{inv:'', adr:'', date:'', cli:'', logo:'', mainImg:''}, floors:[] }; addFloor(); fastSave(); render(); } }

    if(!state.floors.length) addFloor();
    render();
</script>
</body>
</html>