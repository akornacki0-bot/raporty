<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>PR RAPORTY v25</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --dark: #1a1a1a; --accent: #f39c12; --bg: #f0f2f5; --white: #ffffff; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-top: 65px; color: var(--dark); }

        /* Toolbar */
        .toolbar { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: var(--dark); color: #fff; display: flex; align-items: center; justify-content: center; gap: 8px; z-index: 1000; padding: 0 10px; }
        .btn { padding: 10px 14px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 11px; text-transform: uppercase; color: #fff; }

        /* Dokument PDF */
        .page { width: 210mm; min-height: 296mm; background: var(--white); margin: 0 auto 20px; padding: 15mm; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--dark); padding-bottom: 10px; margin-bottom: 20px; }
        .logo-img { max-height: 60px; max-width: 200px; object-fit: contain; }

        /* Plan i Kropki */
        .plan-container { width: 100%; height: 180mm; background: #eee; position: relative; display: flex; align-items: center; justify-content: center; border: 1px solid #ccc; overflow: hidden; }
        .plan-img { max-width: 100%; max-height: 100%; object-fit: contain; pointer-events: none; }
        .dot { position: absolute; width: 32px; height: 32px; border-radius: 50%; border: 2px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; transform: translate(-50%, -50%); font-weight: bold; cursor: pointer; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.4); }

        /* Wydruk Usterek */
        .defect-box { height: 125mm; border-bottom: 1px solid #eee; padding: 10px 0; display: flex; flex-direction: column; break-inside: avoid; }
        .defect-img-wrap { width: 100%; height: 80mm; background: #f9f9f9; display: flex; justify-content: center; align-items: center; border: 1px solid #ddd; margin: 10px 0; border-radius: 4px; overflow: hidden; }
        .defect-img-wrap img { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* Modale */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 25px; width: 95%; max-width: 500px; border-radius: 12px; z-index: 2001; max-height: 90vh; overflow-y: auto; }
        .input { width: 100%; padding: 12px; margin: 6px 0 16px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; display: block; }
        
        .c-reported { background: #e67e22; } .c-not_reported { background: #2c3e50; } .c-to_discuss { background: #7f8c8d; }

        @media print { 
            .no-print { display: none !important; } 
            .page { margin: 0; box-shadow: none; page-break-after: always; }
            body { padding: 0; background: #fff; }
        }
    </style>
</head>
<body>

<div class="toolbar no-print">
    <button class="btn" style="background:#27ae60" onclick="addFloor()">+ PIĘTRO</button>
    <button class="btn" style="background:#2980b9" onclick="manualSave()">ZAPISZ</button>
    <button class="btn" style="background:#8e44ad" onclick="document.getElementById('file-input').click()">WCZYTAJ</button>
    <button class="btn" style="background:#f39c12" onclick="openConfig()">USTAWIENIA</button>
    <button class="btn" style="background:#e74c3c" onclick="window.print()">DRUKUJ PDF</button>
    <button class="btn" style="background:#333" onclick="resetApp()">RESET</button>
</div>

<input type="file" id="file-input" style="display:none" onchange="importData(event)">
<div class="overlay" id="overlay" onclick="closeModal()"></div>

<div class="modal" id="edit-modal">
    <h2 id="modal-title" style="margin-top:0">Edycja Punktu</h2>
    <label>Pomieszczenie:</label>
    <input id="m-room" class="input" list="room-list">
    
    <div id="m-img-area" style="width:100%; height:160px; background:#f4f4f4; border:2px dashed #bbb; display:flex; justify-content:center; align-items:center; cursor:pointer; margin-bottom:15px; border-radius:8px; overflow:hidden;" onclick="triggerUpload('defect')">Kliknij, aby dodać zdjęcie</div>
    
    <label>Opis usterki:</label>
    <textarea id="m-desc" class="input" style="height:100px"></textarea>
    
    <label>Norma / Podstawa:</label>
    <input id="m-norm" class="input">
    
    <div id="m-checklist-area" style="background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:15px; max-height:150px; overflow-y:auto; border:1px solid #eee;"></div>

    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
        <button class="btn c-reported" onclick="savePointData('reported')">ZGŁOSZONA</button>
        <button class="btn c-not_reported" onclick="savePointData('not_reported')">NIEZGŁ.</button>
        <button class="btn c-to_discuss" onclick="savePointData('to_discuss')">UWAGA</button>
    </div>
    <button class="btn" style="background:#c0392b; width:100%; margin-top:15px;" onclick="deletePoint()">USUŃ PUNKT</button>
</div>

<div class="modal" id="config-modal">
    <h2>Konfiguracja</h2>
    <textarea id="cfg-text" class="input" style="height:250px"></textarea>
    <button class="btn" style="background:#27ae60; width:100%" onclick="saveConfig()">ZAPISZ</button>
</div>

<div id="main-app"></div>
<datalist id="room-list"></datalist>

<script>
    let appData = JSON.parse(localStorage.getItem('pr_raport_v25')) || {
        meta: { inv:'', adr:'', date:'', cli:'', logo:'', mainImg:'' },
        floors: [],
        config: {
            rooms: ['Salon', 'Kuchnia', 'Łazienka', 'Przedpokój'],
            checklist: { "Ogólne": ["Piony", "Tynki"], "Okna": ["Rysy"] }
        }
    };

    let active = { fIdx: null, dIdx: null, tempImg: '' };

    window.onbeforeunload = () => "Masz niezapisane zmiany!";

    function manualSave() {
        localStorage.setItem('pr_raport_v25', JSON.stringify(appData));
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(appData)], {type:'application/json'}));
        a.download = `Raport_${appData.meta.inv || 'Projekt'}.json`; a.click();
    }

    function render() {
        const root = document.getElementById('main-app'); root.innerHTML = '';
        
        // Okładka
        const cover = createPage('STRONA TYTUŁOWA');
        cover.innerHTML += `
            <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:center; text-align:center;">
                <div onclick="triggerUpload('logo')" style="cursor:pointer; margin-bottom:30px;">
                    ${appData.meta.logo ? `<img src="${appData.meta.logo}" style="max-height:120px;">` : '<h1>[ KLIKNIJ BY DODAĆ LOGO ]</h1>'}
                </div>
                <h1 style="font-size:40px; border-bottom:4px solid #000; padding-bottom:15px; margin-bottom:40px;">PROTOKÓŁ ODBIORU</h1>
                <div style="text-align:left; max-width:500px; margin:0 auto; width:100%;">
                    <input class="input" placeholder="Inwestycja" value="${appData.meta.inv}" onchange="appData.meta.inv=this.value">
                    <input class="input" placeholder="Adres" value="${appData.meta.adr}" onchange="appData.meta.adr=this.value">
                    <input class="input" type="date" value="${appData.meta.date}" onchange="appData.meta.date=this.value">
                    <input class="input" placeholder="Klient" value="${appData.meta.cli}" onchange="appData.meta.cli=this.value">
                </div>
                <div style="width:100%; height:90mm; background:#eee; margin-top:20px; border-radius:10px; overflow:hidden; cursor:pointer; border:1px solid #ccc;" onclick="triggerUpload('main')">
                    ${appData.meta.mainImg ? `<img src="${appData.meta.mainImg}" style="width:100%; height:100%; object-fit:cover;">` : 'ZDJĘCIE GŁÓWNE'}
                </div>
            </div>`;
        root.appendChild(cover);

        // Piętra
        appData.floors.forEach((f, fi) => {
            const fPage = createPage(f.name);
            fPage.innerHTML += `
                <div class="plan-container" onclick="addPoint(event, ${fi})">
                    ${f.plan ? `<img src="${f.plan}" class="plan-img" style="transform:rotate(${f.rot || 0}deg)">` : '<h2>KLIKNIJ ABY WGRAĆ RZUT</h2>'}
                    ${f.defects.map((d, di) => `<div class="dot c-${d.status}" style="left:${d.x}%; top:${d.y}%;" onclick="event.stopPropagation(); openPoint(${fi}, ${di})">${di+1}</div>`).join('')}
                </div>
                <div class="no-print" style="padding:10px; display:flex; gap:10px;">
                    <button class="btn" style="background:#333" onclick="rotateFloor(${fi})">OBRÓĆ</button>
                    <button class="btn" style="background:#c0392b" onclick="deleteFloor(${fi})">USUŃ PIĘTRO</button>
                    <input class="input" style="width:200px; margin:0;" value="${f.name}" onchange="appData.floors[${fi}].name=this.value; render()">
                </div>`;
            root.appendChild(fPage);

            // Usterki 2 na stronę
            for (let i = 0; i < f.defects.length; i += 2) {
                const dPage = createPage('SZCZEGÓŁY USTEREK');
                for (let j = i; j < i + 2 && j < f.defects.length; j++) {
                    const d = f.defects[j];
                    dPage.innerHTML += `
                        <div class="defect-box">
                            <div style="display:flex; justify-content:space-between; font-weight:bold; color:var(--accent);">
                                <span>PUNKT ${j + 1}: ${d.room || 'Brak nazwy'}</span>
                                <span style="font-size:10px; color:#555">${d.status.toUpperCase()}</span>
                            </div>
                            <div style="font-size:14px; margin:10px 0;">${d.desc || 'Brak opisu.'}</div>
                            <div class="defect-img-wrap">${d.img ? `<img src="${d.img}">` : 'BRAK ZDJĘCIA'}</div>
                            ${d.norm ? `<div style="font-size:11px; color:red; border-top:1px dashed #ccc; padding-top:5px;">NORMA: ${d.norm}</div>` : ''}
                        </div>`;
                }
                root.appendChild(dPage);
            }
        });
        updateDatalists();
    }

    function createPage(title) {
        const p = document.createElement('div'); p.className = 'page';
        p.innerHTML = `<div class="header">
            ${appData.meta.logo ? `<img src="${appData.meta.logo}" class="logo-img">` : '<b>RAPORT</b>'}
            <div style="text-align:right; font-size:12px;"><b>${appData.meta.inv || '---'}</b><br>${title}</div>
        </div>`;
        return p;
    }

    function addPoint(e, fi) {
        if(!appData.floors[fi].plan) return triggerUpload('plan', fi);
        const rect = e.currentTarget.getBoundingClientRect();
        const di = appData.floors[fi].defects.length;
        appData.floors[fi].defects.push({
            x: ((e.clientX - rect.left) / rect.width) * 100,
            y: ((e.clientY - rect.top) / rect.height) * 100,
            room: '', desc: '', status: 'to_discuss', img: '', norm: '', checks: {}
        });
        render(); 
        openPoint(fi, di); // Wywołanie edycji natychmiast po postawieniu kropki
    }

    function openPoint(fi, di) {
        active.fIdx = fi; active.dIdx = di;
        const d = appData.floors[fi].defects[di];
        active.tempImg = d.img || '';
        
        document.getElementById('modal-title').innerText = `Edycja Punktu ${di+1}`;
        document.getElementById('m-room').value = d.room || '';
        document.getElementById('m-desc').value = d.desc || '';
        document.getElementById('m-norm').value = d.norm || '';
        document.getElementById('m-img-area').innerHTML = d.img ? `<img src="${d.img}" style="height:100%">` : 'Dodaj zdjęcie';
        
        const cArea = document.getElementById('m-checklist-area'); cArea.innerHTML = '';
        Object.entries(appData.config.checklist).forEach(([cat, items]) => {
            cArea.innerHTML += `<div style="font-weight:bold; font-size:12px; margin:10px 0 5px;">${cat}</div>`;
            items.forEach(it => {
                const key = `${cat}:${it}`;
                cArea.innerHTML += `<label style="display:flex; align-items:center; gap:8px; margin-bottom:5px; font-size:14px;">
                    <input type="checkbox" ${d.checks && d.checks[key] ? 'checked' : ''} onchange="toggleCheck('${key}')"> ${it}
                </label>`;
            });
        });
        
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('edit-modal').style.display = 'block';
    }

    function toggleCheck(key) {
        const d = appData.floors[active.fIdx].defects[active.dIdx];
        if(!d.checks) d.checks = {};
        d.checks[key] = !d.checks[key];
    }

    function savePointData(status) {
        const d = appData.floors[active.fIdx].defects[active.dIdx];
        d.room = document.getElementById('m-room').value;
        d.desc = document.getElementById('m-desc').value;
        d.norm = document.getElementById('m-norm').value;
        d.status = status;
        d.img = active.tempImg;
        if(d.room && !appData.config.rooms.includes(d.room)) appData.config.rooms.push(d.room);
        closeModal(); render();
    }

    function triggerUpload(type, fi) {
        const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
        input.onchange = e => {
            const reader = new FileReader();
            reader.onload = ev => {
                const b64 = ev.target.result;
                if(type === 'logo') appData.meta.logo = b64;
                else if(type === 'main') appData.meta.mainImg = b64;
                else if(type === 'plan') appData.floors[fi].plan = b64;
                else if(type === 'defect') {
                    active.tempImg = b64;
                    document.getElementById('m-img-area').innerHTML = `<img src="${b64}" style="height:100%">`;
                }
                render();
            };
            reader.readAsDataURL(e.target.files[0]);
        }; input.click();
    }

    function rotateFloor(fi) { appData.floors[fi].rot = ((appData.floors[fi].rot || 0) + 90) % 360; render(); }
    function addFloor() { appData.floors.push({ name: 'Piętro '+(appData.floors.length+1), plan:'', defects:[], rot:0 }); render(); }
    function deleteFloor(fi) { if(confirm("Usunąć?")) { appData.floors.splice(fi,1); render(); } }
    function deletePoint() { appData.floors[active.fIdx].defects.splice(active.dIdx,1); closeModal(); render(); }
    function closeModal() { document.getElementById('overlay').style.display='none'; document.getElementById('edit-modal').style.display='none'; document.getElementById('config-modal').style.display='none'; }
    function updateDatalists() { document.getElementById('room-list').innerHTML = appData.config.rooms.map(r=>`<option value="${r}">`).join(''); }

    function openConfig() {
        let val = ""; Object.entries(appData.config.checklist).forEach(([k,v]) => val += `${k}: ${v.join(', ')}\n`);
        document.getElementById('cfg-text').value = val;
        document.getElementById('overlay').style.display='block';
        document.getElementById('config-modal').style.display='block';
    }

    function saveConfig() {
        appData.config.checklist = {};
        document.getElementById('cfg-text').value.split('\n').forEach(line => {
            if(line.includes(':')) {
                const [k, v] = line.split(':');
                appData.config.checklist[k.trim()] = v.split(',').map(i=>i.trim()).filter(i=>i);
            }
        });
        closeModal(); render();
    }

    function importData(e) {
        const reader = new FileReader();
        reader.onload = ev => {
            try {
                const imported = JSON.parse(ev.target.result);
                // Walidacja danych pod v25
                appData = imported;
                if(!appData.config) appData.config = { rooms:[], checklist:{} };
                appData.floors.forEach(f => f.defects.forEach(d => { if(!d.checks) d.checks = {}; }));
                render();
            } catch(err) { alert("Błąd wczytywania!"); }
        }; reader.readAsText(e.target.files[0]);
    }

    function resetApp() { if(confirm("WYCZYŚCIĆ WSZYSTKO?")) { localStorage.clear(); location.reload(); } }

    if(appData.floors.length === 0) addFloor();
    render();
</script>
</body>
</html>