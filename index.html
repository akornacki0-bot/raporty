<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>RAPORT PRO v40 - FINAL</title>
    <style>
        :root { --p: #ff8c00; --d: #1a1a1a; --border: #000; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #333; padding-top: 70px; }

        /* Toolbar */
        .toolbar { position: fixed; top: 0; width: 100%; height: 65px; background: var(--d); color: white; display: flex; align-items: center; padding: 0 20px; z-index: 9999; gap: 15px; border-bottom: 4px solid var(--p); }
        .btn { padding: 12px 18px; border: none; border-radius: 4px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 12px; color: white; transition: 0.2s; }
        .btn-p { background: var(--p); }
        .btn-s { background: #444; border: 1px solid #666; }
        .btn-red { background: #c0392b; }

        /* Kontener A4 */
        .page { width: 210mm; min-height: 296mm; background: white; margin: 20px auto; padding: 15mm; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.5); page-break-after: always; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Dane Inwestycji */
        .header-logo { height: 45mm; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 15px; }
        .header-logo img { max-height: 100%; max-width: 100%; object-fit: contain; }
        .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #f9f9f9; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .f-group label { display: block; font-size: 11px; font-weight: 900; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        .f-group input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; font-weight: 600; }

        /* Rzut */
        .plan-header { border-bottom: 3px solid #000; padding-bottom: 5px; margin-bottom: 15px; font-weight: 900; font-size: 20px; display: flex; justify-content: space-between; }
        .plan-wrap { width: 100%; border: 2px solid #000; position: relative; background: #fff; cursor: crosshair; line-height: 0; }
        .plan-img { width: 100%; height: auto; }
        .dot { position: absolute; width: 32px; height: 32px; background: var(--p); color: white; border: 2px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; transform: translate(-50%, -50%); z-index: 100; box-shadow: 0 3px 6px rgba(0,0,0,0.4); }

        /* Modal - TABELA ZG≈ÅOSZENIA */
        #ov { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; }
        #modal { display: none; position: fixed; top: 5%; left: 50%; transform: translateX(-50%); background: white; width: 95%; max-width: 750px; padding: 30px; border-radius: 15px; z-index: 10001; max-height: 90vh; overflow-y: auto; }
        
        .m-section { margin-bottom: 20px; }
        .m-section label { display: block; font-weight: 900; font-size: 13px; color: #333; margin-bottom: 8px; text-transform: uppercase; }
        .m-section input, .m-section textarea { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 17px; font-family: inherit; }
        
        .chip-box { background: #f0f0f0; padding: 15px; border-radius: 10px; border: 1px solid #ddd; }
        .chip { display: inline-block; padding: 10px 14px; background: white; border: 1px solid #ccc; border-radius: 6px; font-size: 13px; font-weight: 700; cursor: pointer; margin: 4px; }
        .chip:hover { background: var(--p); color: white; border-color: var(--p); }

        /* Raport PDF */
        .defect-row { border: 2px solid #eee; padding: 20px; height: 120mm; display: flex; gap: 25px; margin-bottom: 15px; page-break-inside: avoid; border-radius: 10px; }
        .info-col { flex: 1; }
        .img-col { width: 95mm; height: 85mm; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; background: #fafafa; border-radius: 8px; overflow: hidden; }
        .img-col img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .point-tag { background: var(--p); color: white; padding: 6px 14px; font-weight: 900; font-size: 14px; border-radius: 4px; display: inline-block; margin-bottom: 15px; }

        @media print { .no-print { display: none !important; } .page { margin: 0; box-shadow: none; } body { background: white; padding: 0; } }
    </style>
</head>
<body>

<div class="toolbar no-print">
    <button class="btn btn-p" onclick="addFloor()">+ KONDYGNACJA</button>
    <button class="btn btn-s" onclick="openTemplateEditor()">EDYCJA SZABLONU</button>
    <div style="flex-grow:1; text-align:center; font-weight:900;" id="title-nav">RAPORT ODBIORU</div>
    <button class="btn btn-s" onclick="document.getElementById('json-input').click()">WCZYTAJ JSON</button>
    <button class="btn btn-p" onclick="saveJSON()">ZAPISZ PROJEKT</button>
    <button class="btn btn-p" style="background:#d35400" onclick="window.print()">DRUKUJ PDF</button>
</div>
<input type="file" id="json-input" style="display:none" onchange="importJSON(event)">

<div id="ov" onclick="saveAndClose()"></div>
<div id="modal"></div>
<div id="app"></div>

<script>
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

    let state = {
        meta: { inv: '', adr: '', cli: '', date: new Date().toISOString().split('T')[0], logo: '', main: '' },
        floors: [],
        config: { rooms: [], categories: [] }
    };

    let active = { fi: null, di: null, lastRoom: '' };
    let gCounter = 1;

    // Pobranie konfiguracji
    fetch('config.json').then(r => r.json()).then(data => { state.config = data; render(); });

    async function toB64(file) {
        return new Promise(res => {
            const r = new FileReader();
            r.onload = e => res(e.target.result);
            r.readAsDataURL(file);
        });
    }

    function addFloor() {
        const i = document.createElement('input'); i.type = 'file';
        i.onchange = async e => {
            const b = await toB64(e.target.files[0]);
            state.floors.push({ name: 'Poziom '+(state.floors.length+1), img: b, defects: [], locked: false });
            render();
        };
        i.click();
    }

    function clickPlan(e, fi) {
        if(!state.floors[fi].locked) return;
        const r = e.currentTarget.getBoundingClientRect();
        const x = ((e.clientX - r.left) / r.width) * 100;
        const y = ((e.clientY - r.top) / r.height) * 100;
        
        state.floors[fi].defects.push({
            id: gCounter++, x, y, room: active.lastRoom, desc: '', img: '', norm: ''
        });
        render();
        openEdit(fi, state.floors[fi].defects.length - 1);
    }

    function openEdit(fi, di) {
        active.fi = fi; active.di = di;
        const d = state.floors[fi].defects[di];
        const m = document.getElementById('modal');
        m.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                <h2 style="margin:0; color:var(--p)">PUNKT NR ${d.id}</h2>
                <button class="btn btn-red" onclick="deleteDefect()">USU≈É PUNKT</button>
            </div>
            <div class="m-section">
                <label>Pomieszczenie:</label>
                <input id="m-room" list="rooms" value="${d.room}" onchange="active.lastRoom=this.value">
                <datalist id="rooms">${state.config.rooms.map(r=>`<option value="${r}">`).join('')}</datalist>
            </div>
            <div class="m-section">
                <label>Opis usterki:</label>
                <textarea id="m-desc" rows="4" autofocus>${d.desc}</textarea>
            </div>
            <div class="m-section">
                <label>Zdjƒôcie:</label>
                <input type="file" accept="image/*" capture="environment" onchange="updatePhoto(event)">
                <div id="m-prev" style="margin-top:10px">${d.img?`<img src="${d.img}" width="200" style="border-radius:8px">`:''}</div>
            </div>
            <div class="chip-box">
                <label>Baza wiedzy:</label>
                ${state.config.categories.map(c => `
                    <div style="font-size:11px; font-weight:900; color:var(--p); margin:10px 0 5px 5px">${c.name.toUpperCase()}</div>
                    ${c.items.map(i => `<div class="chip" onclick="appendTxt('${i}')">${i}</div>`).join('')}
                `).join('')}
            </div>
            <div class="m-section" style="margin-top:20px">
                <label>Norma / Podstawa / Uwagi:</label>
                <input id="m-norm" value="${d.norm}">
            </div>
            <button class="btn btn-p" style="width:100%; padding:18px; font-size:16px" onclick="saveAndClose()">ZAPISZ ZG≈ÅOSZENIE</button>
        `;
        document.getElementById('ov').style.display = 'block';
        m.style.display = 'block';
    }

    function appendTxt(t) { const o = document.getElementById('m-desc'); o.value += (o.value?', ':'')+t; }
    async function updatePhoto(e) { 
        state.floors[active.fi].defects[active.di].img = await toB64(e.target.files[0]);
        document.getElementById('m-prev').innerHTML = `<img src="${state.floors[active.fi].defects[active.di].img}" width="200" style="border-radius:8px">`;
    }
    function deleteDefect() { if(confirm("UsunƒÖƒá punkt?")) { state.floors[active.fi].defects.splice(active.di, 1); saveAndClose(); } }

    function saveAndClose() {
        const d = state.floors[active.fi].defects[active.di];
        if(d) {
            d.room = document.getElementById('m-room').value;
            d.desc = document.getElementById('m-desc').value;
            d.norm = document.getElementById('m-norm').value;
        }
        document.getElementById('ov').style.display='none';
        document.getElementById('modal').style.display='none';
        render();
    }

    function render() {
        const root = document.getElementById('app'); root.innerHTML = '';
        document.getElementById('title-nav').innerText = `PROJEKT: ${state.meta.inv || '---'}`;
        
        // P1
        const p1 = document.createElement('div'); p1.className = 'page';
        p1.innerHTML = `
            <div class="header-logo" onclick="upMeta('logo')">${state.meta.logo?`<img src="${state.meta.logo}">`:'DODAJ LOGO'}</div>
            <h1 style="text-align:center; font-size:38px; font-weight:900; margin:30px 0; border-bottom:8px solid var(--p); padding-bottom:15px">PROTOK√ì≈Å ODBIORU TECHNICZNEGO</h1>
            <div class="meta-grid">
                <div class="f-group"><label>Inwestycja:</label><input value="${state.meta.inv}" oninput="state.meta.inv=this.value; render()"></div>
                <div class="f-group"><label>Adres:</label><input value="${state.meta.adr}" oninput="state.meta.adr=this.value"></div>
                <div class="f-group"><label>Klient:</label><input value="${state.meta.cli}" oninput="state.meta.cli=this.value"></div>
                <div class="f-group"><label>Data:</label><input type="date" value="${state.meta.date}" oninput="state.meta.date=this.value"></div>
            </div>
            <div style="flex:1; margin-top:25px; border:1px solid #ddd; display:flex; align-items:center; justify-content:center; overflow:hidden; border-radius:10px" onclick="upMeta('main')">
                ${state.meta.main ? `<img src="${state.meta.main}" style="width:100%; height:100%; object-fit:cover">` : 'ZDJƒòCIE INWESTYCJI'}
            </div>
        `;
        root.appendChild(p1);

        state.floors.forEach((f, fi) => {
            const pf = document.createElement('div'); pf.className = 'page';
            pf.innerHTML = `
                <div class="plan-header"><span>RZUT: ${f.name}</span><span>POZIOM ${fi+1}</span></div>
                <div class="no-print" style="margin-bottom:15px; background:#222; padding:12px; border-radius:8px; display:flex; gap:10px">
                    <input value="${f.name}" oninput="state.floors[${fi}].name=this.value" style="width:180px">
                    <button class="btn ${f.locked?'btn-p':'btn-s'}" onclick="state.floors[${fi}].locked=!state.floors[${fi}].locked; render()">${f.locked?'üîí ZABLOKOWANY (KROPKUJ)':'üîì ODBLOKUJ'}</button>
                    <button class="btn btn-red" onclick="state.floors.splice(${fi},1); render()">USU≈É</button>
                </div>
                <div class="plan-wrap" onclick="clickPlan(event, ${fi})">
                    <img src="${f.img}" class="plan-img">
                    ${f.defects.map((d, di) => `<div class="dot" style="left:${d.x}%; top:${d.y}%" onclick="event.stopPropagation(); openEdit(${fi},${di})">${d.id}</div>`).join('')}
                </div>
            `;
            root.appendChild(pf);

            for(let i=0; i<f.defects.length; i+=2) {
                const pr = document.createElement('div'); pr.className = 'page';
                let h = `<div class="plan-header">WYKAZ USTEREK - ${f.name}</div>`;
                for(let j=0; j<2; j++) {
                    const d = f.defects[i+j]; if(!d) break;
                    h += `<div class="defect-row">
                        <div class="info-col">
                            <div class="point-tag">PUNKT ${d.id}</div>
                            <h2 style="margin:5px 0; font-size:22px">${d.room.toUpperCase()}</h2>
                            <p style="font-size:16px; line-height:1.4; font-weight:600; margin:15px 0"><b>Opis:</b> ${d.desc}</p>
                            <p style="font-size:12px; color:#555"><b>Norma:</b> ${d.norm || '-'}</p>
                        </div>
                        <div class="img-col">${d.img?`<img src="${d.img}">`:'BRAK ZDJƒòCIA'}</div>
                    </div>`;
                }
                pr.innerHTML = h; root.appendChild(pr);
            }
        });
    }

    async function upMeta(k) {
        const i = document.createElement('input'); i.type='file';
        i.onchange=async e=>{ state.meta[k]=await toB64(e.target.files[0]); render(); };
        i.click();
    }

    function saveJSON() {
        const b = new Blob([JSON.stringify(state)],{type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(b);
        a.download=`${state.meta.inv || 'raport'}.json`; a.click();
    }

    function importJSON(e) {
        const r = new FileReader();
        r.onload = ev => { 
            state = JSON.parse(ev.target.result); 
            let m=0; state.floors.forEach(f=>f.defects.forEach(d=>{if(d.id>m)m=d.id}));
            gCounter=m+1; render(); 
        };
        r.readAsText(e.target.files[0]);
    }

    function openTemplateEditor() {
        const m = document.getElementById('modal');
        m.innerHTML = `<h3>EDYCJA BAZY WIEDZY (JSON)</h3><textarea id="t-edit" style="width:100%; height:400px; font-family:monospace">${JSON.stringify(state.config, null, 2)}</textarea>
        <button class="btn btn-p" onclick="saveTemplate()" style="width:100%; margin-top:15px">ZAPISZ I OD≈öWIE≈ª</button>`;
        document.getElementById('ov').style.display='block'; m.style.display='block';
    }
    function saveTemplate() { state.config = JSON.parse(document.getElementById('t-edit').value); saveAndClose(); }
</script>
</body>
</html>